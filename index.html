<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zakhir McKinnon — Junior Software Developer</title>

<!-- Open Graph / Social sharing -->
<meta property="og:type" content="website">
<meta property="og:title" content="Zakhir McKinnon — Junior Software Developer (RPG Edition)">
<meta property="og:description" content="An interactive pixel-art RPG portfolio. Explore 8 zones: live ML algorithms, a custom 2D game engine, SQL EXPLAIN visualiser, SRE incident simulator, and more. Built as a single HTML file.">
<meta property="og:image" content="https://opengraph.b-cdn.net/production/images/placeholder.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Zakhir McKinnon — RPG Portfolio">
<meta name="twitter:description" content="Explore my skills through an interactive pixel-art RPG. 8 zones · live algorithms · SRE simulator · built in a single HTML file.">
<meta name="description" content="Zakhir McKinnon — Junior Software Developer. CPUT 2025. 5 months enterprise WIL at COGENT. TypeScript, Java, Python, C#, SQL. Cape Town, South Africa.">
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323:wght@400&family=Inter:wght@300;400;500;600;700&display=swap');
:root{
  --bg:#0d0d1a;--yellow:#f5c518;--green:#3ddc84;--blue:#4fc3f7;
  --red:#f44336;--purple:#ce93d8;--orange:#ffb74d;--white:#e8e0d5;--dim:#5a5068;
  --nb:#0a0f1a;--nt:#e2e8f0;--na:#64748b;--nc:#38bdf8;--ng:#4ade80;
}
*{margin:0;padding:0;box-sizing:border-box;image-rendering:pixelated;}
body{background:var(--bg);font-family:'Press Start 2P',monospace;color:var(--white);overflow:hidden;height:100vh;width:100vw;}
body::after{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.06) 2px,rgba(0,0,0,0.06) 4px);pointer-events:none;z-index:9998;}
#world{display:block;position:absolute;top:0;left:0;}

/* ── HUD ── */
#hud{position:fixed;top:0;left:0;right:0;height:40px;background:rgba(10,8,20,0.97);border-bottom:3px solid var(--yellow);display:flex;align-items:center;justify-content:space-between;padding:0 14px;z-index:300;}
#hud-name{font-size:10px;color:var(--yellow);text-shadow:2px 2px 0 #7a5c00;}
#hud-zone{font-size:8px;color:var(--green);}
#hud-right{display:flex;align-items:center;gap:10px;}
#hud-ctrl{font-family:'VT323',monospace;font-size:14px;color:var(--dim);}
#mode-toggle{font-family:'Press Start 2P',monospace;font-size:7px;background:#0a0818;border:2px solid var(--yellow);color:var(--yellow);padding:5px 9px;cursor:pointer;letter-spacing:1px;white-space:nowrap;}
#mode-toggle:hover{background:var(--yellow);color:#050510;}

/* ── TELEMETRY LOG ── */
#telelog{position:fixed;bottom:14px;left:14px;width:320px;height:80px;background:rgba(5,5,16,0.88);border:1px solid #1a1030;font-family:'VT323',monospace;font-size:11px;color:#3ddc84;overflow:hidden;z-index:200;pointer-events:none;}
#telelog-inner{padding:4px 7px;white-space:pre;}
.tl-info{color:#3ddc84;}.tl-warn{color:#ffb74d;}.tl-err{color:#f44336;}

/* ── MINIMAP ── */
#minimap-wrap{position:fixed;bottom:14px;right:14px;border:3px solid var(--yellow);box-shadow:3px 3px 0 #7a5c00;z-index:200;background:#080814;}
#minimap{display:block;}
#mm-label{font-size:6px;color:var(--yellow);text-align:center;padding:3px 0;background:#080814;border-top:2px solid var(--yellow);letter-spacing:1px;}

/* ── DIALOG ── */
#dialog{position:fixed;bottom:60px;left:50%;transform:translateX(-50%);width:min(540px,90vw);background:rgba(10,8,20,0.95);border:3px solid var(--yellow);box-shadow:4px 4px 0 #7a5c00;padding:12px 16px;z-index:201;display:none;}
#dialog.show{display:block;}
#dlg-txt{font-family:'VT323',monospace;font-size:17px;color:var(--white);line-height:1.4;white-space:pre-line;}
#dlg-prm{font-size:7px;color:var(--yellow);margin-top:8px;text-align:right;animation:blink .7s step-end infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}

/* ── INTRO ── */
#intro{position:fixed;inset:0;background:#050510;z-index:500;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px;}
#intro.out{animation:fo .4s steps(8) both;}
@keyframes fo{to{opacity:0;pointer-events:none}}
.ibox{border:3px solid var(--yellow);box-shadow:4px 4px 0 #7a5c00;padding:28px 36px;background:#0a0818;text-align:center;max-width:520px;width:90%;}
.ibox h1{font-size:clamp(10px,2.8vw,16px);color:var(--yellow);text-shadow:3px 3px 0 #7a5c00;margin-bottom:8px;}
.ibox h2{font-family:'VT323',monospace;font-size:clamp(14px,3.5vw,20px);color:var(--green);margin-bottom:10px;letter-spacing:2px;}
.ibox p{font-family:'VT323',monospace;font-size:15px;color:var(--dim);line-height:1.6;margin-bottom:14px;}
.pbtn{font-family:'Press Start 2P',monospace;font-size:9px;background:#0a0818;border:3px solid var(--green);box-shadow:3px 3px 0 #0a3a1a;color:var(--green);padding:11px 26px;cursor:pointer;letter-spacing:2px;}
.pbtn:hover{background:var(--green);color:#050510;box-shadow:none;transform:translate(3px,3px);}
.ibox-meta{font-family:'VT323',monospace;font-size:12px;color:#2a2038;margin-top:12px;line-height:1.5;}

/* ── HOW TO PLAY OVERLAY ── */
#htp{position:fixed;inset:0;background:rgba(5,5,16,0.92);z-index:550;display:flex;align-items:center;justify-content:center;transition:opacity .6s;}
#htp.out{opacity:0;pointer-events:none;}
#htp-box{border:3px solid var(--green);box-shadow:4px 4px 0 #0a3a1a;padding:28px 34px;background:#050d08;max-width:480px;width:90%;text-align:center;}
#htp-box h3{font-size:9px;color:var(--green);margin-bottom:18px;letter-spacing:2px;text-shadow:0 0 12px var(--green);}
.htp-row{display:flex;align-items:flex-start;gap:14px;margin-bottom:12px;text-align:left;}
.htp-key{font-family:'Press Start 2P',monospace;font-size:7px;background:#0a1a0a;border:2px solid var(--green);color:var(--green);padding:5px 8px;min-width:80px;text-align:center;flex-shrink:0;}
.htp-desc{font-family:'VT323',monospace;font-size:16px;color:var(--white);line-height:1.4;}
#htp-skip{font-family:'Press Start 2P',monospace;font-size:6px;color:var(--dim);margin-top:18px;animation:blink .9s step-end infinite;}

/* ── START HERE arrow ── */
#start-arrow{position:fixed;z-index:310;pointer-events:none;display:none;transition:opacity .8s;}
#start-arrow.show{display:block;}
#start-arrow.fade{opacity:0;}
.sa-label{font-family:'Press Start 2P',monospace;font-size:7px;color:#4fc3f7;text-shadow:0 0 10px #4fc3f7;animation:pulse .8s ease-in-out infinite;background:rgba(5,5,20,0.85);border:2px solid #4fc3f7;padding:5px 9px;white-space:nowrap;}
.sa-arrow{color:#4fc3f7;font-size:22px;animation:bounce .7s ease-in-out infinite;display:block;text-align:center;text-shadow:0 0 8px #4fc3f7;}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(6px)}}

/* ── ACHIEVEMENT TOAST ── */
#ach-wrap{position:fixed;bottom:110px;right:16px;z-index:500;display:flex;flex-direction:column;gap:8px;pointer-events:none;}
.ach-toast{background:#050d08;border:2px solid var(--yellow);box-shadow:3px 3px 0 #7a5c00;padding:10px 14px;display:flex;align-items:center;gap:10px;animation:ach-in .3s steps(6) both;}
.ach-toast.out{animation:ach-out .4s steps(6) forwards;}
@keyframes ach-in{from{transform:translateX(120%);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes ach-out{to{transform:translateX(120%);opacity:0}}
.ach-icon{font-size:22px;}
.ach-text{font-family:'Press Start 2P',monospace;font-size:5px;color:var(--yellow);line-height:1.8;}
.ach-title{font-size:7px;color:var(--green);display:block;margin-bottom:3px;}

/* ── HIRE BADGE in normal mode ── */
.nm-hire-badge{display:inline-flex;align-items:center;gap:7px;background:#061a06;border:2px solid var(--green);box-shadow:2px 2px 0 #0a3a1a;padding:7px 14px;margin-top:12px;font-family:'Press Start 2P',monospace;font-size:6px;color:var(--green);letter-spacing:1px;}
.nm-hire-dot{width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulse .9s ease-in-out infinite;box-shadow:0 0 6px var(--green);}

/* ── MODAL ACCESSIBILITY ── */
#modal[role=dialog]{outline:none;}


#modal{position:fixed;inset:0;background:rgba(5,5,16,0.94);z-index:400;display:none;align-items:center;justify-content:center;}
#modal.open{display:flex;}
#modal-panel{width:min(760px,97vw);max-height:90vh;background:#0a0818;border:3px solid;box-shadow:6px 6px 0;display:flex;flex-direction:column;overflow:hidden;}
#modal-hdr{padding:11px 16px;border-bottom:3px solid;display:flex;justify-content:space-between;align-items:center;background:#080614;flex-shrink:0;}
#modal-title{font-size:9px;letter-spacing:1px;}
.cbtn{font-family:'Press Start 2P',monospace;font-size:7px;background:transparent;border:2px solid var(--red);color:var(--red);padding:5px 10px;cursor:pointer;}
.cbtn:hover{background:var(--red);color:#050510;}
#modal-body{flex:1;overflow-y:auto;padding:14px;scrollbar-width:thin;scrollbar-color:var(--dim) transparent;}

/* ── PIXEL FLIP TRANSITION ── */
#flip-canvas{position:fixed;inset:0;z-index:600;pointer-events:none;display:none;}

/* ── NORMAL MODE ── */
#normal-mode{position:fixed;inset:0;background:#0a0f1a;z-index:250;display:none;overflow-y:auto;font-family:'Inter',sans-serif;color:var(--nt);}
#normal-mode.active{display:block;}
.nm-wrap{max-width:900px;margin:0 auto;padding:60px 32px;}
.nm-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:56px;flex-wrap:wrap;gap:20px;}
.nm-name{font-size:clamp(28px,5vw,48px);font-weight:700;color:var(--nt);letter-spacing:-1px;line-height:1.1;}
.nm-title{font-size:16px;color:var(--nc);font-weight:500;margin-top:6px;letter-spacing:.3px;}
.nm-location{font-size:13px;color:var(--na);margin-top:4px;}
.nm-links{display:flex;gap:10px;flex-wrap:wrap;margin-top:4px;}
.nm-link{font-size:12px;color:var(--na);text-decoration:none;border:1px solid #1e293b;padding:5px 12px;border-radius:4px;font-weight:500;}
.nm-link:hover{border-color:var(--nc);color:var(--nc);}
.nm-section{margin-bottom:48px;}
.nm-section-title{font-size:11px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--na);margin-bottom:20px;padding-bottom:10px;border-bottom:1px solid #1e293b;}
.nm-about{font-size:16px;line-height:1.8;color:var(--nt);opacity:.9;max-width:680px;}
.nm-skills-grid{display:flex;flex-wrap:wrap;gap:8px;}
.nm-skill{font-size:12px;background:#0f172a;border:1px solid #1e293b;color:var(--nt);padding:5px 12px;border-radius:3px;font-weight:500;}
.nm-skill.hi{border-color:#1e3a4a;color:var(--nc);}
.nm-exp-item{margin-bottom:28px;padding-left:20px;border-left:2px solid #1e293b;}
.nm-exp-item:last-child{margin-bottom:0;}
.nm-exp-role{font-size:15px;font-weight:600;color:var(--nt);}
.nm-exp-place{font-size:13px;color:var(--nc);margin-top:2px;}
.nm-exp-date{font-size:11px;color:var(--na);margin-top:2px;margin-bottom:8px;}
.nm-exp-desc{font-size:14px;color:var(--nt);opacity:.75;line-height:1.7;}
.nm-projects-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px;}
.nm-proj{background:#0f172a;border:1px solid #1e293b;padding:18px;cursor:pointer;}
.nm-proj:hover{border-color:#1e3a4a;}
.nm-proj-name{font-size:14px;font-weight:600;color:var(--nt);margin-bottom:6px;}
.nm-proj-tech{font-size:11px;color:var(--nc);margin-bottom:8px;}
.nm-proj-desc{font-size:13px;color:var(--na);line-height:1.6;}
.nm-proj-links{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap;}
.nm-proj-link{font-size:11px;font-weight:500;padding:4px 10px;border:1px solid;border-radius:3px;text-decoration:none;transition:background .15s,color .15s;}
.nm-proj-link.gh{color:#6e8caa;border-color:#1e293b;}
.nm-proj-link.gh:hover{background:#6e8caa;color:#0a0f1a;}
.nm-proj-link.live{color:#4ade80;border-color:#1a3a2a;}
.nm-proj-link.live:hover{background:#4ade80;color:#0a0f1a;}
.nm-proj-bullets{margin-top:8px;padding-left:0;list-style:none;}
.nm-proj-bullets li{font-size:12px;color:var(--na);line-height:1.7;padding-left:14px;position:relative;}
.nm-proj-bullets li::before{content:'▸';position:absolute;left:0;color:var(--nc);}
.nm-game-btn{display:inline-flex;align-items:center;gap:8px;margin-top:40px;font-family:'Inter',sans-serif;font-size:12px;font-weight:500;background:transparent;border:1px solid var(--nc);color:var(--nc);padding:10px 20px;cursor:pointer;}
.nm-game-btn:hover{background:var(--nc);color:#0a0f1a;}
.nm-contact{display:flex;gap:16px;flex-wrap:wrap;}
.nm-contact a{font-size:13px;color:var(--na);text-decoration:none;}
.nm-contact a:hover{color:var(--nc);}

/* ── SHARED COMPONENT STYLES ── */
.cmsg{font-family:'VT323',monospace;font-size:19px;line-height:1.5;padding:7px 9px;max-width:90%;}
.cmsg.bot{background:#0d1228;border-left:3px solid var(--blue);align-self:flex-start;}
.cmsg.usr{background:#1a0d28;border-right:3px solid var(--purple);align-self:flex-end;text-align:right;}
.cwho{font-family:'Press Start 2P',monospace;font-size:7px;margin-bottom:3px;opacity:.7;}
.cmsg.bot .cwho{color:var(--blue)}.cmsg.usr .cwho{color:var(--purple)}
#chat-msgs{height:260px;overflow-y:auto;padding:10px;background:#050510;border:2px solid #1a1030;margin-bottom:8px;display:flex;flex-direction:column;gap:7px;scrollbar-width:thin;scrollbar-color:var(--dim) transparent;}
.qgrid{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:8px;}
.qb{font-family:'Press Start 2P',monospace;font-size:7px;background:#0a0818;border:2px solid #2a1a4a;color:var(--blue);padding:5px 8px;cursor:pointer;}
.qb:hover{border-color:var(--blue);}
.crow{display:flex;gap:7px;}
.cinp{flex:1;background:#050510;border:2px solid #2a1a4a;color:var(--white);font-family:'VT323',monospace;font-size:18px;padding:7px 9px;outline:none;}
.cinp:focus{border-color:var(--blue);}
.csnd{font-family:'Press Start 2P',monospace;font-size:7px;background:var(--blue);border:none;color:#050510;padding:7px 12px;cursor:pointer;}
.csnd:hover{background:var(--green);}
.mem-bar-bg{height:3px;background:#1a1030;margin-top:4px;border-radius:1px;}
.mem-bar-fill{height:100%;transition:width .3s,background .3s;border-radius:1px;}

.ml-tabs{display:flex;gap:0;margin-bottom:10px;border-bottom:2px solid #2a1a4a;}
.ml-tab{font-family:'Press Start 2P',monospace;font-size:7px;background:#080614;border:2px solid #2a1a4a;border-bottom:none;color:var(--dim);padding:7px 10px;cursor:pointer;margin-right:2px;position:relative;bottom:-2px;}
.ml-tab.on{color:var(--green);border-color:var(--green);background:#050510;}
#ml-c{display:block;background:#050510;border:2px solid #1a1030;width:100%;height:240px;cursor:crosshair;}
.minfo{margin-top:7px;padding:9px 11px;background:#050510;border-left:3px solid var(--green);font-family:'VT323',monospace;font-size:16px;line-height:1.5;}
.mbtns{display:flex;gap:5px;margin-top:7px;flex-wrap:wrap;align-items:center;}
.mb{font-family:'Press Start 2P',monospace;font-size:7px;background:#080614;border:2px solid var(--green);color:var(--green);padding:5px 9px;cursor:pointer;}
.mb:hover{background:var(--green);color:#050510;}
.mb.active{background:var(--green);color:#050510;}
#ml-eq{font-family:'VT323',monospace;font-size:13px;color:var(--green);padding:0 6px;}
.ml-metrics{display:flex;gap:8px;margin-top:5px;flex-wrap:wrap;}
.ml-metric{font-family:'VT323',monospace;font-size:15px;padding:3px 8px;border:1px solid;border-radius:2px;}

.sqb{background:#050510;border:2px solid #1a1030;border-left:3px solid var(--orange);padding:9px 11px;margin-bottom:3px;font-family:'VT323',monospace;font-size:15px;color:#7dd3fc;white-space:pre-wrap;line-height:1.5;cursor:pointer;}
.sqb:hover{border-left-color:var(--green);background:#07090f;}
.sqb .slb{font-family:'Press Start 2P',monospace;font-size:8px;color:var(--orange);display:block;margin-bottom:5px;}
.sqr{display:none;padding:9px 11px;background:#030812;border:2px solid #0d2040;border-top:none;margin-bottom:5px;}
.sqr.show{display:block;}
.sqr table{width:100%;border-collapse:collapse;}
.sqr th{font-family:'Press Start 2P',monospace;font-size:7px;color:var(--orange);padding:3px 6px;text-align:left;border-bottom:2px solid #1a2040;}
.sqr td{font-family:'VT323',monospace;font-size:15px;color:var(--green);padding:2px 6px;border-bottom:1px solid #0a1428;}
.snote{font-family:'VT323',monospace;font-size:14px;color:var(--dim);margin-top:4px;}
.explain-row{display:flex;align-items:center;gap:8px;padding:3px 0;font-family:'VT323',monospace;font-size:15px;border-bottom:1px solid #0d1428;}
.explain-op{color:#ce93d8;min-width:120px;}
.explain-cost{min-width:100px;}
.explain-note{color:var(--dim);font-size:11px;}
.explain-bar{height:4px;border-radius:1px;min-width:2px;}
.idx-row{display:flex;align-items:center;gap:10px;padding:5px 0;border-bottom:1px solid #0d1428;font-family:'VT323',monospace;font-size:13px;}
.idx-toggle{width:34px;height:16px;border:2px solid;cursor:pointer;position:relative;flex-shrink:0;}
.idx-toggle.on{border-color:#3ddc84;}
.idx-toggle.off{border-color:#f44336;}
.idx-toggle::after{content:'';position:absolute;top:1px;width:8px;height:8px;transition:left .2s;}
.idx-toggle.on::after{left:20px;background:#3ddc84;}
.idx-toggle.off::after{left:1px;background:#f44336;}

#ge-c{display:block;background:#020811;border:2px solid #1a1030;width:100%;height:230px;cursor:crosshair;}
.gbtns{display:flex;gap:5px;margin-top:6px;flex-wrap:wrap;}
.gb{font-family:'Press Start 2P',monospace;font-size:7px;background:#080614;border:2px solid var(--purple);color:var(--purple);padding:5px 9px;cursor:pointer;}
.gb:hover{background:var(--purple);color:#050510;}
.ecs-panel{background:#030812;border:2px solid #1a1030;padding:8px 10px;margin-top:6px;font-family:'VT323',monospace;font-size:14px;color:var(--dim);line-height:1.6;white-space:pre;}

.pipe-stage{display:flex;align-items:center;gap:0;margin-bottom:10px;flex-wrap:wrap;}
.pstage{font-family:'Press Start 2P',monospace;font-size:8px;padding:7px 10px;border:2px solid;letter-spacing:1px;}
.pstage.done{background:rgba(61,220,132,.15);border-color:#3ddc84;color:#3ddc84;}
.pstage.running{background:rgba(245,197,24,.15);border-color:#f5c518;color:#f5c518;animation:pulse .6s ease-in-out infinite;}
.pstage.fail{background:rgba(244,67,54,.15);border-color:#f44336;color:#f44336;}
.pstage.idle{background:#050510;border-color:#2a1a4a;color:var(--dim);}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.parr{font-family:'VT323',monospace;font-size:20px;color:var(--dim);padding:0 3px;align-self:center;}
.pipe-log{font-family:'VT323',monospace;font-size:15px;color:var(--green);background:#030812;border:2px solid #0d2040;padding:7px 10px;height:74px;overflow-y:auto;white-space:pre;scrollbar-width:thin;scrollbar-color:var(--dim) transparent;}

/* ── PIPELINE BUILDER (Level 3) ── */
.dv-tabs{display:flex;gap:0;margin-bottom:10px;border-bottom:2px solid #2a1030;}
.dv-tab{font-family:'Press Start 2P',monospace;font-size:7px;background:#0a0510;border:2px solid #2a1030;border-bottom:none;color:var(--dim);padding:6px 10px;cursor:pointer;margin-right:2px;position:relative;bottom:-2px;letter-spacing:1px;}
.dv-tab.on{color:#f44336;border-color:#f44336;background:#0f0208;}
.pb-layout{display:grid;grid-template-columns:140px 1fr;gap:8px;min-height:300px;}
.pb-palette{background:#03080f;border:2px solid #1a1030;padding:7px;display:flex;flex-direction:column;gap:5px;}
.pb-palette-hdr{font-family:'Press Start 2P',monospace;font-size:7px;color:var(--dim);margin-bottom:4px;letter-spacing:1px;border-bottom:1px solid #1a1030;padding-bottom:4px;}
.pb-chip{font-family:'Press Start 2P',monospace;font-size:7px;padding:6px 7px;border:2px solid;cursor:grab;user-select:none;line-height:1.6;transition:filter .1s;position:relative;}
.pb-chip:hover{filter:brightness(1.3);}
.pb-chip:active{cursor:grabbing;}
.pb-chip.dragging{opacity:.4;}
.pb-canvas-wrap{background:#030812;border:2px solid #1a1030;padding:8px;display:flex;flex-direction:column;gap:8px;}
.pb-canvas-hdr{font-family:'Press Start 2P',monospace;font-size:7px;color:var(--dim);letter-spacing:1px;}
.pb-lane{display:flex;align-items:center;gap:4px;min-height:54px;background:#020610;border:2px dashed #1a1030;padding:6px;flex-wrap:wrap;transition:border-color .15s;}
.pb-lane.drag-over{border-color:#f44336;background:#0f0208;}
.pb-slot{font-family:'Press Start 2P',monospace;font-size:7px;padding:7px 6px;border:2px solid;min-width:64px;text-align:center;cursor:pointer;position:relative;line-height:1.7;}
.pb-slot:hover::after{content:'✕';position:absolute;top:-1px;right:2px;font-size:8px;color:#f44336;}
.pb-slot.st-idle{border-style:dashed;}
.pb-slot.st-running{animation:pulse .5s ease-in-out infinite;}
.pb-slot.st-done{background:rgba(61,220,132,.12);}
.pb-slot.st-fail{background:rgba(244,67,54,.12);}
.pb-slot.st-warn{background:rgba(255,183,77,.12);}
.pb-arr{color:var(--dim);font-size:16px;flex-shrink:0;font-family:'VT323',monospace;}
.pb-drop-hint{font-family:'VT323',monospace;font-size:16px;color:var(--dim);padding:10px;text-align:center;pointer-events:none;}
.pb-log{font-family:'VT323',monospace;font-size:15px;color:#3ddc84;background:#020610;border:2px solid #0d1428;padding:7px 10px;height:100px;overflow-y:auto;white-space:pre;scrollbar-width:thin;scrollbar-color:var(--dim) transparent;flex-shrink:0;}
.pb-warn{color:#ffb74d;}.pb-err{color:#f44336;}.pb-ok{color:#3ddc84;}.pb-info{color:#4fc3f7;}
.pb-score{background:#030812;border:2px solid #1a1030;padding:10px 12px;margin-top:8px;display:none;}
.pb-score.show{display:block;}
.pb-score-hdr{font-family:'Press Start 2P',monospace;font-size:7px;color:#f5c518;margin-bottom:8px;letter-spacing:1px;}
.pb-score-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:8px;}
.pb-score-item{font-family:'VT323',monospace;font-size:15px;line-height:1.5;}
.pb-badge{font-family:'Press Start 2P',monospace;font-size:8px;display:inline-block;padding:5px 10px;border:2px solid;letter-spacing:1px;margin-top:4px;}
.pb-tooltip{position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:#0a0818;border:1px solid #2a1a4a;font-family:'VT323',monospace;font-size:11px;color:var(--white);padding:5px 8px;z-index:10;pointer-events:none;display:none;line-height:1.5;text-align:left;min-width:180px;max-width:240px;white-space:normal;}
.pb-chip:hover .pb-tooltip,.pb-slot:hover .pb-tooltip{display:block;}
.srv-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px;margin-top:8px;}
.srv-box{background:#050510;border:2px solid;padding:9px 7px;text-align:center;cursor:pointer;transition:filter .15s;}
.srv-box:hover{filter:brightness(1.3);}
.srv-name{font-family:'Press Start 2P',monospace;font-size:7px;margin-bottom:5px;}
.srv-status{font-family:'VT323',monospace;font-size:16px;}
.srv-bar-bg{height:3px;margin-top:5px;background:#1a1030;}
.srv-bar-fill{height:100%;transition:width .4s;}
.slo-row{display:flex;gap:12px;margin-top:8px;flex-wrap:wrap;}
.slo-box{flex:1;min-width:100px;background:#050510;border:2px solid #1a1030;padding:8px 10px;font-family:'VT323',monospace;}
.slo-label{font-family:'Press Start 2P',monospace;font-size:7px;color:var(--dim);margin-bottom:4px;}
.slo-val{font-size:18px;}

.arch-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:0;}
.arch-card{background:#050510;border:2px solid;padding:11px;cursor:pointer;margin-bottom:6px;}
.arch-card:hover{filter:brightness(1.25);}
.arch-card-title{font-family:'Press Start 2P',monospace;font-size:7px;margin-bottom:7px;letter-spacing:1px;}
.arch-card-sub{font-family:'VT323',monospace;font-size:15px;color:var(--dim);line-height:1.4;}
.arch-detail{display:none;padding:11px;background:#030812;border:2px solid #1a1030;margin-bottom:6px;}
.arch-detail.show{display:block;}
.arch-pros-cons{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:7px;}
.arch-col{padding:7px;font-family:'VT323',monospace;font-size:15px;line-height:1.5;}
.arch-col h4{font-family:'Press Start 2P',monospace;font-size:8px;margin-bottom:5px;}

.tl-wrap{position:relative;padding-left:28px;}
.tl-line{position:absolute;left:11px;top:0;bottom:0;width:2px;background:#2a1a4a;}
.tl-entry{position:relative;margin-bottom:14px;cursor:pointer;}
.tl-dot{position:absolute;left:-22px;top:3px;width:13px;height:13px;border:2px solid;background:#0a0818;display:flex;align-items:center;justify-content:center;font-size:6px;}
.tl-year{font-family:'Press Start 2P',monospace;font-size:7px;margin-bottom:3px;}
.tl-title{font-family:'VT323',monospace;font-size:17px;line-height:1.3;}
.tl-detail{display:none;padding:7px 9px;background:#050510;border-left:2px solid;margin-top:5px;font-family:'VT323',monospace;font-size:15px;line-height:1.5;color:var(--dim);}
.tl-detail.show{display:block;}
.tl-tag{display:inline-block;font-family:'Press Start 2P',monospace;font-size:7px;padding:2px 4px;border:1px solid;margin:2px;}

.prob-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:11px;}
.prob-btn{background:#050510;border:2px solid var(--red);color:var(--red);font-family:'Press Start 2P',monospace;font-size:8px;padding:9px 7px;cursor:pointer;text-align:center;line-height:1.5;}
.prob-btn:hover{background:rgba(244,67,54,.1);}
.prob-answer{display:none;padding:11px;background:#030812;border:2px solid #1a1030;}
.prob-answer.show{display:block;}
.prob-section{margin-bottom:9px;}
.prob-section h3{font-family:'Press Start 2P',monospace;font-size:8px;margin-bottom:5px;letter-spacing:1px;}
.prob-section p{font-family:'VT323',monospace;font-size:16px;line-height:1.6;color:var(--white);}
.tradeoff-row{display:flex;gap:7px;margin-top:7px;flex-wrap:wrap;}
.tradeoff-item{flex:1;min-width:110px;background:#050510;border-left:2px solid;padding:6px 8px;font-family:'VT323',monospace;font-size:15px;line-height:1.4;}

/* ── ARCH MUSEUM TABS ── */
.arch-tabs{display:flex;gap:0;margin-bottom:12px;border-bottom:2px solid #1a2a4a;}
.arch-tab{font-family:'Press Start 2P',monospace;font-size:7px;background:#050d1a;border:2px solid #1a2a4a;border-bottom:none;color:var(--dim);padding:7px 10px;cursor:pointer;margin-right:2px;position:relative;bottom:-2px;letter-spacing:1px;}
.arch-tab.on{color:#90caf9;border-color:#90caf9;background:#050d1a;}
/* ── PROJECT VAULT CARDS ── */
.pv-card{background:#050d1a;border:2px solid #1a2a4a;padding:12px 14px;margin-bottom:10px;transition:border-color .15s;}
.pv-card:hover{border-color:#90caf9;}
.pv-card-hdr{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;margin-bottom:7px;flex-wrap:wrap;}
.pv-card-name{font-family:'Press Start 2P',monospace;font-size:7px;color:#90caf9;letter-spacing:1px;line-height:1.6;}
.pv-card-links{display:flex;gap:6px;flex-shrink:0;flex-wrap:wrap;}
.pv-link{font-family:'VT323',monospace;font-size:14px;padding:3px 9px;border:2px solid;text-decoration:none;transition:background .12s,color .12s;}
.pv-link.gh{color:#6e8caa;border-color:#1e3a5a;}
.pv-link.gh:hover{background:#6e8caa;color:#050d1a;}
.pv-link.live{color:#4ade80;border-color:#1a3a2a;}
.pv-link.live:hover{background:#4ade80;color:#050d1a;}
.pv-card-tech{font-family:'VT323',monospace;font-size:14px;color:#4fc3f7;margin-bottom:6px;}
.pv-card-desc{font-family:'VT323',monospace;font-size:15px;color:var(--dim);line-height:1.6;margin-bottom:7px;}
.pv-bullets{list-style:none;padding:0;margin:0;}
.pv-bullets li{font-family:'VT323',monospace;font-size:14px;color:var(--white);line-height:1.6;padding-left:14px;position:relative;opacity:.85;}
.pv-bullets li::before{content:'▸';position:absolute;left:0;color:#90caf9;}
/* ── LAYERED ARCH ANIMATOR ── */
.la-layer{display:flex;align-items:center;gap:10px;margin-bottom:6px;position:relative;}
.la-box{font-family:'Press Start 2P',monospace;font-size:6px;padding:9px 12px;border:2px solid;min-width:130px;text-align:center;letter-spacing:1px;position:relative;transition:background .2s,box-shadow .2s;}
.la-box.active{box-shadow:0 0 14px;}
.la-label{font-family:'VT323',monospace;font-size:14px;color:var(--dim);flex:1;}
.la-arrow{font-family:'VT323',monospace;font-size:22px;color:var(--dim);text-align:center;margin:2px 0;padding-left:65px;}
.la-packet{position:absolute;left:130px;width:10px;height:10px;border-radius:50%;display:none;z-index:2;}
#la-log{font-family:'VT323',monospace;font-size:14px;color:#3ddc84;background:#020610;border:2px solid #0d1428;padding:8px 10px;height:90px;overflow-y:auto;white-space:pre;scrollbar-width:thin;margin-top:8px;}

#theme-picker{margin-top:18px;border-top:1px solid #1a1a2e;padding-top:14px;}
#theme-picker-hdr{font-family:'Press Start 2P',monospace;font-size:7px;color:var(--dim);letter-spacing:1px;margin-bottom:10px;text-align:center;}
#theme-swatches{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;}
.th-swatch{width:54px;height:54px;border:3px solid transparent;cursor:pointer;position:relative;transition:transform .1s;flex-shrink:0;}
.th-swatch:hover{transform:scale(1.12);}
.th-swatch.active{border-color:#fff;box-shadow:0 0 0 1px #fff;}
.th-swatch canvas{display:block;width:100%;height:100%;image-rendering:pixelated;}
.th-swatch-label{font-family:'Press Start 2P',monospace;font-size:4px;text-align:center;margin-top:3px;letter-spacing:0px;line-height:1.5;}
</style>
</head>
<body>

<!-- ── INTRO ── -->
<div id="intro">
  <div class="ibox">
    <canvas id="isp" width="64" height="64" style="width:112px;height:112px;display:block;margin:0 auto 14px;"></canvas>
    <h1>ZAKHIR MCKINNON</h1>
    <h2>Junior Software Developer</h2>
    <p style="font-family:'VT323',monospace;font-size:13px;color:#2a3a2a;text-align:left;margin-bottom:10px;line-height:1.6;">Runtime: Browser JS · RAF loop · 60fps target<br>Architecture: Event-driven UI over tile engine core<br>State: Module singletons — no framework by design<br>AI: Streaming Claude API · zone-aware context injection<br>Zones: 8 · Stations: 9 · NPCs: 4 · Single .html file</p>
    <p style="font-family:'VT323',monospace;font-size:13px;color:var(--dim);text-align:left;border-left:2px solid var(--yellow);padding-left:8px;line-height:1.6;margin-bottom:14px;">Zero build step chosen deliberately. No bundler, no framework, instant load, maximum portability. The architecture reflects the constraint — not every system needs a scaffold.</p>
    <button class="pbtn" onclick="startWorld()">▶ PRESS START</button>
    <p style="font-size:9px;margin-top:10px;color:var(--dim);">WASD:MOVE · E:INTERACT · ESC:CLOSE · Toggle top-right for normal mode</p>
    <div id="theme-picker">
      <div id="theme-picker-hdr">◈ VISUAL STYLE — pick one</div>
      <div id="theme-swatches"></div>
    </div>
  </div>
</div>

<!-- ── HUD ── -->
<div id="hud">
  <div id="hud-name">★ ZKM.EXE</div>
  <div id="hud-zone">◆ TOWN SQUARE</div>
  <div id="hud-sys" style="font-family:'VT323',monospace;font-size:13px;color:#3ddc84;display:flex;align-items:center;gap:6px;">
    <span style="font-family:'Press Start 2P',monospace;font-size:6px;color:var(--dim)">SYS</span>
    <div style="width:60px;height:6px;background:#1a1030;border:1px solid #2a1a4a;overflow:hidden;">
      <div id="sys-bar" style="height:100%;width:100%;background:#3ddc84;transition:width .5s,background .5s;"></div>
    </div>
    <span id="sys-pct" style="font-size:12px;">100%</span>
  </div>
  <div id="hud-right">
    <div id="hud-ctrl">WASD:MOVE · E:TALK · ESC:BACK</div>
    <button id="mode-toggle" onclick="toggleMode()">⬡ NORMAL MODE</button>
  </div>
</div>

<canvas id="world"></canvas>
<canvas id="flip-canvas"></canvas>

<!-- ── MINIMAP ── -->
<div id="minimap-wrap">
  <canvas id="minimap" width="160" height="120"></canvas>
  <div id="mm-label">MAP</div>
</div>

<!-- ── TELEMETRY LOG ── -->
<div id="telelog"><div id="telelog-inner"></div></div>

<!-- ── DIALOG ── -->
<div id="dialog">
  <div id="dlg-txt">...</div>
  <div id="dlg-prm">▼ PRESS E TO ENTER</div>
</div>

<!-- ── HOW TO PLAY OVERLAY ── -->
<div id="htp" role="dialog" aria-modal="true" aria-label="How to play">
  <div id="htp-box">
    <h3>▶ HOW TO PLAY</h3>
    <div class="htp-row">
      <span class="htp-key">WASD / ↑↓←→</span>
      <span class="htp-desc">Move your character around the world</span>
    </div>
    <div class="htp-row">
      <span class="htp-key">E</span>
      <span class="htp-desc">Interact with stations &amp; talk to NPCs</span>
    </div>
    <div class="htp-row">
      <span class="htp-key">ESC</span>
      <span class="htp-desc">Close any open window</span>
    </div>
    <div class="htp-row">
      <span class="htp-key">⬡ TOP RIGHT</span>
      <span class="htp-desc">Switch to Normal CV mode (no game)</span>
    </div>
    <div style="font-family:'VT323',monospace;font-size:15px;color:var(--green);margin-top:14px;border:1px solid #1a3a1a;padding:8px;">You are in TOWN SQUARE. Explore all 8 zones!</div>
    <div id="htp-skip">Press any key or move to start →</div>
  </div>
</div>

<!-- ── START HERE ARROW ── -->
<div id="start-arrow">
  <div class="sa-label">START HERE</div>
  <div class="sa-arrow">▼</div>
</div>

<!-- ── ACHIEVEMENTS ── -->
<div id="ach-wrap" aria-live="polite" aria-label="Achievements"></div>

<!-- ── MODAL ── -->
<div id="modal" role="dialog" aria-modal="true" aria-label="Zone interface">
  <div id="modal-panel">
    <div id="modal-hdr">
      <div id="modal-title">ZONE</div>
      <button class="cbtn" onclick="closeModal()">✕ CLOSE</button>
    </div>
    <div id="modal-body"></div>
  </div>
</div>

<!-- ── NORMAL MODE PAGE ── -->
<div id="normal-mode">
  <div class="nm-wrap">
    <div class="nm-header">
      <div>
        <div class="nm-name">Zakhir McKinnon</div>
        <div class="nm-title">Junior Software Developer</div>
        <div class="nm-location">Johannesburg, South Africa · Open to Cape Town &amp; remote roles</div>
        <div class="nm-links" style="margin-top:10px;">
          <a class="nm-link" href="https://github.com/flyinginsectsunpig" target="_blank">GitHub</a>
          <a class="nm-link" href="https://www.linkedin.com/in/zakhir-mckinnon-ba20ab300/" target="_blank">LinkedIn</a>
        </div>
        <div class="nm-hire-badge"><span class="nm-hire-dot"></span>AVAILABLE FOR HIRE — IMMEDIATELY</div>
      </div>
      <button class="nm-game-btn" onclick="toggleMode()">⬡ Back to RPG Mode</button>
    </div>

    <div class="nm-section">
      <div class="nm-section-title">About</div>
      <p class="nm-about">CPUT Diploma in ICT Applications Development (2025). I build systems with intent — from a custom 2D game engine written against raw Canvas API, to full-stack 3D web platforms, to ML-augmented tools. Five months of enterprise WIL at COGENT working across Azure DevOps, C# ABP Framework, Blue Prism RPA, and AI automation. I think architecturally first, code second.</p>
    </div>

    <div class="nm-section">
      <div class="nm-section-title">Skills</div>
      <div class="nm-skills-grid">
        <span class="nm-skill hi">Java</span><span class="nm-skill hi">TypeScript</span><span class="nm-skill hi">JavaScript</span>
        <span class="nm-skill hi">C#</span><span class="nm-skill hi">Python</span><span class="nm-skill">PHP</span>
        <span class="nm-skill hi">SQL / Oracle</span><span class="nm-skill hi">React</span><span class="nm-skill hi">Spring Boot</span>
        <span class="nm-skill">Three.js</span><span class="nm-skill hi">Azure DevOps</span><span class="nm-skill">Blue Prism RPA</span>
        <span class="nm-skill">ABP Framework</span><span class="nm-skill hi">HTML5 Canvas API</span><span class="nm-skill">Machine Learning</span>
        <span class="nm-skill">scikit-learn · Keras</span><span class="nm-skill">Docker (concepts)</span><span class="nm-skill hi">Git</span>
        <span class="nm-skill">AZ-900 Certified</span><span class="nm-skill">Solidity / Ethereum</span>
      </div>
    </div>

    <div class="nm-section">
      <div class="nm-section-title">Experience</div>
      <div class="nm-exp-item">
        <div class="nm-exp-role">Software Developer Intern (WIL)</div>
        <div class="nm-exp-place">COGENT — Enterprise Technology</div>
        <div class="nm-exp-date">Aug 2025 – Dec 2025 · 5 months · Cape Town</div>
        <div class="nm-exp-desc">Rotated across four teams. Built C# automation modules using ABP Framework. Designed Blue Prism RPA processes for document handling workflows. Used Azure DevOps pipelines for CI/CD. Explored Copilot-based AI automation. First experience in a professional enterprise environment with production systems.</div>
      </div>
    </div>

    <div class="nm-section">
      <div class="nm-section-title">Projects</div>
      <div class="nm-projects-grid">

        <div class="nm-proj">
          <div class="nm-proj-name">Custom 2D Game Engine + Vampire Survivors Clone</div>
          <div class="nm-proj-tech">TypeScript · HTML5 Canvas API · Express · PostgreSQL · Drizzle ORM</div>
          <div class="nm-proj-desc">Full engine from scratch — RAF game loop, ECS entity management, AABB collision, delta-time physics, procedural world, wave AI. Live and playable.</div>
          <ul class="nm-proj-bullets">
            <li>Custom GameEngine class coordinates 6 systems per frame (input, physics, AI, collision, lifetime, render)</li>
            <li>Express + PostgreSQL backend with session auth and Drizzle ORM for leaderboards</li>
            <li>SylphBlooms weapon system — flower turrets with bloom-stage damage scaling</li>
          </ul>
          <div class="nm-proj-links">
            <a class="nm-proj-link gh" href="https://github.com/flyinginsectsunpig/game_demo" target="_blank">⊞ GitHub</a>
            <a class="nm-proj-link live" href="https://game-demo-gray.vercel.app" target="_blank">▶ Live Demo</a>
          </div>
        </div>

        <div class="nm-proj">
          <div class="nm-proj-name">PrintIt101 — 3D T-Shirt Customisation Platform</div>
          <div class="nm-proj-tech">Java · Spring Boot · React · Three.js · REST API</div>
          <div class="nm-proj-desc">Full-stack team project. 3D shirt model with real-time logo placement, position/rotation/scale tracking, and production-ready output. Layered Spring Boot backend.</div>
          <ul class="nm-proj-bullets">
            <li>Spring Boot MVC with separated controller, service, and repository layers</li>
            <li>REST endpoints for order management, design upload, and validation</li>
            <li>React + Three.js client consuming backend APIs with error state handling</li>
          </ul>
          <div class="nm-proj-links">
            <a class="nm-proj-link gh" href="https://github.com/flyinginsectsunpig/PrintIt101" target="_blank">⊞ Backend</a>
            <a class="nm-proj-link gh" href="https://github.com/flyinginsectsunpig/printit101client1" target="_blank">⊞ Frontend</a>
          </div>
        </div>

        <div class="nm-proj">
          <div class="nm-proj-name">LoL Skin Buff/Nerf Tracker</div>
          <div class="nm-proj-tech">Python · Streamlit · scikit-learn · BeautifulSoup · Pandas</div>
          <div class="nm-proj-desc">Scrapes Riot Games patch notes, parses champion balance changes across patches, ML classifier predicts buff/nerf impact on win rates. Data analytics dashboard.</div>
          <ul class="nm-proj-bullets">
            <li>Multi-source scraper pipeline: patch chronology → champion history → pick rates → processed CSV</li>
            <li>AI Change Classifier — predicts buff/nerf/bugfix from patch note text using scikit-learn</li>
            <li>Correlation analysis between skin releases, buff timing, and win-rate shifts</li>
          </ul>
          <div class="nm-proj-links">
            <a class="nm-proj-link gh" href="https://github.com/flyinginsectsunpig/LoL-Skin-Buff-Nerf" target="_blank">⊞ GitHub</a>
          </div>
        </div>

        <div class="nm-proj">
          <div class="nm-proj-name">NannyAtYourService</div>
          <div class="nm-proj-tech">Oracle SQL · PL/SQL</div>
          <div class="nm-proj-desc">Multi-table relational database system built for a service-matching platform. Complex queries, stored procedures, and full data integrity design.</div>
          <ul class="nm-proj-bullets">
            <li>Sequences, triggers, cursors, and stored procedures for business logic in the database layer</li>
            <li>Window functions and complex multi-table joins for reporting queries</li>
            <li>Normalised schema design with enforced referential integrity constraints</li>
          </ul>
        </div>

      </div>
    </div>

    <div class="nm-section">
      <div class="nm-section-title">Education & Certifications</div>
      <div class="nm-exp-item">
        <div class="nm-exp-role">Diploma in ICT: Applications Development</div>
        <div class="nm-exp-place">Cape Peninsula University of Technology (CPUT)</div>
        <div class="nm-exp-date">2021 – 2025</div>
      </div>
      <div class="nm-exp-item" style="margin-top:14px;">
        <div class="nm-exp-role">Microsoft Azure Fundamentals (AZ-900)</div>
        <div class="nm-exp-place">Microsoft Certified</div>
      </div>
      <div class="nm-exp-item" style="margin-top:14px;">
        <div class="nm-exp-role">Machine Learning A-Z</div>
        <div class="nm-exp-place">Udemy · Regression, Classification, Clustering, NLP, Deep Learning, XGBoost</div>
      </div>
      <div class="nm-exp-item" style="margin-top:14px;">
        <div class="nm-exp-role">Ethereum & Solidity Bootcamp</div>
        <div class="nm-exp-place">Blockchain development fundamentals</div>
      </div>
    </div>

    <div class="nm-section">
      <div class="nm-section-title">Contact</div>
      <div class="nm-contact">
        <a href="https://github.com/flyinginsectsunpig" target="_blank">github.com/flyinginsectsunpig</a>
        <span style="color:var(--na)">·</span>
        <span style="font-size:13px;color:var(--na)">Available immediately</span>
      </div>
    </div>
  </div>
</div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
'use strict';
// ═══════════════════════════════════════════════════════════
// WORLD CONSTANTS & TILEMAP
// ═══════════════════════════════════════════════════════════
const canvas=document.getElementById('world');
const ctx=canvas.getContext('2d');
const TILE=32, WTX=80, WTY=60, WW=WTX*TILE, WH=WTY*TILE;
let W,H;
function resize(){W=canvas.width=window.innerWidth;H=canvas.height=window.innerHeight;}
resize(); window.addEventListener('resize',resize);
const cam={x:0,y:0};
const T={GRASS:0,GRASS2:1,FLOOR:2,FLOOR2:3,WALL:4,TREE:5,TREE2:6,PATH:7};

// Solid lookup array for O(1) access
const solidMap=new Uint8Array(WTX*WTY);
const tm=[];
for(let y=0;y<WTY;y++){tm[y]=[];for(let x=0;x<WTX;x++) tm[y][x]=(x+y)%7===0?T.GRASS2:T.GRASS;}

const rooms=[
  {id:'hub',   name:'TOWN SQUARE',    col:'#4fc3f7',shad:'#003a5a',tx:32,ty:22,tw:16,th:12,fc:'#1a1428',fc2:'#1c1630',wc:'#2d1b4e'},
  {id:'ml',    name:'ML LAB',         col:'#3ddc84',shad:'#0a3a1a',tx:6, ty:18,tw:18,th:16,fc:'#0d1a0d',fc2:'#0f1f0f',wc:'#1a3d1a'},
  {id:'ge',    name:'ENGINE ARENA',   col:'#ce93d8',shad:'#3d0a5a',tx:56,ty:18,tw:18,th:16,fc:'#140d1a',fc2:'#18101e',wc:'#3d1a5a'},
  {id:'db',    name:'DB VAULT',       col:'#ffb74d',shad:'#5a2a00',tx:32,ty:6, tw:16,th:12,fc:'#1a0d04',fc2:'#1f1005',wc:'#5a2a00'},
  {id:'devops',name:'DEVOPS CONTROL', col:'#f44336',shad:'#5a0000',tx:32,ty:42,tw:16,th:12,fc:'#1a0505',fc2:'#1f0808',wc:'#4a1010'},
  {id:'arch',  name:'ARCH MUSEUM',    col:'#90caf9',shad:'#0a2a5a',tx:3, ty:38,tw:14,th:14,fc:'#080d1a',fc2:'#0a1020',wc:'#1a2a4a'},
  {id:'prob',  name:'PROBLEM ARENA',  col:'#ef9a9a',shad:'#5a1a1a',tx:63,ty:38,tw:14,th:14,fc:'#1a0808',fc2:'#1f0a0a',wc:'#4a1818'},
  {id:'secret',name:'???',            col:'#9c27b0',shad:'#3a005a',tx:3, ty:3, tw:10,th:8, fc:'#0d0014',fc2:'#100018',wc:'#280040'},
];

for(const r of rooms){
  for(let ty=r.ty;ty<r.ty+r.th;ty++) for(let tx=r.tx;tx<r.tx+r.tw;tx++){
    if(ty===r.ty||ty===r.ty+r.th-1||tx===r.tx||tx===r.tx+r.tw-1) tm[ty][tx]=T.WALL;
    else tm[ty][tx]=(tx+ty)%2===0?T.FLOOR:T.FLOOR2;
  }
}

// ═══════════════════════════════════════════════════════════
// PATHS & WALL OPENINGS
// Topology:
//   Hub N↔DB   Hub S↔DevOps   Hub W↔ML   Hub E↔GE
//   ML S↔Arch N   Arch E↔DevOps W   DevOps E↔Prob W   Prob N↔GE S
//   Secret room: east wall only (hidden, no path)
//   Rule: only open a wall where a path enters that room.
// ═══════════════════════════════════════════════════════════

const hub =rooms[0]; // tx:32 ty:22 tw:16 th:12  midX=40 midY=28
const db  =rooms[3]; // tx:32 ty:6  tw:16 th:12
const dv  =rooms[4]; // tx:32 ty:42 tw:16 th:12
const ml  =rooms[1]; // tx:6  ty:18 tw:18 th:16
const ge  =rooms[2]; // tx:56 ty:18 tw:18 th:16
const arch=rooms[5]; // tx:3  ty:38 tw:14 th:14
const prob=rooms[6]; // tx:63 ty:38 tw:14 th:14
const sec =rooms[7]; // tx:3  ty:3  tw:10 th:8

// Derived coordinates used across all path segments
const hubMidX = hub.tx + Math.floor(hub.tw/2); // 40
const hubMidY = hub.ty + Math.floor(hub.th/2); // 28

// Helper: carve a 2-wide horizontal path between two x positions at a given y
function pathH(y,x0,x1){
  for(let x=Math.min(x0,x1);x<=Math.max(x0,x1);x++){
    if(tm[y][x]!==T.WALL)   tm[y][x]=T.PATH;
    if(tm[y+1][x]!==T.WALL) tm[y+1][x]=T.PATH;
  }
}
// Helper: carve a 2-wide vertical path between two y positions at a given x
function pathV(x,y0,y1){
  for(let y=Math.min(y0,y1);y<=Math.max(y0,y1);y++){
    if(tm[y][x]!==T.WALL)   tm[y][x]=T.PATH;
    if(tm[y][x+1]!==T.WALL) tm[y][x+1]=T.PATH;
  }
}
// Helper: open a 2-tile gap in a wall row at a column (for north/south walls)
function openWallRow(row,col){ tm[row][col]=T.FLOOR; tm[row][col+1]=T.FLOOR; }
// Helper: open a 2-tile gap in a wall column at a row (for east/west walls)
function openWallCol(col,row){ tm[row][col]=T.FLOOR; tm[row+1][col]=T.FLOOR; }

// ── 1. HUB ↔ DB VAULT (north, straight vertical) ──────────────────────────
// Opening column: hubMidX (cols 40,41)
// Hub north wall opens at hubMidX
openWallRow(hub.ty, hubMidX);
// DB south wall opens at hubMidX
openWallRow(db.ty+db.th-1, hubMidX);
// Vertical path between them
pathV(hubMidX, db.ty+db.th, hub.ty-1);

// ── 2. HUB ↔ DEVOPS CONTROL (south, straight vertical) ───────────────────
// Hub south wall opens at hubMidX
openWallRow(hub.ty+hub.th-1, hubMidX);
// DevOps north wall opens at hubMidX
openWallRow(dv.ty, hubMidX);
// Vertical path between them
pathV(hubMidX, hub.ty+hub.th, dv.ty-1);

// ── 3. HUB ↔ ML LAB (west, straight horizontal) ───────────────────────────
// Row: hubMidY (rows 28,29)
// Hub west wall opens at hubMidY
openWallCol(hub.tx, hubMidY);
// ML east wall opens at hubMidY
openWallCol(ml.tx+ml.tw-1, hubMidY);
// Horizontal path between them
pathH(hubMidY, ml.tx+ml.tw, hub.tx-1);

// ── 4. HUB ↔ ENGINE ARENA (east, straight horizontal) ────────────────────
// Hub east wall opens at hubMidY
openWallCol(hub.tx+hub.tw-1, hubMidY);
// GE west wall opens at hubMidY
openWallCol(ge.tx, hubMidY);
// Horizontal path between them
pathH(hubMidY, hub.tx+hub.tw, ge.tx-1);

// ── 5. ML LAB ↔ ARCH MUSEUM (ML south → Arch north) ──────────────────────
// Use ML's midX col for both: mlMidX = ml.tx + floor(ml.tw/2) = 6+9 = 15
// Arch's north wall opening will be at archMidX = arch.tx + floor(arch.tw/2) = 3+7 = 10
// Route: vertical south from ML midX (15) to arch's y, then horizontal jog west to arch midX (10)
// But simplest clean route: use a single vertical at mlMidX down to a horizontal,
// then horizontal west to archMidX, entering arch north wall.
// Arch north wall y = arch.ty = 38. ML south wall y = ml.ty+ml.th-1 = 33.
// We'll drop straight from mlMidX=15 to y=38, arch north opens at col 10.
// So: vertical at x=14 from y=34 to y=38, then horizontal at y=37 from x=10 to x=14.
// Actually: ML south opens at mlMidX=15 (cols 15,16), vertical down to arch.ty row,
// arch north opens at x=10 (cols 10,11), horizontal at y=arch.ty-1 connecting x=10 to x=15.
{
  const mlMidX = ml.tx + Math.floor(ml.tw/2); // 15
  const archNX  = arch.tx + Math.floor(arch.tw/2); // 10
  // ML south wall opens at mlMidX
  openWallRow(ml.ty+ml.th-1, mlMidX);
  // Arch north wall opens at archNX
  openWallRow(arch.ty, archNX);
  // Vertical from ML south wall down to arch north level (exclusive of walls)
  pathV(mlMidX, ml.ty+ml.th, arch.ty-1);
  // Horizontal jog at the row just above arch north wall connecting the two columns
  pathH(arch.ty-2, archNX, mlMidX);
  // Close any gap: vertical from arch north wall up to horizontal row
  pathV(archNX, arch.ty-2, arch.ty-1);
}

// ── 6. ARCH MUSEUM ↔ DEVOPS CONTROL (Arch east → DevOps west) ────────────
// Arch east wall at x = arch.tx+arch.tw-1 = 16. DevOps west wall at x = dv.tx = 32.
// Choose a row that lies between both rooms' y ranges.
// Arch spans ty:38–51, DevOps spans ty:42–53. Shared y range: 42–51.
// Use y = arch.ty + floor(arch.th/2) = 38+7 = 45 (rows 45,46) — inside both rooms' vertical span
{
  const archDevY = arch.ty + Math.floor(arch.th/2); // 45
  // Arch east wall opens at archDevY
  openWallCol(arch.tx+arch.tw-1, archDevY);
  // DevOps west wall opens at archDevY
  openWallCol(dv.tx, archDevY);
  // Horizontal path between them
  pathH(archDevY, arch.tx+arch.tw, dv.tx-1);
}

// ── 7. DEVOPS CONTROL ↔ PROBLEM ARENA (DevOps east → Prob west) ──────────
// DevOps east wall at x = dv.tx+dv.tw-1 = 47. Prob west wall at x = prob.tx = 63.
// DevOps spans ty:42–53, Prob spans ty:38–51. Shared y range: 42–51.
// Use y = dv.ty + floor(dv.th/2) = 42+6 = 48 (rows 48,49)
{
  const dvProbY = dv.ty + Math.floor(dv.th/2); // 48
  // DevOps east wall opens at dvProbY
  openWallCol(dv.tx+dv.tw-1, dvProbY);
  // Prob west wall opens at dvProbY
  openWallCol(prob.tx, dvProbY);
  // Horizontal path between them
  pathH(dvProbY, dv.tx+dv.tw, prob.tx-1);
}

// ── 8. PROBLEM ARENA ↔ ENGINE ARENA (Prob north → GE south) ──────────────
// Prob north wall at y = prob.ty = 38. GE south wall at y = ge.ty+ge.th-1 = 33.
// Prob spans tx:63–76, GE spans tx:56–73. Shared x range: 63–73.
// Use x = prob.tx + floor(prob.tw/2) = 63+7 = 70 (cols 70,71)
{
  const probGEX = prob.tx + Math.floor(prob.tw/2); // 70
  // Prob north wall opens at probGEX
  openWallRow(prob.ty, probGEX);
  // GE south wall opens at probGEX
  openWallRow(ge.ty+ge.th-1, probGEX);
  // Vertical path between them
  pathV(probGEX, ge.ty+ge.th, prob.ty-1);
}

// ── SECRET ROOM — east wall only, single tile, no external path ───────────
// Hidden: no path leads to it, player must explore
{
  const secMidY = sec.ty + Math.floor(sec.th/2); // 7
  openWallCol(sec.tx+sec.tw-1, secMidY);
}

// ── Final: restore hub openings (path code may have clipped them) ─────────
openWallRow(hub.ty,          hubMidX); // north
openWallRow(hub.ty+hub.th-1, hubMidX); // south
openWallCol(hub.tx,          hubMidY); // west
openWallCol(hub.tx+hub.tw-1, hubMidY); // east


// Trees
for(let i=0;i<100;i++){
  const tx=2+Math.floor(Math.random()*(WTX-4)),ty=2+Math.floor(Math.random()*(WTY-4));
  if(tm[ty][tx]!==T.GRASS&&tm[ty][tx]!==T.GRASS2) continue;
  let ok=true;
  for(const r of rooms) if(tx>r.tx-4&&tx<r.tx+r.tw+4&&ty>r.ty-4&&ty<r.ty+r.th+4){ok=false;break;}
  if(ok){tm[ty][tx]=T.TREE;if(ty>0&&(tm[ty-1][tx]===T.GRASS||tm[ty-1][tx]===T.GRASS2)) tm[ty-1][tx]=T.TREE2;}
}

// Build solid map
for(let y=0;y<WTY;y++) for(let x=0;x<WTX;x++)
  solidMap[y*WTX+x]=(tm[y][x]===T.WALL||tm[y][x]===T.TREE||tm[y][x]===T.TREE2)?1:0;

function isSolid(tx,ty){
  if(tx<0||tx>=WTX||ty<0||ty>=WTY) return true;
  return solidMap[ty*WTX+tx]===1;
}

// ═══════════════════════════════════════════════════════════
// STATIONS + NPCS
// ═══════════════════════════════════════════════════════════
const stations=[
  {id:'pedestal',tx:39,ty:27,col:'#4fc3f7',icon:'◈',dlg:'🔮 ORACLE OF KNOWLEDGE\n"Zone-aware AI. Ask anything.\nPress E to open the interface."',modalId:'chatbot'},
  {id:'ml',      tx:14,ty:25,col:'#3ddc84',icon:'◇',dlg:'📊 ML TERMINAL\nR² metrics · K-Means++ · Train/Test split.\nLive algorithms running in your browser.',modalId:'ml'},
  {id:'ge',      tx:64,ty:25,col:'#ce93d8',icon:'◉',dlg:'🎮 ENGINE CORE\nFrame budget profiler · ECS inspector.\nCustom engine — live demo at game-demo-gray.vercel.app',modalId:'ge'},
  {id:'db',      tx:39,ty:11,col:'#ffb74d',icon:'▣',dlg:'🗄 VAULT TERMINAL\nEXPLAIN plans · Index toggle.\nReal SQL from NannyAtYourService.',modalId:'db'},
  {id:'devops',  tx:39,ty:47,col:'#f44336',icon:'⬡',dlg:'🖥 DEVOPS CONTROL ROOM\nCascade failures · SLO burn rate.\nCI/CD pipeline simulation.',modalId:'devops'},
  {id:'arch',    tx:9, ty:44,col:'#90caf9',icon:'◫',dlg:'🏛 ARCHITECTURE MUSEUM\nMonolith · MVC · Microservices.\nInteractive trade-off cards.',modalId:'arch'},
  {id:'prob',    tx:67,ty:44,col:'#ef9a9a',icon:'⁈',dlg:'⚔ PROBLEM-SOLVING ARENA\nReal scenarios. Real reasoning.\nTrade-offs, not buzzwords.',modalId:'prob'},
  {id:'secret',  tx:7, ty:6, col:'#9c27b0',icon:'★',dlg:'👁 HIDDEN TERMINAL\nYou found the secret room.\nPress E to access.',modalId:'secret'},
  {id:'timeline',tx:35,ty:50,col:'#f5c518',icon:'⏱',dlg:'📅 GROWTH TIMELINE\n2019 → 2025. Click milestones.\nWhat I built, what I learned.',modalId:'timeline'},
];

const npcs=[
  {id:'npc1',tx:37,ty:26,col:'#f5c518',name:'COGENT REP',dlg:'👔 COGENT EMPLOYEE\n"Zakhir did 5 months WIL here.\nAzure DevOps, C#, Blue Prism RPA,\nand AI automation. Reliable."'},
  {id:'npc2',tx:41,ty:26,col:'#ce93d8',name:'CPUT GRAD', dlg:'🎓 CPUT CLASSMATE\n"Diploma in ICT Applications Dev,\n2025. Built a game engine and\na 3D t-shirt platform."'},
  {id:'npc3',tx:39,ty:30,col:'#f44336',name:'GUIDE',     dlg:'🗺 WORLD GUIDE\n"S → DevOps · SW → Arch Museum\nSE → Problem Arena · NW → Secret\nToggle top-right for normal mode."'},
];

// ═══════════════════════════════════════════════════════════
// PLAYER
// ═══════════════════════════════════════════════════════════
const PL={px:(32+8)*TILE+TILE/2,py:(22+6)*TILE+TILE/2,spd:2.8,dir:0,frame:0,ftimer:0,moving:false,w:TILE*.65,h:TILE*.65};
let gePlayer=null; // cached reference for game engine
const keys={};
let running=false,tick=0,nearEnt=null,lastZone='',isGameMode=true;
const zoneVisitLog=[];

window.addEventListener('keydown',e=>{
  keys[e.key.toLowerCase()]=true;
  const tag=document.activeElement?.tagName?.toLowerCase();
  const inInput=tag==='input'||tag==='textarea';
  if(!inInput&&['arrowup','arrowdown','arrowleft','arrowright',' '].includes(e.key.toLowerCase())) e.preventDefault();
  if((e.key==='e'||e.key==='E')&&running&&!inInput) doInteract();
  if(e.key==='Escape') closeModal();
});
window.addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);

// ═══════════════════════════════════════════════════════════
// TELEMETRY LOG
// ═══════════════════════════════════════════════════════════
const teleLines=[];
function tlog(msg,lvl='info'){
  const now=new Date();
  const ts=`${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
  const cls=lvl==='warn'?'tl-warn':lvl==='err'?'tl-err':'tl-info';
  const prefix=lvl==='warn'?'WARN ':lvl==='err'?'ERR  ':'INFO ';
  teleLines.push(`<span class="${cls}">[${ts}] ${prefix} ${msg}</span>`);
  if(teleLines.length>12) teleLines.shift();
  const el=document.getElementById('telelog-inner');
  if(el){el.innerHTML=teleLines.join('\n');el.parentElement.scrollTop=el.parentElement.scrollHeight;}
}

// ═══════════════════════════════════════════════════════════
// RENDERING
// ═══════════════════════════════════════════════════════════
const TC={[T.GRASS]:'#1a2e1a',[T.GRASS2]:'#162616',[T.FLOOR]:'#1a1428',[T.FLOOR2]:'#1c1630',[T.WALL]:'#2d1b4e',[T.TREE]:'#3d2000',[T.TREE2]:'#1a4a0a',[T.PATH]:'#2a2018'};
const TD={[T.GRASS]:'#1e3320',[T.GRASS2]:'#1a2a1a'};

function drawTile(tx,ty){
  const t=tm[ty][tx];
  const sx=tx*TILE-cam.x,sy=ty*TILE-cam.y;
  if(sx<-TILE||sx>W+TILE||sy<-TILE||sy>H+TILE) return;
  let col=TC[t]||'#1a1a2e';
  if(t===T.FLOOR||t===T.FLOOR2||t===T.WALL){
    for(const r of rooms){
      if(tx>=r.tx&&tx<r.tx+r.tw&&ty>=r.ty&&ty<r.ty+r.th){
        col=t===T.WALL?r.wc:t===T.FLOOR?r.fc:r.fc2; break;
      }
    }
  }
  ctx.fillStyle=col;ctx.fillRect(sx,sy,TILE,TILE);
  if(t===T.GRASS||t===T.GRASS2){
    ctx.fillStyle=TD[t]||'#1a2a1a';
    if((tx+ty)%3===0) ctx.fillRect(sx+4,sy+6,2,2);
    if((tx*2+ty)%5===0) ctx.fillRect(sx+20,sy+16,2,2);
    if((tx+ty*3)%7===0){ctx.fillStyle='#244020';ctx.fillRect(sx+12,sy+10,1,4);}
  } else if(t===T.WALL){
    ctx.fillStyle='rgba(0,0,0,.28)';
    const brk=(ty%2===0)?0:TILE/2;
    for(let bx=-brk;bx<TILE;bx+=TILE/2) ctx.fillRect(sx+bx,sy,1,TILE);
    ctx.fillRect(sx,sy+TILE/2,TILE,1);
    ctx.fillStyle='rgba(255,255,255,.05)';ctx.fillRect(sx,sy,TILE,2);
  } else if(t===T.FLOOR||t===T.FLOOR2){
    ctx.fillStyle='rgba(0,0,0,.18)';
    ctx.fillRect(sx,sy,1,TILE);ctx.fillRect(sx,sy,TILE,1);
    if((tx+ty)%4===0){ctx.fillStyle='rgba(255,255,255,.03)';ctx.fillRect(sx+TILE/2-1,sy+TILE/2-1,2,2);}
  } else if(t===T.PATH){
    ctx.fillStyle='#1e1810';
    if((tx+ty)%2===0) ctx.fillRect(sx+6,sy+6,4,4);
    else ctx.fillRect(sx+22,sy+20,4,4);
  } else if(t===T.TREE){
    ctx.fillStyle='#2a1400';ctx.fillRect(sx+13,sy+10,6,22);
  } else if(t===T.TREE2){
    ctx.fillStyle='#1a4a0a';ctx.fillRect(sx+5,sy+5,22,24);
    ctx.fillStyle='#225a0a';ctx.fillRect(sx+9,sy+1,14,26);
    ctx.fillStyle='#2a6a10';ctx.fillRect(sx+11,sy+3,10,8);
  }
}

function drawRoomLabels(){
  ctx.textAlign='center';ctx.globalAlpha=.5;
  for(const r of rooms){
    const cx=r.tx*TILE+r.tw*TILE/2-cam.x,cy=(r.ty+1)*TILE+10-cam.y;
    if(cx<-120||cx>W+120) continue;
    ctx.font='7px "Press Start 2P",monospace';ctx.fillStyle=r.col;ctx.fillText(r.name,cx,cy);
  }
  ctx.globalAlpha=1;
}

function drawStations(){
  nearEnt=null;
  for(const s of stations){
    const sx=s.tx*TILE-cam.x,sy=s.ty*TILE-cam.y;
    if(sx<-60||sx>W+60) continue;
    const dist=Math.hypot(PL.px-(s.tx*TILE+TILE/2),PL.py-(s.ty*TILE+TILE/2));
    const near=dist<65;if(near&&!nearEnt) nearEnt=s;
    const p=.5+.5*Math.sin(tick*.08+s.tx);
    ctx.shadowColor=s.col;ctx.shadowBlur=near?18*p:8;
    ctx.fillStyle=s.col+'1a';ctx.fillRect(sx-3,sy-3,TILE+6,TILE+6);
    ctx.strokeStyle=s.col;ctx.lineWidth=near?2.5:1.5;ctx.strokeRect(sx,sy,TILE,TILE);
    ctx.fillStyle=s.col+'30';ctx.fillRect(sx+2,sy+2,TILE-4,TILE-4);
    ctx.shadowBlur=0;
    ctx.font='17px monospace';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillStyle=s.col;ctx.fillText(s.icon,sx+TILE/2,sy+TILE/2);
    ctx.textBaseline='alphabetic';
    if(near){
      ctx.beginPath();ctx.arc(sx+TILE/2,sy+TILE/2,26+4*p,tick*.06,tick*.06+Math.PI);
      ctx.strokeStyle=s.col+'77';ctx.lineWidth=2;ctx.stroke();
    }
  }
}

function drawNPCs(){
  for(const n of npcs){
    const sx=n.tx*TILE-cam.x,sy=n.ty*TILE-cam.y;
    if(sx<-60||sx>W+60) continue;
    const dist=Math.hypot(PL.px-(n.tx*TILE+TILE/2),PL.py-(n.ty*TILE+TILE/2));
    if(dist<65&&!nearEnt) nearEnt=n;
    ctx.shadowColor=n.col;ctx.shadowBlur=dist<65?10:4;
    ctx.fillStyle=n.col;ctx.fillRect(sx+10,sy+9,12,15);
    ctx.fillStyle='#f5cba7';ctx.fillRect(sx+11,sy+2,10,9);
    ctx.shadowBlur=0;
    if(dist<65){ctx.fillStyle='#fff';ctx.font='11px monospace';ctx.textAlign='center';ctx.fillText('!',sx+TILE/2,sy-4);}
    ctx.font='5px "Press Start 2P",monospace';ctx.textAlign='center';ctx.fillStyle=n.col;ctx.globalAlpha=.7;
    ctx.fillText(n.name,sx+TILE/2,sy+29);ctx.globalAlpha=1;
  }
}

function drawPlayer(){
  const sx=Math.round(PL.px-cam.x-16),sy=Math.round(PL.py-cam.y-16);
  const S=2;
  ctx.save();ctx.translate(sx,sy);
  ctx.fillStyle='rgba(0,0,0,.3)';
  ctx.beginPath();ctx.ellipse(16*S,15*S,6*S,2*S,0,0,Math.PI*2);ctx.fill();
  const bob=PL.moving?Math.sin(tick*.25)*S:0;
  const arm=PL.moving?Math.sin(tick*.25)*2*S:0;
  const HAIR='#4a2c0a',SKIN='#f5cba7',SHIRT='#1a5f99',PANTS='#1a1a4a',BOOT='#3d1f0a',CAPE='#8b1a1a';
  if(PL.dir===0||PL.dir===1){
    ctx.fillStyle=BOOT;ctx.fillRect(5*S,(13+bob)*S,3*S,2*S);ctx.fillRect(8*S,(13-bob)*S,3*S,2*S);
    ctx.fillStyle=PANTS;ctx.fillRect(5*S,10*S,3*S,3*S);ctx.fillRect(8*S,10*S,3*S,3*S);ctx.fillRect(5*S,9*S,6*S,2*S);
    ctx.fillStyle=CAPE;ctx.fillRect(4*S,6*S,8*S,4*S);
    ctx.fillStyle=SHIRT;ctx.fillRect(2*S,(7+arm)*S,2*S,3*S);ctx.fillRect(12*S,(7-arm)*S,2*S,3*S);
    ctx.fillStyle=SKIN;ctx.fillRect(5*S,2*S,6*S,5*S);
    ctx.fillStyle=HAIR;ctx.fillRect(5*S,2*S,6*S,2*S);ctx.fillRect(4*S,3*S,2*S,4*S);ctx.fillRect(10*S,3*S,2*S,4*S);
    if(PL.dir===0){ctx.fillStyle='#1a0a06';ctx.fillRect(6*S,5*S,1*S,1*S);ctx.fillRect(9*S,5*S,1*S,1*S);}
    else{ctx.fillStyle=HAIR;ctx.fillRect(5*S,2*S,6*S,5*S);}
  } else {
    const flip=PL.dir===2;
    ctx.save();if(flip){ctx.scale(-1,1);ctx.translate(-16*S*2,0);}
    ctx.fillStyle=BOOT;ctx.fillRect(5*S,(13+bob)*S,3*S,2*S);ctx.fillRect(9*S,(13-bob)*S,3*S,2*S);
    ctx.fillStyle=PANTS;ctx.fillRect(5*S,10*S,3*S,3*S);ctx.fillRect(9*S,10*S,3*S,3*S);
    ctx.fillStyle=CAPE;ctx.fillRect(4*S,6*S,8*S,5*S);
    ctx.fillStyle=SHIRT;ctx.fillRect(3*S,(7+arm)*S,2*S,3*S);
    ctx.fillStyle=SKIN;ctx.fillRect(5*S,1*S,7*S,6*S);
    ctx.fillStyle=HAIR;ctx.fillRect(5*S,1*S,7*S,2*S);ctx.fillRect(5*S,1*S,2*S,5*S);
    ctx.fillStyle='#1a0a06';ctx.fillRect(11*S,4*S,1*S,1*S);
    ctx.restore();
  }
  ctx.restore();
}

let minimapDirty=true;
function drawMinimap(){
  if(!minimapDirty) return;
  const mc=document.getElementById('minimap');
  const mc2=mc.getContext('2d');
  const mw=mc.width,mh=mc.height,scx=mw/WTX,scy=mh/WTY;
  mc2.fillStyle='#05050f';mc2.fillRect(0,0,mw,mh);
  for(const r of rooms){
    mc2.fillStyle=r.col+'22';mc2.fillRect(r.tx*scx,r.ty*scy,r.tw*scx,r.th*scy);
    mc2.strokeStyle=r.col;mc2.lineWidth=1;mc2.strokeRect(r.tx*scx,r.ty*scy,r.tw*scx,r.th*scy);
  }
  for(const s of stations){mc2.fillStyle=s.col;mc2.fillRect((s.tx+.5)*scx-1,(s.ty+.5)*scy-1,3,3);}
  const pmx=(PL.px/TILE)*scx,pmy=(PL.py/TILE)*scy;
  mc2.fillStyle=tick%30<20?'#fff':'#f5c518';mc2.fillRect(pmx-2,pmy-2,4,4);
  mc2.strokeStyle='rgba(255,255,255,.12)';mc2.lineWidth=.5;
  mc2.strokeRect((cam.x/TILE)*scx,(cam.y/TILE)*scy,(W/TILE)*scx,(H/TILE)*scy);
  minimapDirty=false;
}

// ═══════════════════════════════════════════════════════════
// GAME LOOP
// ═══════════════════════════════════════════════════════════
let lastPX=0,lastPY=0;
function update(){
  tick++;
  if(!running||document.getElementById('modal').classList.contains('open')) return;
  let dx=0,dy=0;
  if(keys['arrowleft']||keys['a']){dx=-PL.spd;PL.dir=2;}
  if(keys['arrowright']||keys['d']){dx=PL.spd;PL.dir=3;}
  if(keys['arrowup']||keys['w']){dy=-PL.spd;PL.dir=1;}
  if(keys['arrowdown']||keys['s']){dy=PL.spd;PL.dir=0;}
  PL.moving=dx!==0||dy!==0;
  if(dx!==0&&dy!==0){dx*=.707;dy*=.707;}
  const hw=PL.w/2-2,hh=PL.h/2-2;
  const nx=PL.px+dx,ny=PL.py+dy;
  const canX=![[nx-hw,PL.py],[nx+hw,PL.py],[nx-hw,PL.py+hh],[nx+hw,PL.py+hh]].some(([x,y])=>isSolid(Math.floor(x/TILE),Math.floor(y/TILE)));
  const canY=![[PL.px,ny-hh],[PL.px,ny+hh],[PL.px-hw,ny+hh],[PL.px+hw,ny+hh]].some(([x,y])=>isSolid(Math.floor(x/TILE),Math.floor(y/TILE)));
  if(canX) PL.px=Math.max(hw,Math.min(WW-hw,nx));
  if(canY) PL.py=Math.max(hh,Math.min(WH-hh,ny));
  if(PL.moving){PL.ftimer++;if(PL.ftimer>9){PL.ftimer=0;PL.frame++;}}else PL.frame=0;
  const prevCamX=cam.x,prevCamY=cam.y;
  cam.x=Math.max(0,Math.min(WW-W,PL.px-W/2));
  cam.y=Math.max(0,Math.min(WH-H,PL.py-H/2));
  if(cam.x!==prevCamX||cam.y!==prevCamY) minimapDirty=true;
  // Zone detection
  let zn='THE OVERWORLD';
  const px=Math.floor(PL.px/TILE),py=Math.floor(PL.py/TILE);
  for(const r of rooms){if(px>r.tx&&px<r.tx+r.tw-1&&py>r.ty&&py<r.ty+r.th-1){zn=r.name;break;}}
  if(zn!==lastZone){
    lastZone=zn;
    document.getElementById('hud-zone').textContent='◆ '+zn;
    tlog(`player.zone_entered  zone=${zn.replace(/ /g,'_')}`);
    if(!zoneVisitLog.includes(zn)) zoneVisitLog.push(zn);
  }
  // Player moved
  if(Math.hypot(PL.px-lastPX,PL.py-lastPY)>64){
    lastPX=PL.px;lastPY=PL.py;
    tlog(`player.moved  pos=(${Math.floor(PL.px/TILE)},${Math.floor(PL.py/TILE)})  zone=${zn.replace(/ /g,'_')}`);
    minimapDirty=true;
  }
  // Dialog
  const dlg=document.getElementById('dialog');
  if(nearEnt){
    dlg.classList.add('show');
    document.getElementById('dlg-txt').textContent=nearEnt.dlg?.split('\n').slice(1).join('\n')||'';
  } else dlg.classList.remove('show');
}

function render(){
  ctx.fillStyle='#0d0d1a';ctx.fillRect(0,0,W,H);
  const stx=Math.max(0,Math.floor(cam.x/TILE)),etx=Math.min(WTX,Math.ceil((cam.x+W)/TILE)+1);
  const sty=Math.max(0,Math.floor(cam.y/TILE)),ety=Math.min(WTY,Math.ceil((cam.y+H)/TILE)+1);
  for(let ty=sty;ty<ety;ty++) for(let tx=stx;tx<etx;tx++) drawTile(tx,ty);
  drawRoomLabels();drawStations();drawNPCs();drawPlayer();drawMinimap();
}

// ── SYS Health Bar (aggregates world state) ──
let _sysH=100;
function updateSysHealth(){
  const entityLoad=Math.min(25, (geEnts.length||0)*1.2);
  const crashedSvcs=services.filter(s=>s.status!=='ONLINE').length*14;
  const degradedSvcs=services.filter(s=>s.status==='DEGRADED').length*7;
  _sysH=Math.max(8, 100-entityLoad-crashedSvcs-degradedSvcs+(Math.random()*3-1.5));
  const bar=document.getElementById('sys-bar');
  const pct=document.getElementById('sys-pct');
  if(!bar||!pct)return;
  bar.style.width=Math.round(_sysH)+'%';
  bar.style.background=_sysH>70?'#3ddc84':_sysH>40?'#ffb74d':'#f44336';
  pct.textContent=Math.round(_sysH)+'%';
  pct.style.color=bar.style.background;
}
setInterval(updateSysHealth,1200);

// ── Oracle glow tracks last visited zone ──
const ZONE_COLS={
  'ML LAB':'#3ddc84','ENGINE ARENA':'#ce93d8','DB VAULT':'#ffb74d',
  'DEVOPS CONTROL':'#f44336','ARCHITECTURE MUSEUM':'#90caf9',
  'PROBLEM ARENA':'#ef9a9a','SECRET TERMINAL':'#9c27b0','TIMELINE':'#f5c518'
};
function getOracleGlow(){return ZONE_COLS[lastZone]||'#4fc3f7';}

// loop() defined at end of file after all systems are initialized

// ═══════════════════════════════════════════════════════════
// PIXEL FLIP TRANSITION — direction-aware screen capture
// ═══════════════════════════════════════════════════════════
function doPixelFlip(toGame, onDone){
  const fc=document.getElementById('flip-canvas');
  fc.width=W; fc.height=H;
  fc.style.display='block';
  fc.style.zIndex='600';
  const fctx=fc.getContext('2d');
  const SZ=20;
  const cols=Math.ceil(W/SZ), rows=Math.ceil(H/SZ);

  // ── Capture source: the current visible screen ──
  const src=document.createElement('canvas');
  src.width=W; src.height=H;
  const sc=src.getContext('2d');

  if(!toGame){
    // game → normal: capture the live world canvas exactly
    try { sc.drawImage(document.getElementById('world'),0,0,W,H); } catch(e){
      sc.fillStyle='#0d0d1a'; sc.fillRect(0,0,W,H);
    }
  } else {
    // normal → game: render the normal-mode page into the canvas
    // by walking DOM elements and painting their geometry + colors
    sc.fillStyle='#0a0f1a';
    sc.fillRect(0,0,W,H);
    const nm=document.getElementById('normal-mode');
    if(nm&&nm.classList.contains('active')){
      // Walk each visible child and paint its background + text color block
      const paintEl=(el)=>{
        const r=el.getBoundingClientRect();
        if(r.width<2||r.height<2) return;
        const cs=getComputedStyle(el);
        const bg=cs.backgroundColor;
        const col=cs.color;
        const bdr=cs.borderColor;
        // Paint background
        if(bg&&bg!=='rgba(0, 0, 0, 0)'&&bg!=='transparent'){
          sc.fillStyle=bg; sc.fillRect(r.left,r.top,r.width,r.height);
        }
        // Paint a colored text-representation strip if element has text
        const txt=el.childNodes;
        let hasText=false;
        for(const n of txt) if(n.nodeType===3&&n.textContent.trim()) hasText=true;
        if(hasText&&r.height>4){
          sc.fillStyle=col||'#e2e8f0';
          const fh=Math.min(r.height*0.5,14);
          sc.fillRect(r.left+4,r.top+(r.height-fh)/2,r.width*0.8,fh);
        }
        // Paint border left accent if present
        const blw=parseFloat(cs.borderLeftWidth)||0;
        if(blw>=2){
          sc.fillStyle=cs.borderLeftColor||bdr;
          sc.fillRect(r.left,r.top,blw,r.height);
        }
      };
      // Walk the full subtree shallowly for speed
      const all=nm.querySelectorAll('div,p,span,a,button,h1,h2,h3');
      all.forEach(paintEl);
    }
  }

  // Centre-out ripple stagger
  const tiles=[];
  const cxm=cols/2, cym=rows/2;
  for(let r=0;r<rows;r++) for(let c=0;c<cols;c++){
    const dist=Math.hypot(c-cxm, r-cym);
    const maxDist=Math.hypot(cxm,cym)||1;
    tiles.push({c,r, delay:(dist/maxDist)*0.35+Math.random()*0.45});
  }

  const destCol=toGame?'#0d0d1a':'#0a0f1a';
  let start=null;

  function frame(ts){
    if(!start) start=ts;
    const elapsed=(ts-start)/1000;
    fctx.clearRect(0,0,W,H);
    let allDone=true;

    for(const t of tiles){
      const prog=Math.max(0,Math.min(1,(elapsed-t.delay)/0.26));
      const x=t.c*SZ, y=t.r*SZ;
      const sw=Math.min(SZ,W-x), sh=Math.min(SZ,H-y);
      if(sw<=0||sh<=0) continue;

      if(prog>=1){
        fctx.fillStyle=destCol;
        fctx.fillRect(x,y,sw,sh);
      } else {
        allDone=false;
        const half=prog<.5;
        const scaleX=Math.max(0.001, half?(1-prog*2):(prog*2-1));
        fctx.save();
        fctx.translate(x+sw/2, y);
        fctx.scale(scaleX, 1);
        if(half){
          // Front face: what you currently see
          try { fctx.drawImage(src, x,y,sw,sh, -sw/2,0,sw,sh); } catch(e){
            fctx.fillStyle=toGame?'#0a0f1a':'#0d0d1a';
            fctx.fillRect(-sw/2,0,sw,sh);
          }
          // Darken as it turns away
          fctx.fillStyle=`rgba(0,0,0,${prog*0.7})`;
          fctx.fillRect(-sw/2,0,sw,sh);
        } else {
          // Back face: destination color
          fctx.fillStyle=destCol;
          fctx.fillRect(-sw/2,0,sw,sh);
          // Glint at flip point
          const glint=Math.max(0,1-Math.abs(prog-.5)*22);
          if(glint>0){
            fctx.fillStyle=`rgba(255,255,255,${glint*0.35})`;
            fctx.fillRect(-sw/2,0,sw,sh);
          }
        }
        fctx.restore();
      }
    }

    if(allDone){ fc.style.display='none'; onDone(); }
    else requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
}

// ═══════════════════════════════════════════════════════════
// MODE TOGGLE
// ═══════════════════════════════════════════════════════════
function toggleMode(){
  const btn=document.getElementById('mode-toggle');
  const nm=document.getElementById('normal-mode');
  const mm=document.getElementById('minimap-wrap');
  const tl=document.getElementById('telelog');
  const dlg=document.getElementById('dialog');
  closeModal();
  if(isGameMode){
    // Switching to normal mode
    tlog('mode.switch  to=NORMAL','warn');
    doPixelFlip(false,()=>{
      nm.classList.add('active');
      mm.style.display='none';
      tl.style.display='none';
      dlg.style.display='none';
      running=false;
      btn.textContent='⬡ GAME MODE';
      isGameMode=false;
    });
  } else {
    // Switching back to game mode
    doPixelFlip(true,()=>{
      nm.classList.remove('active');
      mm.style.display='';
      tl.style.display='';
      running=true;
      btn.textContent='⬡ NORMAL MODE';
      isGameMode=true;
      tlog('mode.switch  to=GAME_MODE');
    });
  }
}

// ═══════════════════════════════════════════════════════════
// INTERACTION + MODAL
// ═══════════════════════════════════════════════════════════
function doInteract(){
  if(!nearEnt) return;
  if(nearEnt.modalId){
    tlog(`modal.opened  id=${nearEnt.modalId}  zone=${lastZone.replace(/ /g,'_')}`);
    openModal(nearEnt.modalId);
  }
}

const MCFG={
  chatbot:{title:'🔮 AI ORACLE — ZONE-AWARE INTELLIGENCE',col:'#4fc3f7',shad:'#003a5a'},
  ml:     {title:'📊 ML LABORATORY — LIVE ALGORITHMS',   col:'#3ddc84',shad:'#0a3a1a'},
  db:     {title:'🗄 DATABASE VAULT — SQL + EXPLAIN',    col:'#ffb74d',shad:'#5a2a00'},
  ge:     {title:'🎮 ENGINE ARENA — FRAME PROFILER',     col:'#ce93d8',shad:'#3d0a5a'},
  devops: {title:'🖥 DEVOPS — CI/CD + SLO MONITOR',     col:'#f44336',shad:'#5a0000'},
  arch:   {title:'🏛 ARCHITECTURE MUSEUM',               col:'#90caf9',shad:'#0a2a5a'},
  prob:   {title:'⚔ PROBLEM-SOLVING ARENA',             col:'#ef9a9a',shad:'#5a1a1a'},
  secret: {title:'👁 HIDDEN TERMINAL',                   col:'#9c27b0',shad:'#3a005a'},
  timeline:{title:'📅 GROWTH TIMELINE — 2019 → 2025',   col:'#f5c518',shad:'#7a5c00'},
};
let geRunning=false;

function openModal(id){
  const cfg=MCFG[id]||{title:'ZONE',col:'#fff',shad:'#333'};
  const p=document.getElementById('modal-panel');
  p.style.borderColor=cfg.col;p.style.boxShadow=`6px 6px 0 ${cfg.shad}`;
  document.getElementById('modal-hdr').style.borderColor=cfg.col+'55';
  const mt=document.getElementById('modal-title');mt.textContent=cfg.title;mt.style.color=cfg.col;
  document.getElementById('modal').classList.add('open');
  running=false;
  const body=document.getElementById('modal-body');
  if(id==='chatbot') body.innerHTML=buildChat();
  else if(id==='ml'){body.innerHTML=buildML();setTimeout(initML,80);}
  else if(id==='db'){body.innerHTML=buildDB();setTimeout(initDB,80);}
  else if(id==='ge'){body.innerHTML=buildGE();setTimeout(initGE,80);}
  else if(id==='devops'){body.innerHTML=buildDevOps();setTimeout(initDevOps,80);}
  else if(id==='arch'){body.innerHTML=buildArch();setTimeout(initArch,80);}
  else if(id==='prob') body.innerHTML=buildProb();
  else if(id==='secret') body.innerHTML=buildSecret();
  else if(id==='timeline') body.innerHTML=buildTimeline();
  // Accessibility: focus close button for keyboard/screen-reader users
  setTimeout(()=>{const cb=document.querySelector('#modal .cbtn');if(cb)cb.focus();},100);
}

function closeModal(){
  document.getElementById('modal').classList.remove('open');
  geRunning=false;
  document.removeEventListener('keydown',geDocKey);
  document.removeEventListener('keyup',geDocKeyUp);
  if(sloInterval){clearInterval(sloInterval);sloInterval=null;}
  if(pipeTimer){clearInterval(pipeTimer);pipeTimer=null;}
  if(_incTimer){clearInterval(_incTimer);_incTimer=null;}
  if(_probTimerTick){clearInterval(_probTimerTick);_probTimerTick=null;}
  if(isGameMode) running=true;
}

// ═══════════════════════════════════════════════════════════
// CHATBOT — Retrieval-based, zero API, zero cost
// ═══════════════════════════════════════════════════════════

// ── Knowledge base: intents with triggers + authored responses ──
const KB=[
  {id:'identity',
   tags:['who','zakhir','about','introduce','yourself','background','bio','profile'],
   z:null,
   r:`Zakhir McKinnon is a Junior Software Developer based in Cape Town, South Africa. He completed a Diploma in ICT: Applications Development at CPUT in 2025 and has 5 months of enterprise WIL experience at COGENT. He builds systems with architectural intent — not just code.`},

  {id:'cogent',
   tags:['cogent','wil','internship','work integrated','placement','enterprise','industry'],
   z:'DEVOPS CONTROL',
   r:`At COGENT, Zakhir completed 5 months of Work Integrated Learning rotating across four teams: Analyst, Automation, Azure DevOps, and APA (AI automation). He worked with C#, ABP Framework, Blue Prism RPA, Azure DevOps CI/CD pipelines, and Copilot-based AI automation — all in a live production enterprise environment.`},

  {id:'stack',
   tags:['stack','tech','language','languages','skill','skills','know','use','tools','framework'],
   z:null,
   r:`Core languages: Java, TypeScript, JavaScript, C#, Python, SQL. Frameworks: Spring Boot, React, ABP Framework. Platform: Azure DevOps. Specialisms: HTML5 Canvas API (game engine), Blue Prism RPA, Oracle SQL/PL/SQL. He works across frontend, backend, and database layers.`},

  {id:'engine',
   tags:['game','engine','canvas','typescript','2d','loop','raf','requestanimation','particle','collision','aabb','entity','physics','delta'],
   z:'ENGINE ARENA',
   r:`Zakhir built a custom 2D game engine from scratch in TypeScript using the raw HTML5 Canvas API — no frameworks. It includes a requestAnimationFrame game loop with delta-time physics, AABB collision detection, entity management, a spatial grid for broad-phase optimisation, and a particle pooling system. The system inside this very portfolio is built on that engine.`},

  {id:'printit',
   tags:['printit','print','shirt','3d','threejs','three','react','spring','java','fullstack','full-stack','factory','builder','design pattern'],
   z:null,
   r:`PrintIt101 is a full-stack 3D t-shirt customisation platform. Frontend: React + Three.js for real-time 3D rendering. Backend: Java Spring Boot REST API applying Builder and Factory design patterns. It was a team project integrating live 3D rendering with backend business logic.`},

  {id:'nanny',
   tags:['nanny','nannyat','database','sql','oracle','plsql','pl/sql','procedure','trigger','cursor','sequence','view','join','window function','relational'],
   z:'DB VAULT',
   r:`NannyAtYourService is a relational database system in Oracle SQL and PL/SQL. It models parents, children, nannies, drivers, sessions, and payments. It uses stored procedures, triggers, sequences, cursors, views, complex multi-table joins, and window functions — demonstrating both DB design and query optimisation.`},

  {id:'ml',
   tags:['machine learning','ml','python','lol','league','scrape','classification','scikit','keras','regression','clustering','nlp','deep learning','xgboost','model','training','dataset','neural','ai','artificial'],
   z:'ML LAB',
   r:`Zakhir built a League of Legends Buff/Nerf analysis tool: scraped Riot Games patch notes with BeautifulSoup, parsed champion balance changes, and trained ML classification models to predict win-rate impact. He completed Machine Learning A-Z covering regression, classification, clustering, NLP, deep learning, and XGBoost.`},

  {id:'azure',
   tags:['azure','az-900','cloud','devops','pipeline','cicd','ci/cd','certif','microsoft','certified','build','release','deploy'],
   z:'DEVOPS CONTROL',
   r:`Zakhir holds a Microsoft Azure Fundamentals (AZ-900) certification. He has hands-on experience with Azure DevOps CI/CD pipelines — build, release, and version control workflows — gained during his WIL at COGENT. He values automated deployments and production stability.`},

  {id:'architecture',
   tags:['architect','architecture','design','pattern','monolith','microservice','mvc','event','philosophy','minimal','framework','intentional','modular'],
   z:'ARCH MUSEUM',
   r:`Zakhir prefers minimal, intentional system design. He evaluates whether a framework is justified before adding it. He thinks architecturally first, then writes clean modular code. This portfolio — a single HTML file with no build step — is itself a deliberate architectural choice: maximum portability, zero dependencies.`},

  {id:'cput',
   tags:['cput','university','diploma','degree','education','study','college','cape peninsula','ict','qualification','graduate'],
   z:null,
   r:`Zakhir completed a Diploma in ICT: Applications Development at the Cape Peninsula University of Technology (CPUT) in 2025. His academic work includes database systems, application development, and software engineering — supplemented by real-world projects and enterprise WIL.`},

  {id:'hire',
   tags:['hire','employ','recruit','available','job','role','position','opportunity','looking','seeking','why','worth'],
   z:null,
   r:`Zakhir is available immediately for junior software development roles in Cape Town or remote positions. He brings enterprise WIL experience, a custom-built game engine, full-stack projects, ML work, Oracle SQL depth, Azure DevOps exposure, and a demonstrated preference for building things that actually work — not just writing code.`},

  {id:'github',
   tags:['github','code','repo','repository','source','project','portfolio','link','profile'],
   z:null,
   r:`Zakhir's GitHub is github.com/flyinginsectsunpig. His projects include the game engine, PrintIt101, the LoL analysis tool, and the NannyAtYourService database system. This portfolio itself is the most comprehensive demonstration of his skills.`},

  {id:'rpa',
   tags:['rpa','blue prism','automation','robot','process','bot','workflow','document'],
   z:'DEVOPS CONTROL',
   r:`During his COGENT WIL, Zakhir worked on the Automation team designing Blue Prism RPA processes for document handling workflows. He understands how to model business processes as automatable sequences and integrate them with enterprise systems.`},

  {id:'javascript',
   tags:['javascript','typescript','js','ts','node','frontend','dom','browser','web'],
   z:null,
   r:`Zakhir works in JavaScript and TypeScript professionally. He used TypeScript to build his game engine against the raw browser Canvas API, and JavaScript throughout web projects. He understands the event loop, async/await, and DOM manipulation at a level deeper than most framework users.`},

  {id:'java',
   tags:['java','spring','springboot','backend','api','rest','server','maven','gradle'],
   z:null,
   r:`Zakhir's backend language is Java, specifically with Spring Boot. PrintIt101 uses a Spring Boot REST API with Builder and Factory patterns. Java was also the primary language in his CPUT coursework, giving him strong OOP foundations.`},

  {id:'csharp',
   tags:['c#','csharp','dotnet','.net','abp','abp framework','microsoft','enterprise','module'],
   z:'DEVOPS CONTROL',
   r:`Zakhir used C# with the ABP Framework during his COGENT WIL, building automation modules in a production enterprise codebase. ABP provides a modular application framework on top of ASP.NET Core — working within it required understanding dependency injection, domain-driven layers, and enterprise conventions.`},

  {id:'blockchain',
   tags:['blockchain','solidity','ethereum','smart contract','web3','crypto'],
   z:null,
   r:`Zakhir completed an Ethereum and Solidity bootcamp covering blockchain fundamentals, smart contract development, and decentralised application patterns. It's an area of exposure rather than deep specialisation.`},

  {id:'portfolio',
   tags:['portfolio','this','site','website','built','rpg','game mode','single file','html','how made','how did'],
   z:null,
   r:`This portfolio is a single HTML file with no build step, no dependencies, and no framework. It runs a tile-based RPG on a custom game engine, with live ML algorithms, a working SQL EXPLAIN visualiser, a DevOps simulator, and this chatbot — all in one file. It's a deliberate architectural choice: maximum portability, instant load, fully self-contained.`},

  {id:'projects',
   tags:['project','projects','built','made','created','work','what has','what did','show','example'],
   z:null,
   r:`Zakhir's main projects: (1) Custom 2D game engine — TypeScript, Canvas API, no frameworks. (2) PrintIt101 — React + Three.js + Spring Boot 3D platform. (3) NannyAtYourService — Oracle SQL/PL/SQL relational DB system. (4) LoL Buff/Nerf Viewer — Python scraping + ML classification. (5) This portfolio — single-file interactive RPG.`},

  {id:'strengths',
   tags:['strength','strong','good at','best','excel','stand out','unique','different','what makes','specialise'],
   z:null,
   r:`Zakhir's strongest areas: systems thinking applied to real projects (not just tutorials), deep SQL and database design, building things from scratch without framework scaffolding, and translating ML coursework into working tools. His enterprise WIL gave him production context that most graduates lack.`},

  {id:'weaknesses',
   tags:['weak','weakness','improve','learning','working on','gap','experience','junior','limited'],
   z:null,
   r:`Zakhir is early-career — he's honest about that. He's stronger in depth on specific systems than in breadth across every enterprise pattern. He's continuing to build production depth through real projects and learning-by-doing rather than credential collecting.`},

  {id:'contact',
   tags:['contact','email','reach','linkedin','message','talk','connect','get in touch','find'],
   z:null,
   r:`You can find Zakhir on GitHub at github.com/flyinginsectsunpig. He's open to roles in Cape Town or remote. The contact section in Normal Mode (toggle top-right) has his details.`},

  {id:'devops_depth',
   tags:['pipeline','stage','build step','deploy','rollback','ci','cd','container','docker','release strategy'],
   z:'DEVOPS CONTROL',
   r:`At COGENT, Zakhir worked with Azure DevOps multi-stage pipelines covering source control, build, test, and release. He understands rollback strategies, deployment gates, and the real operational cost of a broken pipeline. The DevOps zone in this portfolio simulates cascade failures and SLO burn rates — concepts he learnt in practice.`},

  {id:'nextzone',
   tags:['next','suggest','recommend','where','visit','see','zone','area','should i','what else'],
   z:null,
   r:null}, // handled dynamically below

  {id:'greeting',
   tags:['hello','hi','hey','greet','sup','good morning','good afternoon','howzit'],
   z:null,
   r:`Hey! I'm the Oracle — a local retrieval bot, no API needed. I know everything about Zakhir McKinnon. Ask me about his projects, skills, COGENT experience, or anything else. What would you like to know?`},

  {id:'thanks',
   tags:['thank','thanks','thx','appreciate','cheers','cool','great','awesome','nice'],
   z:null,
   r:`You're welcome. Anything else you'd like to know about Zakhir? I can go deeper on any project, skill, or experience.`},

  {id:'fallback',
   tags:[],
   z:null,
   r:null}, // catch-all
];

// ── Retrieval engine ──
function retrieveAnswer(q){
  const raw=q.toLowerCase().replace(/[?!.,;:]/g,'').trim();
  const words=raw.split(/\s+/);

  // ══════════════════════════════════════════════════════
  // GATE 1: Off-topic detector — runs BEFORE scoring
  // Catches anything clearly unrelated to Zakhir/his work
  // ══════════════════════════════════════════════════════

  // Math expressions: digits + operators, or explicit math words
  const mathPattern=/^[\d\s\+\-\*\/\^\(\)\.=]+$|^\d+\s*(plus|minus|times|divided|mod|squared|equals)/;
  if(mathPattern.test(raw)||/^what is \d|^\d+ [\+\-\*\/]|\bsolve\b|\bcalculate\b|\bequation\b/.test(raw)){
    return `I only answer questions about Zakhir McKinnon. I don't do general computation — try a calculator for that. Ask me about his projects, experience, or skills instead.`;
  }

  // General knowledge / geography / history / science / trivia
  const generalKnowledge=[
    /\bcapital (of|city)\b/,/\bwho (won|is the president|is the prime|invented|discovered|wrote|painted|founded|created)\b/,
    /\bwhen (was|did|were|is)\b.*\b(born|founded|built|invented|discovered|war|battle|signed|published)\b/,
    /\bwhere is\b.*\b(located|country|city|river|mountain|ocean|sea)\b/,
    /\bhow (far|tall|big|old|many people|many countries|long is|wide is)\b/,
    /\bworld cup\b|\bolympics\b|\bworld series\b|\bnba finals\b|\bsuper bowl\b|\bwimbledon\b|\bchampions league\b/,
    /\bpopulation of\b|\bcurrency of\b|\blanguage of\b|\bflag of\b/,
    /\b(france|germany|england|usa|america|china|japan|india|brazil|australia|africa|europe|asia)\b(?! framework| devops| company)/,
    /\bpresident\b|\bprime minister\b|\bking\b|\bqueen\b|\bceo of\b(?! cogent)/,
    /\b(einstein|newton|darwin|shakespeare|napoleon|gandhi|mandela|tesla|picasso|beethoven)\b/,
    /\b(planet|galaxy|universe|solar system|atom|molecule|dna|cell|evolution|photosynthesis)\b/,
    /\b(recipe|ingredients|cook|bake|temperature|degrees celsius|degrees fahrenheit)\b/,
    /\b(movie|film|series|netflix|tv show|actor|actress|director|oscar|grammy|emmy)\b/,
    /\b(song|lyrics|album|band|singer|musician|spotify|artist)\b(?!.*zakhir)/,
    /\b(stock|share price|bitcoin|crypto|market cap|dow jones|s&p|nasdaq)\b/,
    /\b(weather|forecast|temperature today|rain|humidity|wind speed)\b/,
    /\b(translate|translation|how do you say|what does .* mean in)\b/,
  ];
  for(const pattern of generalKnowledge){
    if(pattern.test(raw)){
      return `That's outside my scope — I'm a dedicated bot for Zakhir McKinnon's portfolio. I don't have general knowledge. Ask me about his tech stack, projects, COGENT WIL, or experience.`;
    }
  }

  // Creative writing requests
  const creativePattern=/\bwrite (me |a |an |the )?(poem|story|essay|haiku|song|rap|letter|email|speech|limerick|sonnet|code for)\b|\btell me a joke\b|\bgive me a recipe\b|\bsuggest a name\b/;
  if(creativePattern.test(raw)){
    return `I'm not a general writing assistant — I'm built specifically to answer questions about Zakhir McKinnon. Try asking "What projects has he built?" or "Why should we hire Zakhir?"`;
  }

  // Opinion / philosophical / hypothetical not about Zakhir
  const opinionPattern=/\bdo you (think|believe|feel|like|prefer|recommend)\b(?!.*zakhir)|\bwhat (do you think|is your opinion|is better|is best|is the meaning)\b(?!.*zakhir)|\bhow do i\b(?!.*find|.*contact|.*reach)|\btips for\b(?!.*hiring|.*recruit)/;
  if(opinionPattern.test(raw)&&!raw.includes('zakhir')&&!raw.includes('hire')&&!raw.includes('recrui')){
    return `I'm only equipped to talk about Zakhir McKinnon — his work, skills, and experience. I can't give general opinions or advice. Ask me something specific about him.`;
  }

  // Greetings are fine — let them through to the greeting intent
  // ══════════════════════════════════════════════════════
  // END GATE 1
  // ══════════════════════════════════════════════════════

  // Dynamic: zone suggestion
  if(KB.find(k=>k.id==='nextzone').tags.some(t=>raw.includes(t))){
    const unvisited=['ML LAB','ENGINE ARENA','DB VAULT','DEVOPS CONTROL','ARCH MUSEUM','PROBLEM ARENA']
      .filter(z=>!zoneVisitLog.includes(z));
    if(unvisited.length>0){
      const rec=unvisited[0];
      const desc={
        'ML LAB':'live ML algorithms — linear regression, K-NN, K-Means — running in your browser',
        'ENGINE ARENA':'the custom 2D game engine with frame profiler and ECS inspector',
        'DB VAULT':'real Oracle SQL with live EXPLAIN plans and index impact simulator',
        'DEVOPS CONTROL':'CI/CD pipeline simulation with cascade failures and SLO burn rates',
        'ARCH MUSEUM':'architecture trade-off cards with animated latency visualiser',
        'PROBLEM ARENA':'real engineering scenarios — how Zakhir actually diagnoses problems'
      }[rec]||'explore next';
      return `Based on what you've seen so far, try the ${rec} — it has ${desc}.`;
    }
    return `You've explored the main zones. The Secret Room (top-left corner of the map) has one more thing worth finding.`;
  }

  // Score each intent
  const scores=KB.filter(k=>k.id!=='fallback'&&k.id!=='nextzone').map(intent=>{
    let score=0;
    // Exact phrase matches (high weight)
    intent.tags.forEach(tag=>{
      if(raw.includes(tag)) score+=tag.split(' ').length*3; // multi-word tags score higher
    });
    // Word-level partial matches
    words.forEach(w=>{
      if(w.length<3) return;
      intent.tags.forEach(tag=>{
        if(tag.includes(w)||w.includes(tag)) score+=1;
      });
    });
    // Zone bias: if current zone matches intent zone, boost
    if(intent.z&&lastZone&&lastZone.includes(intent.z.split(' ')[0])) score+=2;
    return{intent,score};
  }).sort((a,b)=>b.score-a.score);

  const best=scores[0];
  if(best&&best.score>=2&&best.intent.r){
    return best.intent.r;
  }

  // Fuzzy fallback — try to extract meaningful keywords
  const keyTerms=['project','skill','experience','work','build','code','tool','language','framework','certif'];
  const matched=keyTerms.find(k=>raw.includes(k));
  if(matched){
    return `I'm not sure exactly what you're asking about "${raw.slice(0,40)}", but if you're asking about Zakhir's ${matched}s — try one of the quick buttons above, or rephrase and I'll do my best.`;
  }

  return `I didn't quite catch that. I'm a local knowledge bot — I know Zakhir's projects, skills, experience, and background. Try asking something like "What projects has he built?" or "Tell me about COGENT" or use the quick buttons above.`;
}

const chatHistory=[];

function buildChat(){
  const visitedCtx=zoneVisitLog.length>0?`Explored: ${zoneVisitLog.join(', ')}.`:'Just arrived.';
  const glowCol=getOracleGlow();
  return `<div>
<div style="font-family:'VT323',monospace;font-size:15px;color:var(--dim);margin-bottom:5px;border-left:2px solid ${glowCol};padding-left:7px;">Zone: <span style="color:${glowCol}">${lastZone||'TOWN SQUARE'}</span> · ${visitedCtx}</div>
<div style="font-family:'VT323',monospace;font-size:14px;color:var(--dim);margin-bottom:7px;padding:3px 7px;border:1px solid #1a1030;background:#03030c;">
⚡ LOCAL BOT — zero API · zero cost · instant · works offline
</div>
<div id="chat-msgs">
<div class="cmsg bot"><div class="cwho">ORACLE.EXE</div>Greetings. I'm a local retrieval bot — no API, no latency, no cost. I know everything about Zakhir. Ask about his projects, skills, COGENT WIL, or anything else.</div>
</div>
<div class="qgrid">
<button class="qb" onclick="askQ('What is his tech stack?')">Tech stack</button>
<button class="qb" onclick="askQ('Tell me about COGENT WIL')">COGENT WIL</button>
<button class="qb" onclick="askQ('What projects has he built?')">Projects</button>
<button class="qb" onclick="askQ('How deep is his ML knowledge?')">ML depth</button>
<button class="qb" onclick="askQ('Why should we hire Zakhir?')">Why hire?</button>
<button class="qb" onclick="askQ('What zone should I visit next?')">What next?</button>
</div>
<div class="crow" style="margin-top:8px;">
<input class="cinp" id="ci" placeholder="Ask anything about Zakhir..." onkeydown="if(event.key==='Enter')sendQ()">
<button class="csnd" onclick="sendQ()">SEND ▶</button>
</div>
</div>`;}

function sendQ(){const i=document.getElementById('ci');const q=i.value.trim();if(!q)return;i.value='';askQ(q);}

function askQ(q){
  tlog(`chatbot.query  q="${q.slice(0,40)}"`);
  addCM('usr',q);
  chatHistory.push({role:'user',q});

  // Retrieve answer
  const answer=retrieveAnswer(q);

  // Simulate typing with a short delay and character-by-character reveal
  const el=addCM('bot','▌');
  const span=el.querySelector('.ct');
  let i=0;
  const SPEED=18; // ms per character
  function typeChar(){
    if(i<answer.length){
      span.textContent=answer.slice(0,i+1)+(i<answer.length-1?'▌':'');
      i++;
      const cm=document.getElementById('chat-msgs');
      if(cm) cm.scrollTop=cm.scrollHeight;
      setTimeout(typeChar,SPEED+(answer[i-1]==='.'||answer[i-1]===','?120:0));
    } else {
      span.textContent=answer;
    }
  }
  // Small initial pause so it feels considered, not instant
  setTimeout(typeChar,120);

  chatHistory.push({role:'bot',q:answer});
  tlog(`chatbot.retrieved  chars=${answer.length}`);
}

function addCM(role,txt){
  const cm=document.getElementById('chat-msgs');
  const el=document.createElement('div');el.className=`cmsg ${role}`;
  el.innerHTML=`<div class="cwho">${role==='usr'?'YOU':'ORACLE.EXE'}</div><span class="ct">${txt}</span>`;
  cm.appendChild(el);cm.scrollTop=cm.scrollHeight;return el;
}

// ═══════════════════════════════════════════════════════════
// ML LAB — R², K-Means++, Train/Test split
// ═══════════════════════════════════════════════════════════
let mlM='linear',mlPts=[],mlKls=0,mlCtx2=null,mlCv=null,useKMPP=false;

const ML_INFO={
  linear:'OLS LINEAR REGRESSION — Click to place points. Fits y=mx+b by minimising Σ(yᵢ-ŷᵢ)². R² measures goodness of fit (1.0=perfect). RMSE shows average error magnitude. Residual lines shown in orange.',
  poly:'POLYNOMIAL REGRESSION (degree 3) — Points randomly assigned train (green) / test (orange) at 80/20 split. Fit on train only. Train RMSE vs Test RMSE reveals overfitting — watch them diverge as you add clustered points.',
  knn:'K-NN CLASSIFICATION (k=3) — Alternating class-0 (blue) / class-1 (red). Background shows full decision boundary recomputed after each click. Majority vote of 3 nearest neighbours determines each region.',
  kmeans:'K-MEANS CLUSTERING (K=3) — Naive init uses first 3 points (sensitive to order). K-Means++ init uses D² weighting for smarter centroid seeding. Toggle to compare convergence quality on the same data.'
};

function buildML(){return `<div>
<div class="ml-tabs">
<button class="ml-tab on" id="tl" onclick="setML('linear')">Linear Reg</button>
<button class="ml-tab" id="tp" onclick="setML('poly')">Poly + Train/Test</button>
<button class="ml-tab" id="tk" onclick="setML('knn')">K-NN</button>
<button class="ml-tab" id="tm" onclick="setML('kmeans')">K-Means</button>
</div>
<canvas id="ml-c" width="680" height="240"></canvas>
<div class="mbtns">
<button class="mb" onclick="mlPts=[];mlKls=0;mlDraw()">✕ Clear</button>
<button class="mb" id="mb-kpp" onclick="toggleKMPP()" style="display:none">K-Means++ OFF</button>
<button class="mb" id="mb-src" onclick="toggleMLSrc()" style="border-color:#4fc3f7;color:#4fc3f7">📎 source</button>
<span id="ml-eq"></span>
</div>
<div class="ml-metrics" id="ml-metrics"></div>
<div id="ml-src" style="display:none;font-family:'VT323',monospace;font-size:12px;background:#030812;border:2px solid #1a3040;border-left:3px solid #4fc3f7;padding:9px 11px;margin-top:6px;white-space:pre;color:#7dd3fc;line-height:1.6;overflow-x:auto;"></div>
<div class="minfo" id="ml-inf">${ML_INFO.linear}</div>
</div>`;}

const ML_SOURCE={
  linear:`// OLS: β = (XᵀX)⁻¹Xᵀy — simplified for y = mx + b
const n = pts.length;
const mx = pts.reduce((s,p) => s+p.x, 0) / n;
const my = pts.reduce((s,p) => s+p.y, 0) / n;
// Numerator = Σ(xᵢ-x̄)(yᵢ-ȳ), Denominator = Σ(xᵢ-x̄)²
const num = pts.reduce((s,p) => s + (p.x-mx)*(p.y-my), 0);
const den = pts.reduce((s,p) => s + (p.x-mx)**2, 0);
const slope = num / den;
const intercept = my - slope * mx;
// R² = 1 - SS_res/SS_tot
const ssTot = pts.reduce((s,p) => s + (p.y-my)**2, 0);
const ssRes = pts.reduce((s,p) => s + (p.y-(slope*p.x+intercept))**2, 0);
const r2 = 1 - ssRes/ssTot;  // 1.0 = perfect fit`,
  poly:`// Train/test split: 80% train (green), 20% test (orange)
const {train, test} = pts.reduce((acc, p) => {
  acc[Math.random() < 0.8 ? 'train' : 'test'].push(p); return acc;
}, {train:[], test:[]});
// Polynomial features [1, x, x², x³], solve normal equations
const X = train.map(p => [1, p.x/w, (p.x/w)**2, (p.x/w)**3]);
const coeffs = polyFit(X, train.map(p=>p.y), 4); // Gaussian elim
// Evaluate on held-out test set — reveals generalisation gap
const testRMSE = Math.sqrt(test.reduce((s,p) => {
  const t = p.x/w;
  const yHat = coeffs[0]+coeffs[1]*t+coeffs[2]*t**2+coeffs[3]*t**3;
  return s + (p.y - yHat)**2;
}, 0) / test.length);  // High testRMSE vs trainRMSE = overfitting`,
  knn:`// K-NN: no training phase — lazy learner
// Decision boundary: classify each pixel by majority vote
for (let x=0; x<w; x+=8) for (let y=0; y<h; y+=8) {
  const kNearest = pts
    .map(p => ({ d: Math.hypot(p.x-x, p.y-y), cls: p.cls }))
    .sort((a,b) => a.d - b.d)
    .slice(0, k);  // k=3
  const votes = kNearest.filter(n => n.cls===1).length;
  // Majority vote — ties break toward class-0
  ctx.fillStyle = votes > k/2 ? 'red-tint' : 'blue-tint';
  ctx.fillRect(x,y,8,8);
}`,
  kmeans:`// K-Means: iterative EM algorithm
let centroids = kmeansInit(pts, K);  // naive or K-Means++
let assignments = new Array(pts.length).fill(0);
let converged = false, iters = 0;
while (!converged && iters < 25) {
  converged = true; iters++;
  // E-step: assign each point to nearest centroid
  for (let i=0; i<pts.length; i++) {
    const nearest = centroids.reduce((best,c,k) =>
      (dist(pts[i],c) < dist(pts[i],centroids[best])) ? k : best, 0);
    if (assignments[i] !== nearest) { assignments[i]=nearest; converged=false; }
  }
  // M-step: recompute centroid from cluster mean
  centroids = centroids.map((_,k) => {
    const cluster = pts.filter((_,i) => assignments[i]===k);
    return cluster.length > 0
      ? { x: mean(cluster,'x'), y: mean(cluster,'y') }
      : centroids[k];
  });
}
// K-Means++ init: D² weighted seeding (avoids bad initialisation)
// scikit-learn uses this by default — reduces iteration count ~30%`
};

let mlSrcVisible=false;
function toggleMLSrc(){
  mlSrcVisible=!mlSrcVisible;
  const el=document.getElementById('ml-src');
  const btn=document.getElementById('mb-src');
  if(!el||!btn)return;
  el.style.display=mlSrcVisible?'block':'none';
  el.textContent=ML_SOURCE[mlM]||'// No source for this mode';
  btn.textContent=mlSrcVisible?'📎 hide src':'📎 source';
  if(mlSrcVisible) el.scrollIntoView({behavior:'smooth',block:'nearest'});
  tlog(`ml.source_view  algorithm=${mlM}  visible=${mlSrcVisible}`);
}
function initML(){
  mlCv=document.getElementById('ml-c');if(!mlCv)return;
  mlCtx2=mlCv.getContext('2d');mlCv.addEventListener('click',mlClick);mlDraw();
}

function setML(m){
  mlM=m;mlPts=[];mlKls=0;
  document.querySelectorAll('.ml-tab').forEach(t=>t.classList.remove('on'));
  document.getElementById({'linear':'tl','poly':'tp','knn':'tk','kmeans':'tm'}[m])?.classList.add('on');
  document.getElementById('ml-inf').textContent=ML_INFO[m]||'';
  document.getElementById('ml-eq').textContent='';
  document.getElementById('ml-metrics').innerHTML='';
  const kppBtn=document.getElementById('mb-kpp');
  if(kppBtn) kppBtn.style.display=m==='kmeans'?'':'none';
  // Refresh source panel if open
  const srcEl=document.getElementById('ml-src');
  if(srcEl&&mlSrcVisible) srcEl.textContent=ML_SOURCE[m]||'// No source for this mode';
  tlog(`ml.mode_changed  algorithm=${m}`);
  mlDraw();
}

function toggleKMPP(){
  useKMPP=!useKMPP;
  const btn=document.getElementById('mb-kpp');
  if(btn){btn.textContent=`K-Means++ ${useKMPP?'ON':'OFF'}`;btn.classList.toggle('active',useKMPP);}
  tlog(`ml.kmeans_init  method=${useKMPP?'kmeanspp':'naive'}`);
  mlDraw();
}

function mlClick(e){
  const rc=mlCv.getBoundingClientRect();
  const x=(e.clientX-rc.left)*(mlCv.width/rc.width),y=(e.clientY-rc.top)*(mlCv.height/rc.height);
  if(mlM==='knn'){mlPts.push({x,y,cls:mlKls});mlKls=1-mlKls;}
  else if(mlM==='poly'){mlPts.push({x,y,split:Math.random()<.8?'train':'test'});}
  else mlPts.push({x,y});
  tlog(`ml.point_added  algorithm=${mlM}  n=${mlPts.length}`);
  mlDraw();
}

function mlDraw(){
  if(!mlCtx2)return;
  const w=mlCv.width,h=mlCv.height;
  mlCtx2.fillStyle='#050510';mlCtx2.fillRect(0,0,w,h);
  mlCtx2.strokeStyle='#1a1030';mlCtx2.lineWidth=1;
  for(let x=0;x<w;x+=40){mlCtx2.beginPath();mlCtx2.moveTo(x,0);mlCtx2.lineTo(x,h);mlCtx2.stroke();}
  for(let y=0;y<h;y+=40){mlCtx2.beginPath();mlCtx2.moveTo(0,y);mlCtx2.lineTo(w,y);mlCtx2.stroke();}
  if(mlM==='linear') mlLinear(w,h);
  else if(mlM==='poly') mlPoly(w,h);
  else if(mlM==='knn') mlKNN(w,h);
  else mlKM(w,h);
}

function mlHint(w,h,t){mlCtx2.fillStyle='rgba(61,220,132,.25)';mlCtx2.font='13px VT323,monospace';mlCtx2.textAlign='center';mlCtx2.fillText(t,w/2,h/2);}

function setMetric(html){const el=document.getElementById('ml-metrics');if(el)el.innerHTML=html;}

function mlLinear(w,h){
  mlPts.forEach(p=>{mlCtx2.fillStyle='#3ddc84';mlCtx2.shadowColor='#3ddc84';mlCtx2.shadowBlur=8;mlCtx2.beginPath();mlCtx2.arc(p.x,p.y,5,0,Math.PI*2);mlCtx2.fill();mlCtx2.shadowBlur=0;});
  if(mlPts.length<2){mlHint(w,h,'Click to add data points');setMetric('');document.getElementById('ml-eq').textContent='';return;}
  const n=mlPts.length,mx=mlPts.reduce((s,p)=>s+p.x,0)/n,my=mlPts.reduce((s,p)=>s+p.y,0)/n;
  const num=mlPts.reduce((s,p)=>s+(p.x-mx)*(p.y-my),0),den=mlPts.reduce((s,p)=>s+(p.x-mx)**2,0);
  if(!den)return;
  const m=num/den,b=my-m*mx;
  mlCtx2.strokeStyle='#4fc3f7';mlCtx2.lineWidth=2;mlCtx2.shadowColor='#4fc3f7';mlCtx2.shadowBlur=8;
  mlCtx2.beginPath();mlCtx2.moveTo(0,b);mlCtx2.lineTo(w,m*w+b);mlCtx2.stroke();mlCtx2.shadowBlur=0;
  mlCtx2.strokeStyle='rgba(255,140,50,.5)';mlCtx2.lineWidth=1;
  mlPts.forEach(p=>{mlCtx2.beginPath();mlCtx2.moveTo(p.x,p.y);mlCtx2.lineTo(p.x,m*p.x+b);mlCtx2.stroke();});
  // R² and RMSE
  const yMean=my;
  const ssTot=mlPts.reduce((s,p)=>s+(p.y-yMean)**2,0);
  const ssRes=mlPts.reduce((s,p)=>s+(p.y-(m*p.x+b))**2,0);
  const r2=ssTot>0?1-ssRes/ssTot:0;
  const rmse=Math.sqrt(ssRes/n);
  const r2col=r2>.8?'#3ddc84':r2>.5?'#ffb74d':'#f44336';
  document.getElementById('ml-eq').textContent=`y=${m.toFixed(3)}x+${b.toFixed(1)}`;
  setMetric(`<span class="ml-metric" style="border-color:${r2col};color:${r2col}">R² = ${r2.toFixed(3)}</span><span class="ml-metric" style="border-color:#4fc3f7;color:#4fc3f7">RMSE = ${rmse.toFixed(1)}</span><span class="ml-metric" style="border-color:var(--dim);color:var(--dim)">n = ${n}</span>`);
}

function mlPoly(w,h){
  const train=mlPts.filter(p=>p.split==='train');
  const test=mlPts.filter(p=>p.split==='test');
  train.forEach(p=>{mlCtx2.fillStyle='#3ddc84';mlCtx2.shadowColor='#3ddc84';mlCtx2.shadowBlur=8;mlCtx2.beginPath();mlCtx2.arc(p.x,p.y,5,0,Math.PI*2);mlCtx2.fill();mlCtx2.shadowBlur=0;});
  test.forEach(p=>{mlCtx2.fillStyle='#ffb74d';mlCtx2.shadowColor='#ffb74d';mlCtx2.shadowBlur=8;mlCtx2.beginPath();mlCtx2.arc(p.x,p.y,5,0,Math.PI*2);mlCtx2.fill();mlCtx2.shadowBlur=0;
    // X mark for test
    mlCtx2.strokeStyle='#ff6600';mlCtx2.lineWidth=1.5;
    mlCtx2.beginPath();mlCtx2.moveTo(p.x-5,p.y-5);mlCtx2.lineTo(p.x+5,p.y+5);mlCtx2.moveTo(p.x+5,p.y-5);mlCtx2.lineTo(p.x-5,p.y+5);mlCtx2.stroke();
  });
  if(train.length<4){mlHint(w,h,'Add 4+ points (80% train ● green · 20% test ✕ orange)');setMetric('');return;}
  const X=train.map(p=>[1,p.x/w,(p.x/w)**2,(p.x/w)**3]),Y=train.map(p=>p.y);
  const c=polyFit(X,Y,4);if(!c)return;
  mlCtx2.strokeStyle='#ce93d8';mlCtx2.lineWidth=2;mlCtx2.shadowColor='#ce93d8';mlCtx2.shadowBlur=8;
  mlCtx2.beginPath();
  for(let x=0;x<=w;x+=2){const t=x/w,y=c[0]+c[1]*t+c[2]*t**2+c[3]*t**3;x===0?mlCtx2.moveTo(x,y):mlCtx2.lineTo(x,y);}
  mlCtx2.stroke();mlCtx2.shadowBlur=0;
  const trainRMSE=Math.sqrt(train.reduce((s,p)=>{const t=p.x/w,y=c[0]+c[1]*t+c[2]*t**2+c[3]*t**3;return s+(p.y-y)**2;},0)/train.length);
  let testRMSE=null,overfit='';
  if(test.length>0){
    testRMSE=Math.sqrt(test.reduce((s,p)=>{const t=p.x/w,y=c[0]+c[1]*t+c[2]*t**2+c[3]*t**3;return s+(p.y-y)**2;},0)/test.length);
    const ratio=testRMSE/(trainRMSE+.001);
    overfit=ratio>2?'OVERFITTING':ratio>1.3?'SLIGHT OVERFIT':'GENERALISING';
  }
  document.getElementById('ml-eq').textContent=`Degree-3 Polynomial`;
  const testHtml=testRMSE!==null?`<span class="ml-metric" style="border-color:#ffb74d;color:#ffb74d">Test RMSE=${testRMSE.toFixed(1)}</span><span class="ml-metric" style="border-color:${overfit==='OVERFITTING'?'#f44336':overfit==='SLIGHT OVERFIT'?'#ffb74d':'#3ddc84'};color:${overfit==='OVERFITTING'?'#f44336':overfit==='SLIGHT OVERFIT'?'#ffb74d':'#3ddc84'}">${overfit}</span>`:'';
  setMetric(`<span class="ml-metric" style="border-color:#3ddc84;color:#3ddc84">Train RMSE=${trainRMSE.toFixed(1)}</span>${testHtml}<span class="ml-metric" style="border-color:var(--dim);color:var(--dim)">n=${mlPts.length} (${train.length}tr/${test.length}te)</span>`);
}

function mlKNN(w,h){
  if(mlPts.length>1){
    const step=8,k=3;
    for(let x=0;x<w;x+=step) for(let y=0;y<h;y+=step){
      const ds=mlPts.map(p=>({d:Math.hypot(p.x-x,p.y-y),cls:p.cls})).sort((a,b)=>a.d-b.d).slice(0,k);
      const v=ds.reduce((s,d)=>s+d.cls,0);
      mlCtx2.fillStyle=v>ds.length/2?'rgba(244,67,54,.1)':'rgba(79,195,247,.1)';
      mlCtx2.fillRect(x,y,step,step);
    }
  }
  mlPts.forEach(p=>{
    const c=p.cls===0?'#4fc3f7':'#f44336';
    mlCtx2.fillStyle=c;mlCtx2.shadowColor=c;mlCtx2.shadowBlur=10;
    mlCtx2.beginPath();mlCtx2.arc(p.x,p.y,6,0,Math.PI*2);mlCtx2.fill();mlCtx2.shadowBlur=0;
  });
  if(mlPts.length<2) mlHint(w,h,'Click: class-0 blue → class-1 red → blue...');
  const c0=mlPts.filter(p=>p.cls===0).length,c1=mlPts.filter(p=>p.cls===1).length;
  document.getElementById('ml-eq').textContent=`k=3`;
  setMetric(`<span class="ml-metric" style="border-color:#4fc3f7;color:#4fc3f7">Class-0: ${c0}</span><span class="ml-metric" style="border-color:#f44336;color:#f44336">Class-1: ${c1}</span><span class="ml-metric" style="border-color:var(--dim);color:var(--dim)">n=${mlPts.length}</span>`);
}

function kmeansInit(pts,K){
  if(!useKMPP) return pts.slice(0,K).map(p=>({x:p.x,y:p.y}));
  // K-Means++ — D² weighted init
  const cents=[{x:pts[Math.floor(Math.random()*pts.length)].x,y:pts[Math.floor(Math.random()*pts.length)].y}];
  while(cents.length<K){
    const dists=pts.map(p=>Math.min(...cents.map(c=>(p.x-c.x)**2+(p.y-c.y)**2)));
    const sum=dists.reduce((a,b)=>a+b,0);
    let r=Math.random()*sum;
    for(let i=0;i<pts.length;i++){r-=dists[i];if(r<=0){cents.push({x:pts[i].x,y:pts[i].y});break;}}
  }
  return cents;
}

function mlKM(w,h){
  const K=3,cols=['#3ddc84','#4fc3f7','#ffb74d'];
  if(mlPts.length<K){mlHint(w,h,'Add 3+ points to cluster');setMetric('');return;}
  let cents=kmeansInit(mlPts,K);
  let asgn=new Array(mlPts.length).fill(0);
  let iters=0;
  for(let it=0;it<25;it++){
    let changed=false;
    for(let i=0;i<mlPts.length;i++){let min=Infinity,best=0;cents.forEach((c,k)=>{const d=(mlPts[i].x-c.x)**2+(mlPts[i].y-c.y)**2;if(d<min){min=d;best=k;}});if(asgn[i]!==best){asgn[i]=best;changed=true;}}
    for(let k=0;k<K;k++){const pts=mlPts.filter((_,i)=>asgn[i]===k);if(pts.length>0)cents[k]={x:pts.reduce((s,p)=>s+p.x,0)/pts.length,y:pts.reduce((s,p)=>s+p.y,0)/pts.length};}
    iters++;if(!changed)break;
  }
  // Draw Voronoi background
  for(let x=0;x<w;x+=8) for(let y=0;y<h;y+=8){
    let min=Infinity,best=0;
    cents.forEach((c,k)=>{const d=(x-c.x)**2+(y-c.y)**2;if(d<min){min=d;best=k;}});
    mlCtx2.fillStyle=cols[best]+'18';mlCtx2.fillRect(x,y,8,8);
  }
  mlPts.forEach((p,i)=>{const c=cols[asgn[i]];mlCtx2.fillStyle=c;mlCtx2.shadowColor=c;mlCtx2.shadowBlur=8;mlCtx2.beginPath();mlCtx2.arc(p.x,p.y,5,0,Math.PI*2);mlCtx2.fill();mlCtx2.shadowBlur=0;});
  cents.forEach((c,k)=>{
    mlCtx2.strokeStyle='#fff';mlCtx2.lineWidth=2;mlCtx2.shadowColor=cols[k];mlCtx2.shadowBlur=16;
    mlCtx2.fillStyle=cols[k];mlCtx2.beginPath();mlCtx2.arc(c.x,c.y,11,0,Math.PI*2);mlCtx2.fill();mlCtx2.stroke();
    mlCtx2.shadowBlur=0;mlCtx2.fillStyle='#000';mlCtx2.font='bold 11px monospace';mlCtx2.textAlign='center';mlCtx2.textBaseline='middle';mlCtx2.fillText('✕',c.x,c.y);mlCtx2.textBaseline='alphabetic';
  });
  document.getElementById('ml-eq').textContent=`K=3  init=${useKMPP?'K-Means++':'Naive'}`;
  const sizeStr=Array.from({length:K},(_,k)=>mlPts.filter((_,i)=>asgn[i]===k).length).join('/');
  setMetric(`<span class="ml-metric" style="border-color:#3ddc84;color:#3ddc84">Iters: ${iters}</span><span class="ml-metric" style="border-color:#4fc3f7;color:#4fc3f7">Sizes: ${sizeStr}</span><span class="ml-metric" style="border-color:${useKMPP?'#3ddc84':'var(--dim)'};color:${useKMPP?'#3ddc84':'var(--dim)'}">Init: ${useKMPP?'K-Means++':'Naive'}</span>`);
}

function polyFit(X,Y,n){
  try{
    const XtX=Array.from({length:n},(_,i)=>Array.from({length:n},(_,j)=>X.reduce((s,r)=>s+r[i]*r[j],0)));
    const XtY=Array.from({length:n},(_,i)=>X.reduce((s,r,k)=>s+r[i]*Y[k],0));
    const M=XtX.map((r,i)=>[...r,XtY[i]]);
    for(let i=0;i<n;i++){
      let mx=i;for(let j=i+1;j<n;j++)if(Math.abs(M[j][i])>Math.abs(M[mx][i]))mx=j;
      [M[i],M[mx]]=[M[mx],M[i]];
      if(Math.abs(M[i][i])<1e-10)return null;
      for(let j=i+1;j<n;j++){const f=M[j][i]/M[i][i];for(let k=i;k<=n;k++)M[j][k]-=f*M[i][k];}
    }
    const x=new Array(n);
    for(let i=n-1;i>=0;i--){x[i]=M[i][n];for(let j=i+1;j<n;j++)x[i]-=M[i][j]*x[j];x[i]/=M[i][i];}
    return x;
  }catch{return null;}
}

// ═══════════════════════════════════════════════════════════
// DATABASE VAULT — EXPLAIN plan + Index toggle
// ═══════════════════════════════════════════════════════════
const dbIndexes={
  'sessions.nanny_id':{on:true,improve:94},
  'sessions.status':{on:false,improve:67},
  'sessions.session_date':{on:true,improve:88},
  'nannies.hourly_rate':{on:false,improve:45}
};

function buildDB(){return `<div>
<p style="font-family:'VT323',monospace;font-size:13px;color:var(--dim);margin-bottom:9px;line-height:1.4;">Real SQL from NannyAtYourService. Click a query to execute. Each result includes a simulated EXPLAIN plan — see what the DB actually does with your SQL.</p>
<div style="background:#030812;border:2px solid #1a1030;padding:9px 11px;margin-bottom:8px;">
<div style="font-family:'Press Start 2P',monospace;font-size:8px;color:var(--orange);margin-bottom:7px;letter-spacing:1px;">▶ INDEX CONTROL — toggle to see query time impact</div>
<div id="idx-panel"></div>
</div>
<div style="background:#030812;border:2px solid #1a1030;padding:9px 11px;margin-bottom:8px;">
<div style="font-family:'Press Start 2P',monospace;font-size:8px;color:var(--orange);margin-bottom:8px;letter-spacing:1px;">▶ TRANSACTION ISOLATION DEMONSTRATOR</div>
<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px;">
${['READ UNCOMMITTED','READ COMMITTED','REPEATABLE READ','SERIALIZABLE'].map((l,i)=>`<button onclick="setIsolation(${i})" id="iso-btn-${i}" style="font-family:'Press Start 2P',monospace;font-size:5px;background:${i===1?'#ffb74d':'#050510'};color:${i===1?'#050510':'#ffb74d'};border:2px solid #ffb74d;padding:4px 7px;cursor:pointer;">${l}</button>`).join('')}
</div>
<div id="iso-display" style="font-family:'VT323',monospace;font-size:15px;line-height:1.6;"></div>
</div>
<div class="sqb" onclick="runSQL(this,'j')"><span class="slb">// 4-TABLE JOIN WITH CALCULATED COLUMN</span>SELECT s.session_id, s.session_date,
       n.name AS nanny_name, p.name AS parent_name,
       c.name AS child_name, s.hours,
       (s.hours * s.hourly_rate) AS total_fee
FROM sessions s
  JOIN nannies  n ON s.nanny_id  = n.id
  JOIN parents  p ON s.parent_id = p.id
  JOIN children c ON s.child_id  = c.id
WHERE s.status = 'ACTIVE'
ORDER BY s.session_date DESC;</div>
<div class="sqr" id="r-j"></div>
<div class="sqb" onclick="runSQL(this,'s')"><span class="slb">// CORRELATED SUBQUERY — ABOVE-AVERAGE NANNIES</span>SELECT n.name, n.hourly_rate, n.rating,
       ROUND(n.hourly_rate - avg_r.avg_rate, 2) AS above_avg_by
FROM nannies n
CROSS JOIN (SELECT AVG(hourly_rate) AS avg_rate FROM nannies) avg_r
WHERE n.hourly_rate > avg_r.avg_rate
ORDER BY n.hourly_rate DESC;</div>
<div class="sqr" id="r-s"></div>
<div class="sqb" onclick="runSQL(this,'w')"><span class="slb">// WINDOW FUNCTION — RUNNING PAYMENT TOTALS</span>SELECT p.name, pay.amount, pay.payment_date,
       SUM(pay.amount) OVER (
         PARTITION BY pay.parent_id
         ORDER BY pay.payment_date
         ROWS UNBOUNDED PRECEDING
       ) AS running_total
FROM payments pay JOIN parents p ON pay.parent_id = p.id;</div>
<div class="sqr" id="r-w"></div>
<div class="sqb" onclick="runSQL(this,'p')"><span class="slb">// STORED PROCEDURE WITH SEQUENCE + ERROR HANDLING</span>CREATE OR REPLACE PROCEDURE book_session(
  p_nanny_id INT, p_parent_id INT,
  p_child_id INT, p_date DATE, p_hours INT
) AS BEGIN
  IF NOT is_nanny_available(p_nanny_id, p_date) THEN
    RAISE_APPLICATION_ERROR(-20001, 'Nanny unavailable');
  END IF;
  INSERT INTO sessions VALUES (
    sessions_seq.NEXTVAL, p_nanny_id, p_parent_id,
    p_child_id, p_date, p_hours, 'PENDING', SYSDATE
  );
  COMMIT;
END;</div>
<div class="sqr" id="r-p"></div>
</div>`;}

function renderIdxPanel(){
  const el=document.getElementById('idx-panel');if(!el)return;
  // Show comparative timing for the join query (most affected)
  const allOn=Object.values(dbIndexes).every(v=>v.on);
  const allOff=Object.values(dbIndexes).every(v=>!v.on);
  const qtFast=3; // base ms with all indexes
  const qtCurrent=queryTime('j');
  const qtWorst=3+850+320+410; // all indexes off

  el.innerHTML=`
<div style="display:flex;gap:10px;margin-bottom:8px;flex-wrap:wrap;">
  <div style="flex:1;min-width:140px;background:#030812;border:1px solid #1a1030;padding:7px 10px;">
    <div style="font-family:'Press Start 2P',monospace;font-size:8px;color:#3ddc84;margin-bottom:4px;">OPTIMISED (all indexed)</div>
    <div style="font-family:'VT323',monospace;font-size:18px;color:#3ddc84;">${qtFast}ms</div>
    <div style="height:5px;background:#3ddc84;width:${(qtFast/qtWorst*100).toFixed(1)}%;margin-top:4px;min-width:2px;"></div>
  </div>
  <div style="flex:1;min-width:140px;background:#030812;border:1px solid #1a1030;padding:7px 10px;">
    <div style="font-family:'Press Start 2P',monospace;font-size:8px;color:${qtCurrent>100?'#f44336':qtCurrent>20?'#ffb74d':'#3ddc84'};margin-bottom:4px;">CURRENT STATE</div>
    <div style="font-family:'VT323',monospace;font-size:18px;color:${qtCurrent>100?'#f44336':qtCurrent>20?'#ffb74d':'#3ddc84'};">${qtCurrent}ms</div>
    <div style="height:5px;background:${qtCurrent>100?'#f44336':qtCurrent>20?'#ffb74d':'#3ddc84'};width:${Math.min(100,qtCurrent/qtWorst*100).toFixed(1)}%;margin-top:4px;min-width:2px;"></div>
  </div>
  <div style="flex:1;min-width:140px;background:#030812;border:1px solid #1a1030;padding:7px 10px;">
    <div style="font-family:'Press Start 2P',monospace;font-size:8px;color:#f44336;margin-bottom:4px;">WORST (no indexes)</div>
    <div style="font-family:'VT323',monospace;font-size:18px;color:#f44336;">${qtWorst}ms</div>
    <div style="height:5px;background:#f44336;width:100%;margin-top:4px;"></div>
  </div>
</div>
${Object.entries(dbIndexes).map(([k,v])=>`
<div class="idx-row">
<div class="idx-toggle ${v.on?'on':'off'}" onclick="toggleIdx('${k}')"></div>
<span style="font-family:'VT323',monospace;font-size:15px;color:var(--white);flex:1;">${k}</span>
<span style="font-family:'VT323',monospace;font-size:15px;color:${v.on?'#3ddc84':'#f44336'};">${v.on?`+${v.improve}% faster reads`:`-${v.improve}% slower without`}</span>
</div>`).join('')}
<div style="font-family:'VT323',monospace;font-size:14px;color:var(--dim);margin-top:5px;border-left:2px solid #1a1030;padding-left:6px;">Toggle indexes then click a query to see the real time difference in the progress bar.</div>`;
}

function toggleIdx(k){
  dbIndexes[k].on=!dbIndexes[k].on;
  tlog(`db.index_toggle  idx=${k}  state=${dbIndexes[k].on?'ON':'OFF'}`,'warn');
  // Close any open result panels so user reruns query to see timing difference
  document.querySelectorAll('.sqr').forEach(r=>r.classList.remove('show'));
  renderIdxPanel();
}

// Simulated query time based on index state
function queryTime(id){
  const base={j:3,s:5,w:4,p:0}[id]||5;
  let penalty=0;
  if(!dbIndexes['sessions.nanny_id'].on) penalty+=850;
  if(!dbIndexes['sessions.status'].on) penalty+=320;
  if(!dbIndexes['sessions.session_date'].on) penalty+=410;
  if(!dbIndexes['nannies.hourly_rate'].on&&(id==='s')) penalty+=180;
  return base+Math.floor(penalty*(id==='j'?1:id==='s'?.5:.3));
}

const SQR_DATA={
  j:(qt)=>`<div class="explain-section" style="margin-bottom:8px;">
<div style="font-family:'Press Start 2P',monospace;font-size:8px;color:var(--orange);margin-bottom:5px;">EXPLAIN PLAN</div>
${[
  {op:'Hash Join',cost:'0.00..48.20',rows:3,note:'Hash Cond: s.nanny_id = n.id',costly:false},
  {op:'Seq Scan',cost:'0.00..18.60',rows:450,note:`on sessions (filter: status='ACTIVE') ${!dbIndexes['sessions.status'].on?'← MISSING INDEX':'' }`,costly:!dbIndexes['sessions.status'].on},
  {op:dbIndexes['sessions.nanny_id'].on?'Index Scan':'Seq Scan',cost:dbIndexes['sessions.nanny_id'].on?'0.00..0.29':'0.00..12.40',rows:dbIndexes['sessions.nanny_id'].on?1:280,note:`on nannies ${!dbIndexes['sessions.nanny_id'].on?'← MISSING INDEX on nanny_id':'using idx_nanny_id'}`,costly:!dbIndexes['sessions.nanny_id'].on},
].map(r=>`<div class="explain-row"><span class="explain-op" style="color:${r.costly?'#f44336':'#ce93d8'}">${r.op}</span><span class="explain-cost" style="color:${r.costly?'#f44336':'#ffb74d'}">${r.cost}</span><span style="font-size:14px;font-family:'VT323',monospace;color:${r.costly?'#f44336':'var(--dim)'};">${r.note}</span></div>`).join('')}
</div>
<table><thead><tr><th>SESSION_ID</th><th>DATE</th><th>NANNY</th><th>PARENT</th><th>CHILD</th><th>HRS</th><th>TOTAL</th></tr></thead><tbody>
<tr><td>S-1042</td><td>2025-11-14</td><td>Amara T.</td><td>Mr. Dlamini</td><td>Sipho</td><td>4</td><td>R480</td></tr>
<tr><td>S-1039</td><td>2025-11-12</td><td>Lerato M.</td><td>Mrs. Botha</td><td>Emma</td><td>6</td><td>R900</td></tr>
<tr><td>S-1035</td><td>2025-11-10</td><td>Amara T.</td><td>Mr. Nkosi</td><td>Zara</td><td>3</td><td>R360</td></tr>
</tbody></table>
<div class="snote" style="color:${qt>100?'#f44336':qt>20?'#ffb74d':'#3ddc84'}">3 rows · ${qt}ms · ${qt>100?'⚠ slow — missing indexes':'✓ fast'}</div>`,
  s:(qt)=>`<table><thead><tr><th>NANNY</th><th>RATE</th><th>RATING</th><th>ABOVE AVG BY</th></tr></thead><tbody>
<tr><td>Lerato M.</td><td>R150/hr</td><td>4.9 ★</td><td>+R22.50</td></tr>
<tr><td>Thandi K.</td><td>R140/hr</td><td>4.7 ★</td><td>+R12.50</td></tr>
</tbody></table><div class="snote">AVG = R127.50 · CROSS JOIN subquery · ${qt}ms</div>`,
  w:(qt)=>`<table><thead><tr><th>PARENT</th><th>AMOUNT</th><th>DATE</th><th>RUNNING TOTAL</th></tr></thead><tbody>
<tr><td>Mr. Dlamini</td><td>R480</td><td>2025-11-08</td><td>R480</td></tr>
<tr><td>Mr. Dlamini</td><td>R1120</td><td>2025-11-14</td><td>R1600</td></tr>
<tr><td>Mrs. Botha</td><td>R900</td><td>2025-11-12</td><td>R900</td></tr>
</tbody></table><div class="snote">PARTITION BY parent_id · ROWS UNBOUNDED PRECEDING · ${qt}ms</div>`,
  p:()=>`<div style="font-family:'VT323',monospace;font-size:13px;color:#3ddc84;line-height:1.8;">
✓ Procedure compiled<br>▸ is_nanny_available() — availability guard<br>▸ sessions_seq.NEXTVAL — sequence-based PK<br>▸ RAISE_APPLICATION_ERROR — typed business errors<br>▸ COMMIT — explicit transaction boundary<br><span style="color:var(--dim)">Patterns: procedures, sequences, error handling, transactions</span></div>`,
};

function runSQL(el,id){
  const r=document.getElementById('r-'+id);
  if(r.classList.contains('show')){r.classList.remove('show');return;}
  const qt=queryTime(id);
  const optimised=qt<50;
  tlog(`db.query_run  id=${id}  estimated_time=${qt}ms  ${qt>100?'WARN: missing indexes':''}`,qt>100?'warn':'info');

  // Show live animated timer bar
  r.classList.add('show');
  const barCol=optimised?'#3ddc84':qt>500?'#f44336':'#ffb74d';
  const maxDisplay=Math.min(qt,1200); // cap animation at 1200ms real time

  r.innerHTML=`
<div style="margin-bottom:6px;">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
    <span style="font-family:'Press Start 2P',monospace;font-size:6px;color:${barCol};">EXECUTING</span>
    <span id="qt-ms-${id}" style="font-family:'VT323',monospace;font-size:16px;color:${barCol};">0 ms</span>
  </div>
  <div style="height:8px;background:#0a0a1a;border:1px solid #1a1030;position:relative;overflow:hidden;">
    <div id="qt-bar-${id}" style="height:100%;width:0%;background:${barCol};transition:none;"></div>
  </div>
  <div style="display:flex;justify-content:space-between;margin-top:2px;">
    <span style="font-family:'VT323',monospace;font-size:10px;color:var(--dim);">0ms</span>
    <span style="font-family:'VT323',monospace;font-size:10px;color:var(--dim);">${qt}ms ${optimised?'✓ indexed':'⚠ missing indexes'}</span>
  </div>
</div>
<div id="qt-result-${id}" style="display:none;"></div>`;

  const barEl=document.getElementById(`qt-bar-${id}`);
  const msEl=document.getElementById(`qt-ms-${id}`);
  const startTs=performance.now();

  function animBar(){
    const elapsed=performance.now()-startTs;
    const pct=Math.min(100,(elapsed/maxDisplay)*100);
    const displayMs=Math.round(elapsed);
    if(barEl) barEl.style.width=pct+'%';
    if(msEl) msEl.textContent=displayMs+' ms';
    if(elapsed<maxDisplay){
      requestAnimationFrame(animBar);
    } else {
      // Snap to final time
      if(barEl) barEl.style.width='100%';
      if(msEl) msEl.textContent=qt+' ms';
      // Show result after bar completes
      const resEl=document.getElementById(`qt-result-${id}`);
      if(resEl){resEl.style.display='block';resEl.innerHTML=SQR_DATA[id](qt)||'No result.';}
    }
  }
  requestAnimationFrame(animBar);
}

function initDB(){renderIdxPanel();setTimeout(()=>setIsolation(1),80);}

const ISO_LEVELS=[
  {name:'READ UNCOMMITTED',
   connA:`BEGIN TRANSACTION;
UPDATE sessions SET status='ACTIVE' WHERE id=S-1042;
-- (not yet committed — A is still working)
-- Connection B can read this "dirty" value`,
   connB:`BEGIN TRANSACTION;
SELECT status FROM sessions WHERE id=S-1042;
-- Returns: 'ACTIVE'  ← DIRTY READ
-- Reading A's uncommitted data — dangerous!
-- If A rolls back, B acted on invalid data`,
   verdict:'⚠ DIRTY READ',vcol:'#f44336',
   note:"B reads A's uncommitted changes. If A rolls back, B made decisions on phantom data. Almost never the right choice.",anomalies:['Dirty reads','Non-repeatable reads','Phantom reads']},
  {name:'READ COMMITTED',
   connA:`BEGIN TRANSACTION;
UPDATE sessions SET status='ACTIVE' WHERE id=S-1042;
-- (not yet committed)
-- Connection B is blocked from seeing this`,
   connB:`BEGIN TRANSACTION;
SELECT status FROM sessions WHERE id=S-1042;
-- Returns: 'PENDING'  ← committed value
-- B sees the last COMMITTED state of the row
-- Default in most databases (PostgreSQL, Oracle)`,
   verdict:'✓ COMMITTED READ',vcol:'#3ddc84',
   note:"B only sees committed data. Safe from dirty reads. But if A commits between two of B's reads, B sees different values in same transaction.",anomalies:['Non-repeatable reads','Phantom reads']},
  {name:'REPEATABLE READ',
   connA:`BEGIN TRANSACTION;
UPDATE sessions SET status='ACTIVE' WHERE id=S-1042;
COMMIT;  -- A commits mid-way through B's tx`,
   connB:`BEGIN TRANSACTION;
SELECT status FROM sessions WHERE id=S-1042;
-- Returns: 'PENDING'  (first read)
-- [A commits 'ACTIVE' here]
SELECT status FROM sessions WHERE id=S-1042;
-- Returns: 'PENDING'  ← same snapshot
-- B's view is frozen at transaction start`,
   verdict:'✓ SNAPSHOT ISOLATION',vcol:'#3ddc84',
   note:"B sees a consistent snapshot throughout its transaction. Same row returns same value even after A commits. MySQL InnoDB default.",anomalies:['Phantom reads (in some DBs)']},
  {name:'SERIALIZABLE',
   connA:`BEGIN TRANSACTION;
UPDATE sessions SET status='ACTIVE' WHERE id=S-1042;
-- Holds range lock on sessions rows`,
   connB:`BEGIN TRANSACTION;
SELECT * FROM sessions WHERE status='PENDING';
-- B is BLOCKED — A holds conflicting lock
-- B must wait until A commits or rolls back
-- Prevents all anomalies — maximum safety`,
   verdict:'⬡ SERIALIZED (BLOCKING)',vcol:'#ce93d8',
   note:"Transactions run as if sequential. Maximum consistency, minimum concurrency. High-contention tables will deadlock. Use only where correctness is critical.",anomalies:[]},
];

let _isoLevel=1;
function setIsolation(i){
  _isoLevel=i;
  document.querySelectorAll('[id^="iso-btn-"]').forEach((btn,j)=>{
    btn.style.background=j===i?'#ffb74d':'#050510';
    btn.style.color=j===i?'#050510':'#ffb74d';
  });
  const lv=ISO_LEVELS[i];
  const prevented=4-i;
  const anomalyBadge=lv.anomalies.length>0
    ?lv.anomalies.map(a=>`<span style="background:#1a0606;border:1px solid #f44336;color:#f44336;font-size:13px;padding:1px 5px;margin:2px;display:inline-block;">${a}</span>`).join('')
    :'<span style="background:#061a06;border:1px solid #3ddc84;color:#3ddc84;font-size:10px;padding:1px 5px;margin:2px;display:inline-block;">All anomalies prevented</span>';
  document.getElementById('iso-display').innerHTML=`
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">
<div style="background:#07090f;border:2px solid #1a3040;border-left:2px solid #4fc3f7;padding:8px;">
<div style="font-family:'Press Start 2P',monospace;font-size:8px;color:#4fc3f7;margin-bottom:5px;">CONNECTION A (writer)</div>
<pre style="font-size:15px;color:#7dd3fc;white-space:pre-wrap;">${lv.connA}</pre>
</div>
<div style="background:#07090f;border:2px solid #1a3040;border-left:2px solid #ce93d8;padding:8px;">
<div style="font-family:'Press Start 2P',monospace;font-size:8px;color:#ce93d8;margin-bottom:5px;">CONNECTION B (reader)</div>
<pre style="font-size:15px;color:#c7a8e0;white-space:pre-wrap;">${lv.connB}</pre>
</div>
</div>
<div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
<span style="font-family:'Press Start 2P',monospace;font-size:8px;color:${lv.vcol};">${lv.verdict}</span>
<span style="font-size:15px;color:var(--dim);">${lv.note}</span>
</div>
<div style="margin-top:5px;">Remaining anomalies: ${anomalyBadge}</div>`;
  tlog(`db.isolation_level  level="${lv.name}"  anomalies_remaining=${lv.anomalies.length}`);
}

// ═══════════════════════════════════════════════════════════
// GAME ENGINE — Frame budget + ECS inspector
// ═══════════════════════════════════════════════════════════
let geEnts=[],geGrav=false,geCtx2=null,geCv=null,geTick=0,geFPS=0,geLast=0;
const geBudget={update:0,collision:0,render:0};
const geKeys={};  // WASD input state for game engine arena
let geOnGround=false;
let geFloat=false; // float mode: player ignores gravity, moves freely in all 4 directions

function buildGE(){return `<div>
<p style="font-family:'VT323',monospace;font-size:13px;color:var(--dim);margin-bottom:5px;line-height:1.5;">Custom 2D engine — raw Canvas API, zero frameworks. <b style="color:#ce93d8">WASD / arrow keys</b> to move · <b style="color:#ce93d8">Space/W</b> to jump (physics-based, responds to gravity) · <b style="color:#ce93d8">Float mode</b>: free movement anywhere · <b style="color:#ce93d8">Click</b> to shoot.</p>
<canvas id="ge-c" width="680" height="260" style="display:block;width:100%;cursor:crosshair;" tabindex="0"></canvas>
<div class="gbtns">
<button class="gb" onclick="geSpawnEnemy()">+ Enemy</button>
<button class="gb" onclick="geParticle()">✦ Burst</button>
<button class="gb" onclick="geGravity()">⬇ Gravity</button>
<button class="gb" id="ge-float-btn" onclick="geToggleFloat()">◈ Float</button>
<button class="gb" onclick="geClear()">✕ Clear</button>
<button class="gb" style="border-color:#4fc3f7;color:#4fc3f7" onclick="toggleGESrc()">📎 source</button>
</div>
<div id="ge-src" style="display:none;font-family:'VT323',monospace;font-size:12px;background:#030812;border:2px solid #1a1030;border-left:3px solid #4fc3f7;padding:9px 11px;margin-top:5px;white-space:pre;color:#7dd3fc;line-height:1.6;overflow-x:auto;"></div>
<div class="ecs-panel" id="ecs-panel">Loading...</div>
</div>`;}

const GE_SOURCE_SNIPPETS=[
  {label:'RAF game loop + delta time',src:`// requestAnimationFrame loop — delta time ensures consistent physics
function geLoop(now) {
  if (!geRunning) return;
  const dt = now - (geLast || now);  // ms since last frame
  geLast = now;
  // Profile each system separately
  const t0 = performance.now();
  geUpdate(dt);          // physics, AI, collision
  budget.update = performance.now() - t0;
  const t1 = performance.now();
  geRender();            // clear → draw entities → budget bars
  budget.render = performance.now() - t1;
  updateECS();           // live ECS inspector panel
  requestAnimationFrame(geLoop);
  // If frame > 16.67ms, we miss 60fps — bars turn red
}`},
  {label:'WASD + physics-based jump',src:`// WASD movement with proper platformer jump
// Ground detection: entity y >= floor height
const FLOOR = GH - 24;
const onGround = e.y >= FLOOR;

// Horizontal movement (WASD / arrow keys)
if (keys['a'] || keys['arrowleft'])  e.vx -= 0.6;
if (keys['d'] || keys['arrowright']) e.vx += 0.6;

// Jump: only allowed from ground, impulse varies with gravity
if ((keys[' '] || keys['w']) && onGround) {
  // Gravity amplifies jump — stronger pull = higher impulse needed
  const grav = geGrav ? 0.4 : 0.15;
  e.vy = -(Math.sqrt(2 * grav * JUMP_HEIGHT));
}

// Horizontal damping (friction)
e.vx *= 0.82;
// Clamp speed
if (Math.abs(e.vx) > 4.5) e.vx = Math.sign(e.vx) * 4.5;`},
  {label:'Seek AI + speed cap',src:`// Enemy seek: steer toward player each frame
if (e.type === 'enemy' && player) {
  const dx = player.x - e.x;
  const dy = player.y - e.y;
  const dist = Math.hypot(dx, dy) || 1;
  // Add acceleration toward player (normalised direction)
  e.vx += (dx/dist) * 0.09;
  e.vy += (dy/dist) * 0.09;
  // Speed cap: prevents infinite acceleration
  const speed = Math.hypot(e.vx, e.vy);
  if (speed > 1.9) {
    e.vx = (e.vx/speed) * 1.9;
    e.vy = (e.vy/speed) * 1.9;
  }
}`},
  {label:'AABB collision (proj vs enemy)',src:`// AABB: Axis-Aligned Bounding Box collision check
// O(n×m) — n projectiles × m enemies. For scale,
// a spatial grid would reduce this to O(n + m).
if (e.type === 'proj') {
  for (const t of geEnts) {
    if (t.type === 'enemy') {
      // Check overlap on both axes
      const overlapX = Math.abs(e.x - t.x) < 13;
      const overlapY = Math.abs(e.y - t.y) < 13;
      if (overlapX && overlapY) {
        t.hp = (t.hp || 3) - 1;  // damage
        e.life = 0;               // destroy projectile
        if (t.hp <= 0) spawnParticles(t.x, t.y);
      }
    }
  }
}`},
];
let geSrcIdx=0,geSrcVisible=false;
function toggleGESrc(){
  geSrcVisible=!geSrcVisible;
  const el=document.getElementById('ge-src');
  if(!el)return;
  el.style.display=geSrcVisible?'block':'none';
  if(geSrcVisible) showGESrc(0);
}
function showGESrc(i){
  geSrcIdx=i;
  const el=document.getElementById('ge-src');
  if(!el)return;
  const s=GE_SOURCE_SNIPPETS[i];
  const btns=GE_SOURCE_SNIPPETS.map((s2,j)=>
    `<button onclick="showGESrc(${j})" style="font-family:'Press Start 2P',monospace;font-size:7px;background:${j===i?'#4fc3f7':'transparent'};color:${j===i?'#050510':'#4fc3f7'};border:1px solid #4fc3f7;padding:3px 6px;cursor:pointer;margin-right:4px;">${s2.label}</button>`
  ).join('');
  el.innerHTML=`<div style="margin-bottom:7px;">${btns}</div><div style="color:#3ddc84;margin-bottom:5px;font-size:14px;">// ${s.label}</div>${escHtml(s.src)}`;
  tlog(`ge.source_view  snippet="${s.label}"`);
}
function escHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

function initGE(){
  geCv=document.getElementById('ge-c');if(!geCv)return;
  geCtx2=geCv.getContext('2d');geEnts=[];geRunning=true;geTick=0;geLast=0;
  gePlayer={type:'player',x:340,y:200,vx:0,vy:0};
  geEnts.push(gePlayer);
  geCv.addEventListener('click',geShoot);
  // WASD key listeners scoped to GE arena (canvas focus + document)
  geCv.addEventListener('keydown',e=>{
    geKeys[e.key.toLowerCase()]=true;
    // Prevent space from scrolling while canvas is focused
    if(e.key===' ') e.preventDefault();
  });
  geCv.addEventListener('keyup',e=>{geKeys[e.key.toLowerCase()]=false;});
  // Also attach to document so keys work without canvas focus
  document.addEventListener('keydown',geDocKey);
  document.addEventListener('keyup',geDocKeyUp);
  requestAnimationFrame(geLoop);
  tlog('ge.engine_start  entities=1  controls=WASD+Space');
}

function geDocKey(e){
  if(!geRunning)return;
  const k=e.key.toLowerCase();
  if(['w','a','s','d','arrowup','arrowleft','arrowright','arrowdown',' '].includes(k)){
    geKeys[k]=true;
    // Only prevent default for space when modal is open (don't steal from world nav)
    if(k===' ') e.preventDefault();
  }
}
function geDocKeyUp(e){geKeys[e.key.toLowerCase()]=false;}

function geLoop(now){
  if(!geRunning){
    // Cleanup listeners when engine stops
    document.removeEventListener('keydown',geDocKey);
    document.removeEventListener('keyup',geDocKeyUp);
    return;
  }
  const dt=now-(geLast||now);geLast=now;geTick++;
  if(dt>0) geFPS=Math.round(1000/dt);
  const t0=performance.now();
  geUpdate(dt);
  geBudget.update=performance.now()-t0;
  const t1=performance.now();
  geRender();
  geBudget.render=performance.now()-t1;
  updateECS();
  requestAnimationFrame(geLoop);
}

function geUpdate(dt){
  const gc=geCv;if(!gc)return;
  const GW=gc.width,GH=gc.height;
  const FLOOR=GH-22;   // ground plane y
  const GRAV=geGrav?0.42:0.15;  // gravity constant — affects jump feel
  const JUMP_IMPULSE=Math.sqrt(2*GRAV*90); // physics: v = sqrt(2gh), h=90px

  const t0=performance.now();
  geEnts=geEnts.filter(e=>e.life===undefined||e.life>0);
  geEnts.forEach(e=>{if(e.life!==undefined)e.life-=dt;});

  for(const e of geEnts){
    const onFloor=e.y>=FLOOR;

    if(e.type==='player'){
      if(geFloat){
        // ── FLOAT MODE: full 4-directional free movement, gravity ignored ──
        // Player is "weighed down" by gravity only when float is OFF
        if(geKeys['a']||geKeys['arrowleft'])  e.vx-=0.7;
        if(geKeys['d']||geKeys['arrowright']) e.vx+=0.7;
        if(geKeys['w']||geKeys['arrowup'])    e.vy-=0.7;
        if(geKeys['s']||geKeys['arrowdown'])  e.vy+=0.7;
        // Drag in all directions for floaty feel
        e.vx*=0.80;
        e.vy*=0.80;
        if(Math.abs(e.vx)<0.05)e.vx=0;
        if(Math.abs(e.vy)<0.05)e.vy=0;
        // Speed cap (4-directional)
        const fspd=Math.hypot(e.vx,e.vy);
        if(fspd>5){e.vx=e.vx/fspd*5;e.vy=e.vy/fspd*5;}
      } else {
        // ── NORMAL/GRAVITY MODE: WASD horizontal + physics jump ──
        if(geKeys['a']||geKeys['arrowleft'])  e.vx-=0.65;
        if(geKeys['d']||geKeys['arrowright']) e.vx+=0.65;
        // Jump: only from ground, impulse derived from sqrt(2gh)
        if((geKeys[' ']||geKeys['w']||geKeys['arrowup'])&&onFloor){
          e.vy=-JUMP_IMPULSE;
          tlog(`ge.player_jump  impulse=${JUMP_IMPULSE.toFixed(2)}  grav=${GRAV}`);
        }
        // Apply gravity
        e.vy+=GRAV;
        // Horizontal friction
        e.vx*=0.78;
        if(Math.abs(e.vx)<0.05)e.vx=0;
        // Speed cap
        if(Math.abs(e.vx)>4.5)e.vx=Math.sign(e.vx)*4.5;
      }
    } else if(e.type==='wall'){
      // walls are static
    } else {
      // Gravity for all other entities (enemies, projectiles, particles)
      if(geGrav) e.vy=(e.vy||0)+GRAV;
    }

    e.x+=(e.vx||0);e.y+=(e.vy||0);

    // Bounds
    if(e.x<10){e.x=10;e.vx=Math.abs(e.vx||0)*0.5;}
    if(e.x>GW-10){e.x=GW-10;e.vx=-Math.abs(e.vx||0)*0.5;}
    if(e.y<10){e.y=10;e.vy=Math.abs(e.vy||0)*0.3;}
    // Floor collision — only apply in non-float mode for player
    if(e.type==='player'&&geFloat){
      // Float: clamp to full canvas (all 4 walls)
      if(e.y>GH-10){e.y=GH-10;e.vy=-Math.abs(e.vy||0)*0.4;}
    } else {
      // Normal: floor plane
      if(e.y>=FLOOR){
        e.y=FLOOR;
        if(e.type==='player'){e.vy=0;}
        else if(e.type!=='proj'){e.vy=-Math.abs(e.vy||0)*0.55;}
        else{e.vy=-Math.abs(e.vy||0)*0.3;}
      }
    }

    if(e.vx!==undefined) e.vx=(e.vx||0)*(e.type==='particle'?.97:.992);

    if(e.type==='enemy'){
      const pl=gePlayer;
      if(pl){
        const ddx=pl.x-e.x,ddy=pl.y-e.y,d=Math.hypot(ddx,ddy)||1;
        e.vx+=ddx/d*.09;e.vy+=ddy/d*.09;
        const spd=Math.hypot(e.vx,e.vy);
        if(spd>1.9){e.vx=e.vx/spd*1.9;e.vy=e.vy/spd*1.9;}
      }
    }
    if(e.type==='proj'){
      for(const t of geEnts){
        if(t.type==='enemy'&&Math.abs(e.x-t.x)<13&&Math.abs(e.y-t.y)<13){
          t.hp=(t.hp||3)-1;e.life=0;
          if(t.hp<=0){geSpawnPts(t.x,t.y,t.col||'#ff6b35');t.life=0;tlog('ge.enemy_destroyed  particles_burst=13');}
        }
      }
    }
  }
  geOnGround=gePlayer&&gePlayer.y>=FLOOR;
  geBudget.collision=performance.now()-t0-geBudget.update;
}

function geRender(){
  if(!geCtx2||!geCv)return;
  const W2=geCv.width,H2=geCv.height;
  const FLOOR=H2-22;

  geCtx2.fillStyle='#020811';geCtx2.fillRect(0,0,W2,H2);
  // Grid
  geCtx2.strokeStyle='#0d1a2e';geCtx2.lineWidth=1;
  for(let x=0;x<W2;x+=32){geCtx2.beginPath();geCtx2.moveTo(x,0);geCtx2.lineTo(x,H2);geCtx2.stroke();}
  for(let y=0;y<H2;y+=32){geCtx2.beginPath();geCtx2.moveTo(0,y);geCtx2.lineTo(W2,y);geCtx2.stroke();}

  // Ground plane
  geCtx2.fillStyle='#0d1a2e';
  geCtx2.fillRect(0,FLOOR,W2,H2-FLOOR);
  geCtx2.strokeStyle='#ce93d8';
  geCtx2.lineWidth=1;
  geCtx2.setLineDash([6,4]);
  geCtx2.beginPath();geCtx2.moveTo(0,FLOOR);geCtx2.lineTo(W2,FLOOR);geCtx2.stroke();
  geCtx2.setLineDash([]);
  geCtx2.fillStyle='#1a0a2a';
  geCtx2.font='8px VT323,monospace';geCtx2.textAlign='left';
  geCtx2.fillStyle='#4a2a6a';
  geCtx2.fillText('FLOOR · y='+FLOOR,4,H2-6);

  // Controls hint (bottom-left, fades when player moves)
  if(geTick<240){
    const alpha=Math.max(0,1-geTick/200);
    geCtx2.globalAlpha=alpha*0.7;
    geCtx2.fillStyle='#ce93d8';
    geCtx2.font='9px VT323,monospace';geCtx2.textAlign='left';
    geCtx2.fillText('WASD/←→  move · W/Space  jump · ◈Float  8-dir free · Click  shoot',8,FLOOR-8);
    geCtx2.globalAlpha=1;
  }

  for(const e of geEnts){
    const al=e.life!==undefined?Math.min(1,e.life/300):1;
    geCtx2.globalAlpha=al;geCtx2.shadowColor=e.glow||'#fff';geCtx2.shadowBlur=e.type==='particle'?5:12;
    if(e.type==='player'){
      // Shadow under player when airborne (not in float mode)
      if(!geFloat&&!geOnGround&&gePlayer===e){
        const shadowY=FLOOR;
        const dist=Math.max(0,shadowY-e.y);
        const shadowAlpha=Math.max(0,0.4-dist/200);
        geCtx2.globalAlpha=shadowAlpha;
        geCtx2.fillStyle='rgba(206,147,216,0.4)';
        geCtx2.beginPath();geCtx2.ellipse(e.x,shadowY,10,3,0,0,Math.PI*2);geCtx2.fill();
        geCtx2.globalAlpha=al;
      }
      const playerCol=geFloat?'#ce93d8':'#4fc3f7';
      geCtx2.fillStyle='#0a1628';geCtx2.fillRect(e.x-9,e.y-9,18,18);
      geCtx2.strokeStyle=playerCol;geCtx2.lineWidth=2;
      if(geFloat){
        // Dashed border in float mode to show it's a different physics state
        geCtx2.setLineDash([3,2]);
      }
      geCtx2.strokeRect(e.x-9,e.y-9,18,18);
      geCtx2.setLineDash([]);
      geCtx2.fillStyle=playerCol;geCtx2.fillRect(e.x-5,e.y-2,3,2);geCtx2.fillRect(e.x+2,e.y-2,3,2);
      // Float mode: draw small propulsion sparks
      if(geFloat&&(Math.abs(e.vx)>0.2||Math.abs(e.vy)>0.2)){
        geCtx2.fillStyle='rgba(206,147,216,0.5)';
        const angle=Math.atan2(-e.vy,-e.vx);
        const spx=e.x+Math.cos(angle)*14;
        const spy=e.y+Math.sin(angle)*14;
        geCtx2.beginPath();geCtx2.arc(spx,spy,2,0,Math.PI*2);geCtx2.fill();
        geCtx2.fillStyle='rgba(206,147,216,0.25)';
        geCtx2.beginPath();geCtx2.arc(spx+Math.cos(angle)*5,spy+Math.sin(angle)*5,1.5,0,Math.PI*2);geCtx2.fill();
      }
      // Velocity vector (shows physics)
      if(Math.abs(e.vx)>0.5||Math.abs(e.vy)>0.5){
        geCtx2.strokeStyle=`rgba(${geFloat?'206,147,216':'79,195,247'},0.4)`;geCtx2.lineWidth=1;
        geCtx2.beginPath();geCtx2.moveTo(e.x,e.y);geCtx2.lineTo(e.x+e.vx*4,e.y+e.vy*4);geCtx2.stroke();
      }
    } else if(e.type==='enemy'){
      geCtx2.fillStyle='#1a050f';geCtx2.fillRect(e.x-11,e.y-11,22,22);
      geCtx2.strokeStyle=e.col||'#ff6b35';geCtx2.lineWidth=1.5;geCtx2.strokeRect(e.x-11,e.y-11,22,22);
      geCtx2.fillStyle='#1a0010';geCtx2.fillRect(e.x-11,e.y-17,22,3);
      geCtx2.fillStyle='#f44336';geCtx2.fillRect(e.x-11,e.y-17,22*((e.hp||3)/3),3);
    } else if(e.type==='proj'){
      geCtx2.fillStyle='#4fc3f7';geCtx2.beginPath();geCtx2.arc(e.x,e.y,4,0,Math.PI*2);geCtx2.fill();
    } else if(e.type==='particle'){
      geCtx2.fillStyle=e.col||'#ffb74d';geCtx2.beginPath();geCtx2.arc(e.x,e.y,e.sz||3,0,Math.PI*2);geCtx2.fill();
    }
    geCtx2.shadowBlur=0;geCtx2.globalAlpha=1;
  }
  // Frame budget bars (top-right)
  const TARGET=16.67;
  const budgetItems=[['update',geBudget.update,'#3ddc84'],['collision',geBudget.collision,'#ffb74d'],['render',geBudget.render,'#4fc3f7']];
  budgetItems.forEach(([label,val,col],i)=>{
    const pct=Math.min(1,val/TARGET);
    const bx=W2-90,by=8+i*14;
    geCtx2.fillStyle='#0a1020';geCtx2.fillRect(bx,by,80,8);
    geCtx2.fillStyle=pct>.7?'#f44336':pct>.4?'#ffb74d':col;
    geCtx2.fillRect(bx,by,Math.max(2,pct*80),8);
    geCtx2.fillStyle='rgba(255,255,255,.5)';geCtx2.font='7px monospace';
    geCtx2.textAlign='left';geCtx2.fillText(`${label}:${val.toFixed(2)}ms`,bx,by+18);
  });
  // FPS + gravity state
  geCtx2.fillStyle=geFPS>50?'#3ddc84':geFPS>30?'#ffb74d':'#f44336';
  geCtx2.font='bold 9px monospace';geCtx2.textAlign='right';
  geCtx2.fillText(`${geFPS} FPS`,W2-4,H2-FLOOR+16+6);
  if(geGrav){
    geCtx2.fillStyle='#ffb74d';geCtx2.font='8px monospace';
    geCtx2.fillText('GRAV ON',W2-4,H2-FLOOR+28+6);
  }
  if(geFloat){
    geCtx2.fillStyle='#ce93d8';geCtx2.font='8px monospace';
    geCtx2.textAlign='right';
    geCtx2.fillText('FLOAT MODE · WASD=8-dir',W2-4,H2-FLOOR+28+6);
  }
}

function updateECS(){
  const el=document.getElementById('ecs-panel');if(!el)return;
  const counts={};
  for(const e of geEnts) counts[e.type]=(counts[e.type]||0)+1;
  const uMs=geBudget.update.toFixed(2),rMs=geBudget.render.toFixed(2),cMs=geBudget.collision.toFixed(2);
  const frameMs=(geBudget.update+geBudget.render).toFixed(2);
  const budgetPct=Math.round((parseFloat(frameMs)/16.67)*100);
  const vx=(gePlayer?.vx||0).toFixed(2),vy=(gePlayer?.vy||0).toFixed(2);
  el.textContent=
`ENTITY COUNT: ${geEnts.length}  FRAME BUDGET: ${frameMs}ms / 16.67ms (${budgetPct}%)
├─ player    ×${counts.player||0}  [Transform · Velocity · InputSystem]  vx=${vx} vy=${vy}  mode=${geFloat?'FLOAT':'GROUNDED('+( geOnGround?'floor':'air')+')'}
├─ enemy     ×${counts.enemy||0}  [Transform · Velocity · SeekAI · Health · Renderer]
├─ proj      ×${counts.proj||0}  [Transform · Velocity · Lifetime · Renderer]
└─ particle  ×${counts.particle||0}  [Transform · Velocity · Lifetime · Color · Size]

SYSTEMS THIS FRAME:
├─ InputSystem              → WASD/Arrow · ${geFloat?'8-dir free flight (float mode)':'jump impulse=√(2gh) · ground detection'}
├─ PhysicsSystem  ${uMs}ms  → grav=${geGrav?'ON ('+0.42+')':'float:'+geFloat||0.15}  floor collision · bounds
├─ AISystem                 → seek behaviour · speed cap (1.9px/frame)
├─ CollisionSystem ${cMs}ms → AABB projectile-enemy · O(n×m)
├─ LifetimeSystem           → entity GC by lifetime flag
└─ RenderSystem   ${rMs}ms  → clear · grid · floor · entities · budget bars`;
}

function geShoot(ev){
  const rc=geCv.getBoundingClientRect();
  const tx=(ev.clientX-rc.left)*(geCv.width/rc.width),ty=(ev.clientY-rc.top)*(geCv.height/rc.height);
  const pl=gePlayer;if(!pl)return;
  const dx=tx-pl.x,dy=ty-pl.y,d=Math.hypot(dx,dy)||1;
  geEnts.push({type:'proj',x:pl.x,y:pl.y,vx:dx/d*9,vy:dy/d*9,glow:'#4fc3f7',life:1800});
}
function geSpawnPts(x,y,col){
  for(let i=0;i<13;i++){const a=Math.random()*Math.PI*2,spd=1+Math.random()*5;geEnts.push({type:'particle',x,y,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd,col,sz:2+Math.random()*3,life:300+Math.random()*500,glow:col});}
}
function geClear(){geEnts=geEnts.filter(e=>e.type==='player');tlog('ge.entities_cleared');}
function geSpawnEnemy(){
  const gc=geCv;if(!gc)return;
  const sides=[[Math.random()*gc.width,20],[gc.width-20,Math.random()*gc.height],[Math.random()*gc.width,gc.height-20],[20,Math.random()*gc.height]];
  const [x,y]=sides[Math.floor(Math.random()*4)];
  const cols=['#ff6b35','#f44336','#ff2d55','#ff9800'];
  geEnts.push({type:'enemy',x,y,vx:0,vy:0,hp:3,col:cols[Math.floor(Math.random()*cols.length)]||'#ff6b35',glow:'#ff6b35'});
  tlog(`ge.enemy_spawned  total=${geEnts.filter(e=>e.type==='enemy').length}`);
}
function geParticle(){if(!geCv)return;const cols=['#4fc3f7','#3ddc84','#ce93d8','#ffb74d'];geSpawnPts(60+Math.random()*(geCv.width-120),60+Math.random()*(geCv.height-120),cols[Math.floor(Math.random()*cols.length)]);}
function geGravity(){geGrav=!geGrav;if(geGrav)geFloat=false;tlog(`ge.gravity_toggle  state=${geGrav?'ON':'OFF'}`);
  const fb=document.getElementById('ge-float-btn');
  if(fb&&geGrav){fb.style.background='';fb.style.color='var(--purple)';}
}
function geToggleFloat(){
  geFloat=!geFloat;
  if(geFloat) geGrav=false; // float overrides gravity
  const btn=document.getElementById('ge-float-btn');
  if(btn){
    btn.style.background=geFloat?'var(--purple)':'';
    btn.style.color=geFloat?'#050510':'var(--purple)';
  }
  tlog(`ge.float_toggle  state=${geFloat?'ON':'OFF'}`);
}

// ═══════════════════════════════════════════════════════════
// DEVOPS — Cascade failures + SLO burn rate
// ═══════════════════════════════════════════════════════════
const PIPE_STAGES=['CODE','BUILD','TEST','SCAN','DEPLOY','LIVE'];
let pipeState=PIPE_STAGES.map(()=>'idle'),pipeTimer=null;

const SERVICE_DEPS={
  'GATEWAY':['API-SERVER','AUTH-SVC'],
  'API-SERVER':['DB-PRIMARY','CACHE'],
  'AUTH-SVC':['DB-PRIMARY'],
  'ML-WORKER':['DB-PRIMARY','CACHE'],
  'DB-PRIMARY':[],
  'CACHE':[]
};

const services=[
  {name:'API-SERVER',col:'#f44336',load:72,status:'ONLINE',baseLoad:72},
  {name:'AUTH-SVC',  col:'#ff9800',load:45,status:'ONLINE',baseLoad:45},
  {name:'DB-PRIMARY',col:'#ffb74d',load:88,status:'ONLINE',baseLoad:88},
  {name:'CACHE',     col:'#3ddc84',load:23,status:'ONLINE',baseLoad:23},
  {name:'ML-WORKER', col:'#ce93d8',load:61,status:'ONLINE',baseLoad:61},
  {name:'GATEWAY',   col:'#4fc3f7',load:54,status:'ONLINE',baseLoad:54},
];

let sloWindow=[],sloAlertFired=false,sloInterval=null;

function buildDevOps(){return `<div>
<!-- ── Tab bar ── -->
<div class="dv-tabs">
  <button class="dv-tab on" id="dv-tab-ops"  onclick="dvTab('ops')">⬡ OPS MONITOR</button>
  <button class="dv-tab"    id="dv-tab-build" onclick="dvTab('build')">◈ PIPELINE BUILDER</button>
</div>

<!-- ══ TAB 1: OPS MONITOR (existing content) ══ -->
<div id="dv-ops">
<p style="font-family:'VT323',monospace;font-size:13px;color:var(--dim);margin-bottom:8px;line-height:1.4;">CI/CD pipeline from COGENT WIL. Crash a service to trigger cascade failures — downstream dependents degrade automatically. Watch the SLO burn rate spike.</p>
<div style="background:#030812;border:2px solid #1a1030;padding:10px;margin-bottom:8px;">
<div style="font-family:'Press Start 2P',monospace;font-size:8px;color:#f44336;margin-bottom:8px;letter-spacing:1px;">▶ CI/CD PIPELINE — AZURE DEVOPS</div>
<div class="pipe-stage" id="pipe-stages"></div>
<div class="pipe-log" id="pipe-log">$ Awaiting pipeline trigger...\n</div>
<div style="display:flex;gap:7px;margin-top:7px;flex-wrap:wrap;">
<button class="gb" style="border-color:#f44336;color:#f44336;" onclick="runPipeline()">▶ RUN</button>
<button class="gb" style="border-color:#f44336;color:#f44336;" onclick="failPipeline()">✕ INJECT FAULT</button>
<button class="gb" style="border-color:#f44336;color:#f44336;" onclick="resetPipeline()">↺ RESET</button>
</div>
</div>
<div style="display:flex;gap:8px;margin-bottom:6px;align-items:center;flex-wrap:wrap;">
<div style="font-family:'Press Start 2P',monospace;font-size:8px;color:#f44336;letter-spacing:1px;">▶ SERVICE MESH — click to crash</div>
<div style="font-family:'VT323',monospace;font-size:14px;color:var(--dim);">Dependents cascade on crash</div>
</div>
<div class="srv-grid" id="srv-grid"></div>
<div class="slo-row" id="slo-row">
<div class="slo-box"><div class="slo-label">UPTIME (60s)</div><div class="slo-val" id="slo-pct" style="color:#3ddc84">100.00%</div></div>
<div class="slo-box"><div class="slo-label">ERROR BUDGET</div><div class="slo-val" id="slo-budget" style="color:#3ddc84">100%</div></div>
<div class="slo-box"><div class="slo-label">BURN RATE</div><div class="slo-val" id="slo-burn" style="color:#3ddc84">0.0×</div></div>
<div class="slo-box"><div class="slo-label">SLO TARGET</div><div class="slo-val" style="color:var(--dim)">99.5%</div></div>
</div>
<div style="font-family:'VT323',monospace;font-size:14px;color:var(--dim);margin-top:5px;">SLO error budget burns at 1× normal. Alert fires at 14.4× (1-hr threshold from Google SRE Workbook)</div>
</div>

<!-- ══ TAB 2: PIPELINE BUILDER ══ -->
<div id="dv-build" style="display:none;">
<div style="font-family:'VT323',monospace;font-size:13px;color:var(--dim);margin-bottom:8px;line-height:1.5;">
Drag stages from the palette into the pipeline lane. Order matters — the validator checks your design before running. Based on real Azure DevOps pipelines built during COGENT WIL (C# · ABP Framework · Blue Prism).
</div>

<div class="pb-layout">
  <!-- Palette -->
  <div class="pb-palette">
    <div class="pb-palette-hdr">◈ STAGE PALETTE</div>
    <div id="pb-palette-items"></div>
  </div>

  <!-- Canvas -->
  <div class="pb-canvas-wrap">
    <div class="pb-canvas-hdr">PIPELINE LANE — drop stages here (max 8) · click stage to remove</div>
    <div class="pb-lane" id="pb-lane"
         ondragover="pbDragOver(event)" ondragleave="pbDragLeave(event)" ondrop="pbDrop(event)">
      <div class="pb-drop-hint" id="pb-hint">← Drag stages here to build your pipeline</div>
    </div>

    <!-- Validation warnings -->
    <div id="pb-warnings" style="display:none;background:#0f0800;border:2px solid #ffb74d;padding:7px 10px;font-family:'VT323',monospace;font-size:13px;line-height:1.7;"></div>

    <!-- Controls -->
    <div style="display:flex;gap:7px;flex-wrap:wrap;align-items:center;">
      <button class="gb" style="border-color:#f44336;color:#f44336;" onclick="pbValidateAndRun()">▶ VALIDATE & RUN</button>
      <button class="gb" style="border-color:#ffb74d;color:#ffb74d;" onclick="pbClear()">↺ CLEAR</button>
      <button class="gb" style="border-color:#3ddc84;color:#3ddc84;" onclick="pbLoadPreset('cogent')">★ LOAD COGENT PRESET</button>
      <div style="font-family:'VT323',monospace;font-size:15px;color:var(--dim);margin-left:4px;" id="pb-slot-count">0 / 8 stages</div>
    </div>

    <!-- Execution log -->
    <div class="pb-log" id="pb-log">$ Pipeline builder ready. Drag stages from the palette.\n$ Tip: Always validate before deploy.\n</div>

    <!-- Scorecard -->
    <div class="pb-score" id="pb-score">
      <div class="pb-score-hdr">★ PIPELINE SCORECARD</div>
      <div class="pb-score-grid" id="pb-score-grid"></div>
      <div id="pb-score-badge"></div>
      <details style="margin-top:10px;">
        <summary style="font-family:'Press Start 2P',monospace;font-size:7px;color:var(--dim);cursor:pointer;letter-spacing:1px;">▶ WHAT EACH STAGE MEANS (Azure DevOps context)</summary>
        <div id="pb-debrief" style="font-family:'VT323',monospace;font-size:13px;color:var(--dim);margin-top:8px;line-height:1.7;border-left:2px solid #1a1030;padding-left:8px;"></div>
      </details>
    </div>
  </div>
</div>
</div>
</div>`;}

function dvTab(which){
  document.getElementById('dv-ops').style.display  = which==='ops'   ? '' : 'none';
  document.getElementById('dv-build').style.display = which==='build' ? '' : 'none';
  document.getElementById('dv-tab-ops').classList.toggle('on',  which==='ops');
  document.getElementById('dv-tab-build').classList.toggle('on', which==='build');
  if(which==='build') pbInit();
}

function initDevOps(){
  renderPipe();renderServices();
  sloWindow=[];sloAlertFired=false;
  if(sloInterval) clearInterval(sloInterval);
  sloInterval=setInterval(updateSLO,1000);
}

function updateSLO(){
  const critical=['API-SERVER','GATEWAY','DB-PRIMARY'];
  const healthy=critical.every(n=>services.find(s=>s.name===n)?.status==='ONLINE');
  sloWindow.push(healthy?1:0);
  if(sloWindow.length>60) sloWindow.shift();
  const uptime=sloWindow.length>0?sloWindow.reduce((a,b)=>a+b,0)/sloWindow.length:1;
  const errorRate=1-uptime;
  const burnRate=errorRate/(1-0.995)||0;
  const budgetPct=Math.max(0,100-errorRate/0.005*100);
  const col=uptime>.99?'#3ddc84':uptime>.95?'#ffb74d':'#f44336';
  const el1=document.getElementById('slo-pct');
  const el2=document.getElementById('slo-budget');
  const el3=document.getElementById('slo-burn');
  if(el1){el1.textContent=(uptime*100).toFixed(2)+'%';el1.style.color=col;}
  if(el2){el2.textContent=budgetPct.toFixed(1)+'%';el2.style.color=col;}
  if(el3){el3.textContent=burnRate.toFixed(1)+'×';el3.style.color=burnRate>14.4?'#f44336':burnRate>2?'#ffb74d':'#3ddc84';}
  if(burnRate>14.4&&!sloAlertFired){
    sloAlertFired=true;
    pipeLog(`\n🚨 SLO ALERT: burn rate ${burnRate.toFixed(1)}× > 14.4× threshold`);
    pipeLog('   Error budget depleting — PagerDuty would trigger');
    pipeLog('   Action: restore DB-PRIMARY to recover downstream');
    tlog(`devops.slo_alert  burn_rate=${burnRate.toFixed(1)}x  uptime=${(uptime*100).toFixed(2)}%`,'err');
  }
  if(burnRate<1) sloAlertFired=false;
}

function renderPipe(){
  const el=document.getElementById('pipe-stages');if(!el)return;
  el.innerHTML=PIPE_STAGES.map((s,i)=>{
    const st=pipeState[i];
    const icon={done:'✓',running:'…',fail:'✕',idle:'·'}[st]||'·';
    return `<span class="pstage ${st}">${icon} ${s}</span>${i<PIPE_STAGES.length-1?'<span class="parr">→</span>':''}`;
  }).join('');
}

function pipeLog(msg){
  const el=document.getElementById('pipe-log');if(!el)return;
  el.textContent+=msg+'\n';el.scrollTop=el.scrollHeight;
}

function runPipeline(){
  if(pipeTimer)return;
  pipeState=PIPE_STAGES.map(()=>'idle');renderPipe();
  const el=document.getElementById('pipe-log');if(el)el.textContent='';
  pipeLog('$ git push origin main');pipeLog('$ Pipeline triggered by: zakhir.mckinnon');
  tlog('devops.pipeline_start  branch=main');
  let i=0;
  const msgs=[
    ['Building Docker image…','npm install && npm run build → SUCCESS','Image: zkm-app:2.1.4 pushed to registry'],
    ['Running unit tests…','Jest: 142 passed, 0 failed','Coverage: 87.3%'],
    ['SAST security scan…','Snyk: 0 critical, 1 low','ESLint: passed'],
    ['Blue Prism RPA validation…','Automation smoke tests: PASSED','Process definitions validated'],
    ['Rolling update: 3/3 pods…','Health check: 200 OK','Zero-downtime rollout'],
    ['✓ DEPLOYMENT COMPLETE','Version 2.1.4 live','Post-deploy load settling...'],
  ];
  pipeTimer=setInterval(()=>{
    if(i>=PIPE_STAGES.length){clearInterval(pipeTimer);pipeTimer=null;tlog('devops.pipeline_done  version=2.1.4');return;}
    pipeState[i]='running';renderPipe();const ms=msgs[i];
    setTimeout(()=>{ms.forEach(m=>pipeLog('  '+m));pipeState[i]='done';renderPipe();i++;},600);
  },1000);
}

function failPipeline(){
  if(pipeTimer)clearInterval(pipeTimer);pipeTimer=null;
  const failAt=Math.floor(Math.random()*4)+1;
  pipeState=PIPE_STAGES.map((s,i)=>i<failAt?'done':i===failAt?'fail':'idle');
  renderPipe();
  pipeLog(`\n✕ PIPELINE FAILURE at: ${PIPE_STAGES[failAt]}`);
  pipeLog('  Error: assertion failed — 3 test failures');
  pipeLog('  Rollback initiated → previous version stable');
  pipeLog('  Alert → #devops-alerts (Azure DevOps)');
  tlog(`devops.pipeline_fail  stage=${PIPE_STAGES[failAt]}`,'err');
}

function resetPipeline(){
  if(pipeTimer)clearInterval(pipeTimer);pipeTimer=null;
  pipeState=PIPE_STAGES.map(()=>'idle');renderPipe();
  const el=document.getElementById('pipe-log');if(el)el.textContent='$ Pipeline ready.\n';
}

function renderServices(){
  const el=document.getElementById('srv-grid');if(!el)return;
  el.innerHTML=services.map((s,i)=>`
<div class="srv-box" style="border-color:${s.status==='ONLINE'?s.col:s.status==='DEGRADED'?'#ffb74d':'#f44336'};" onclick="crashService(${i})">
<div class="srv-name" style="color:${s.col}">${s.name}</div>
<div class="srv-status" style="color:${s.status==='ONLINE'?'#3ddc84':s.status==='DEGRADED'?'#ffb74d':'#f44336'}">${s.status==='ONLINE'?'● ONLINE':s.status==='DEGRADED'?'▲ DEGRADED':'✕ CRASHED'}</div>
<div class="srv-bar-bg"><div class="srv-bar-fill" style="width:${s.status!=='CRASHED'?s.load:0}%;background:${s.col}"></div></div>
<div style="font-family:'VT323',monospace;font-size:14px;color:var(--dim);margin-top:2px;">${s.status==='ONLINE'?s.load+'% load':s.status==='DEGRADED'?'↑ load spike':'auto-recovering…'}</div>
</div>`).join('');
}

function crashService(i){
  const s=services[i];
  if(s.status!=='ONLINE')return;
  s.status='CRASHED';
  tlog(`devops.service_crash  svc=${s.name}`,'err');
  pipeLog(`\n⚠ ${s.name} CRASHED`);
  // Cascade: degrade dependents
  services.forEach(dep=>{
    if(SERVICE_DEPS[dep.name]?.includes(s.name)&&dep.status==='ONLINE'){
      dep.status='DEGRADED';
      dep.load=Math.min(98,dep.baseLoad+35);
      pipeLog(`  ↳ ${dep.name} DEGRADED (depends on ${s.name})`);
      tlog(`devops.cascade_degrade  svc=${dep.name}  cause=${s.name}`,'warn');
    }
  });
  renderServices();
  setTimeout(()=>{
    s.status='ONLINE';s.load=Math.floor(Math.random()*60)+20;
    pipeLog(`  ✓ ${s.name} recovered`);
    tlog(`devops.service_recover  svc=${s.name}`);
    // Restore dependents
    services.forEach(dep=>{
      if(SERVICE_DEPS[dep.name]?.includes(s.name)&&dep.status==='DEGRADED'){
        dep.status='ONLINE';dep.load=dep.baseLoad;
      }
    });
    renderServices();
  },3000);
}

// ═══════════════════════════════════════════════════════════
// PIPELINE BUILDER — Level 3 drag-drop builder
// ═══════════════════════════════════════════════════════════

// ── Stage catalogue ──
const PB_STAGES={
  lint:     {id:'lint',     label:'LINT',         icon:'◧', col:'#90caf9', tip:'Static code analysis. Catches style violations + potential bugs before build. At COGENT: ESLint on TypeScript, Roslyn analysers on C# ABP modules.'},
  build:    {id:'build',    label:'BUILD',        icon:'◉', col:'#4fc3f7', tip:'Compile & package. dotnet build / MSBuild for C# ABP project. Produces artifacts: DLL assemblies + NuGet packages.'},
  unittest: {id:'unittest', label:'UNIT TEST',    icon:'◇', col:'#3ddc84', tip:'Isolated function tests. NUnit / xUnit for C# at COGENT. Fast — runs in <30s. No external deps (mocked). Fail here = cheap fix.'},
  inttest:  {id:'inttest',  label:'INTG TEST',    icon:'◈', col:'#80cbc4', tip:'Integration tests. Spins up real DB + services. Tests full request path. Slower (2–5 min) but catches contract breaks between services.'},
  secscan:  {id:'secscan',  label:'SEC SCAN',     icon:'⚑', col:'#ffb74d', tip:'Security vulnerability scan. Trivy / Microsoft Defender for DevOps. Scans dependencies for CVEs. At COGENT: required before prod deploy.'},
  approval: {id:'approval', label:'APPROVAL',     icon:'▣', col:'#f5c518', tip:'Manual approval gate. Azure DevOps Environments → required reviewer must approve before pipeline continues. Prevents direct-to-prod pushes.'},
  artifact: {id:'artifact', label:'ARTIFACT',     icon:'⊞', col:'#ce93d8', tip:'Publish build artifacts. Azure Artifacts feed — NuGet packages, Docker images. Makes outputs available to downstream stages + other pipelines.'},
  deploy:   {id:'deploy',   label:'DEPLOY',       icon:'⬡', col:'#f44336', tip:'Deploy to environment. Azure App Service / AKS rolling update. At COGENT: deployment slots for zero-downtime swap. Always after artifact publish.'},
  notify:   {id:'notify',   label:'NOTIFY',       icon:'◎', col:'#a5d6a7', tip:'Post-run notification. Teams / Slack webhook — reports success/fail + deployment URL. Keeps the team informed without checking Azure portal.'},
};

// ── Validation rules ──
const PB_RULES=[
  {id:'no_build',    check:s=>!s.includes('build'),                      sev:'err',  msg:'No BUILD stage — cannot compile or test without it.'},
  {id:'deploy_first',check:s=>s.includes('deploy')&&s.indexOf('deploy')<s.indexOf('build'), sev:'err',  msg:'DEPLOY comes before BUILD — artifacts don\'t exist yet.'},
  {id:'test_before_deploy',check:s=>s.includes('deploy')&&!s.includes('unittest')&&!s.includes('inttest'), sev:'warn', msg:'No tests before DEPLOY — risky. Any regression goes straight to production.'},
  {id:'no_approval', check:s=>s.includes('deploy')&&!s.includes('approval'),          sev:'warn', msg:'No APPROVAL GATE before DEPLOY — direct push to prod. Acceptable for dev, not for prod.'},
  {id:'no_secscan',  check:s=>s.includes('deploy')&&!s.includes('secscan'),           sev:'warn', msg:'No SECURITY SCAN — Microsoft Defender for DevOps recommends scanning before every deploy.'},
  {id:'artifact_missing',check:s=>s.includes('deploy')&&!s.includes('artifact'),      sev:'warn', msg:'No ARTIFACT PUBLISH — deploy stage has nothing versioned to pull from. Fragile pipeline.'},
  {id:'deploy_missing',check:s=>!s.includes('deploy'),                               sev:'info', msg:'No DEPLOY stage — pipeline only validates. Add DEPLOY to ship to an environment.'},
  {id:'approval_no_deploy',check:s=>s.includes('approval')&&!s.includes('deploy'),    sev:'info', msg:'APPROVAL GATE with no DEPLOY — gate is never crossed. Redundant.'},
  {id:'lint_late',   check:s=>s.includes('lint')&&s.indexOf('lint')>s.indexOf('build'),sev:'warn',msg:'LINT runs after BUILD — lint should catch issues before compilation, not after.'},
  {id:'duplicate',   check:s=>new Set(s).size<s.length,                              sev:'warn', msg:'Duplicate stage detected — pipelines don\'t usually repeat stages in a single run.'},
];

// ── Execution log messages per stage (COGENT-flavoured) ──
const PB_LOGS={
  lint:    ['$ dotnet format --verify-no-changes','  Roslyn analyser: 0 warnings','  ESLint (TS): 0 errors, 2 warnings (non-blocking)','  ✓ Lint passed (4.1s)'],
  build:   ['$ dotnet build --configuration Release','  Restoring NuGet packages for ABP modules…','  Build succeeded — 0 error(s), 0 warning(s)','  Artifacts: zkm-api.dll, zkm-domain.dll','  ✓ Build complete (22.3s)'],
  unittest:['$ dotnet test --filter Category=Unit','  Test run for NUnit 3.x','  Passed:  94  Failed: 0  Skipped: 2','  Coverage: 81.4% (threshold: 75%)','  ✓ Unit tests passed (18.7s)'],
  inttest: ['$ dotnet test --filter Category=Integration','  Spinning up test containers (SQL Server, Redis)…','  Running 31 integration tests…','  Passed: 31  Failed: 0','  ✓ Integration tests passed (67.2s)'],
  secscan: ['$ trivy image zkm-app:latest --severity HIGH,CRITICAL','  Pulling Trivy DB (offline cache hit)','  Scanning ABP Framework 8.x dependencies…','  CRITICAL: 0  HIGH: 0  MEDIUM: 2 (accepted risk)','  ✓ Security scan passed (11.4s)'],
  approval:['$ Waiting for approval gate: Production Environment','  Required approvers: 1 of 1','  → zakhir.mckinnon approved (Azure DevOps)','  ✓ Approval granted — continuing pipeline'],
  artifact:['$ dotnet nuget push --source AzureArtifacts','  Publishing: zkm-api.1.4.2.nupkg','  Publishing: zkm-domain.1.4.2.nupkg','  Azure Artifacts feed: zkm-internal-feed','  ✓ Artifacts published (8.9s)'],
  deploy:  ['$ az webapp deployment slot swap --slot staging','  Rolling update: 3/3 instances healthy','  Health check: GET /health → 200 OK (avg 42ms)','  Zero-downtime slot swap complete','  ✓ Deployed to Production (34.1s)'],
  notify:  ['$ Sending Teams webhook notification','  Pipeline: zkm-api-pipeline · Run #47','  Status: ✓ SUCCESS · Duration: 3m 12s','  Deployment URL: https://zkm-api.azurewebsites.net','  ✓ Team notified'],
};

// ── Preset: Cogent WIL pipeline ──
const PB_PRESETS={
  cogent:['lint','build','unittest','inttest','secscan','artifact','approval','deploy'],
};

// ── State ──
let pbLane=[];       // array of stage ids in order
let pbRunning=false;
let pbDragId=null;   // id of stage being dragged from palette

// ── Init ──
function pbInit(){
  pbRenderPalette();
  pbRenderLane();
  pbClearLog();
  pbLog('info','$ Pipeline Builder — Azure DevOps edition');
  pbLog('info','$ Drag stages from the palette. Order matters.');
}

function pbRenderPalette(){
  const el=document.getElementById('pb-palette-items');
  if(!el) return;
  el.innerHTML=Object.values(PB_STAGES).map(s=>`
<div class="pb-chip" draggable="true"
     style="border-color:${s.col};color:${s.col};background:#030810;"
     ondragstart="pbDragStart(event,'${s.id}')"
     ondragend="pbDragEnd(event)">
  ${s.icon} ${s.label}
  <div class="pb-tooltip">${s.tip}</div>
</div>`).join('');
}

function pbRenderLane(){
  const lane=document.getElementById('pb-lane');
  if(!lane) return;
  const hint=document.getElementById('pb-hint');
  if(hint) hint.style.display=pbLane.length===0?'block':'none';

  // Remove existing slots/arrows but keep hint
  [...lane.children].forEach(c=>{if(c!==hint)c.remove();});

  pbLane.forEach((id,i)=>{
    const s=PB_STAGES[id];
    if(!s) return;
    if(i>0){const arr=document.createElement('div');arr.className='pb-arr';arr.textContent='→';lane.appendChild(arr);}
    const slot=document.createElement('div');
    slot.className='pb-slot st-idle';
    slot.style.borderColor=s.col;
    slot.style.color=s.col;
    slot.setAttribute('data-idx',i);
    slot.innerHTML=`${s.icon} ${s.label}<div class="pb-tooltip">${s.tip}</div>`;
    slot.onclick=()=>pbRemoveSlot(i);
    lane.appendChild(slot);
  });

  const cnt=document.getElementById('pb-slot-count');
  if(cnt) cnt.textContent=`${pbLane.length} / 8 stages`;
  // Hide score on lane change
  const sc=document.getElementById('pb-score');
  if(sc) sc.classList.remove('show');
  const pw=document.getElementById('pb-warnings');
  if(pw) pw.style.display='none';
}

// ── Drag handlers ──
function pbDragStart(e,id){
  pbDragId=id;
  e.dataTransfer.effectAllowed='copy';
  setTimeout(()=>e.target.classList.add('dragging'),0);
}
function pbDragEnd(e){e.target.classList.remove('dragging');pbDragId=null;}
function pbDragOver(e){e.preventDefault();e.dataTransfer.dropEffect='copy';document.getElementById('pb-lane').classList.add('drag-over');}
function pbDragLeave(e){document.getElementById('pb-lane').classList.remove('drag-over');}
function pbDrop(e){
  e.preventDefault();
  document.getElementById('pb-lane').classList.remove('drag-over');
  if(!pbDragId||pbRunning) return;
  if(pbLane.length>=8){pbLog('warn','Pipeline full — max 8 stages.');return;}
  pbLane.push(pbDragId);
  pbRenderLane();
  pbLog('info',`+ Added: ${PB_STAGES[pbDragId]?.label}`);
}

function pbRemoveSlot(idx){
  if(pbRunning) return;
  const removed=PB_STAGES[pbLane[idx]]?.label||'stage';
  pbLane.splice(idx,1);
  pbRenderLane();
  pbLog('info',`- Removed: ${removed}`);
}

function pbClear(){
  if(pbRunning) return;
  pbLane=[];
  pbRenderLane();
  pbClearLog();
  pbLog('info','$ Pipeline cleared.');
  const sc=document.getElementById('pb-score');
  if(sc) sc.classList.remove('show');
}

function pbLoadPreset(name){
  if(pbRunning) return;
  pbLane=[...PB_PRESETS[name]||[]];
  pbRenderLane();
  pbClearLog();
  pbLog('info',`$ Loaded preset: ${name.toUpperCase()}`);
  pbLog('info','$ This is the pipeline Zakhir worked with at COGENT.');
  pbLog('info','$ Press VALIDATE & RUN to execute it.');
}

// ── Logging ──
function pbLog(cls,msg){
  const el=document.getElementById('pb-log');
  if(!el) return;
  const span=`<span class="pb-${cls}">${msg}</span>\n`;
  el.innerHTML+=span;
  el.scrollTop=el.scrollHeight;
}
function pbClearLog(){const el=document.getElementById('pb-log');if(el)el.innerHTML='';}

// ── Validation ──
function pbValidate(){
  const ids=pbLane;
  const issues=[];
  for(const rule of PB_RULES){
    if(rule.check(ids)) issues.push({sev:rule.sev,msg:rule.msg});
  }
  return issues;
}

function pbValidateAndRun(){
  if(pbRunning){pbLog('warn','Pipeline already running.');return;}
  if(pbLane.length===0){pbLog('err','No stages added. Drag at least BUILD to start.');return;}

  const issues=pbValidate();
  const errors=issues.filter(i=>i.sev==='err');
  const warns =issues.filter(i=>i.sev==='warn');
  const infos =issues.filter(i=>i.sev==='info');

  // Show warnings panel
  const pw=document.getElementById('pb-warnings');
  if(issues.length>0&&pw){
    pw.style.display='block';
    pw.innerHTML=issues.map(i=>{
      const col=i.sev==='err'?'#f44336':i.sev==='warn'?'#ffb74d':'#4fc3f7';
      const pfx=i.sev==='err'?'✕ ERR ':i.sev==='warn'?'⚠ WARN':'ℹ INFO';
      return `<span style="color:${col};font-family:'Press Start 2P',monospace;font-size:5px;">${pfx}</span> ${i.msg}`;
    }).join('<br>');
  } else if(pw) pw.style.display='none';

  if(errors.length>0){
    pbLog('err','✕ VALIDATION FAILED — fix errors before running.');
    errors.forEach(e=>pbLog('err',`  ✕ ${e.msg}`));
    return;
  }

  // Run
  pbClearLog();
  if(warns.length>0) warns.forEach(w=>pbLog('warn',`⚠ ${w.msg}`));
  pbRunPipeline(issues);
}

// ── Execution engine ──
function pbRunPipeline(issues){
  pbRunning=true;
  tlog(`devops.pipeline_builder_run  stages=${pbLane.length}  warnings=${issues.filter(i=>i.sev==='warn').length}`);

  pbLog('info','$ git push origin feature/zkm-abp-modules');
  pbLog('info','$ Azure DevOps: pipeline triggered by zakhir.mckinnon');
  pbLog('info','$ Agent pool: Azure Pipelines (ubuntu-latest)');
  pbLog('info','$ ─────────────────────────────────────');

  // Animate stages sequentially
  const delays=pbLane.map((_,i)=>i*2200);
  let slotEls=()=>[...document.getElementById('pb-lane').querySelectorAll('.pb-slot')];

  pbLane.forEach((id,i)=>{
    const logLines=PB_LOGS[id]||[`$ Running ${id}…`,'  Done.'];
    const durationMs=1400+Math.random()*600;

    // Mark running
    setTimeout(()=>{
      const slots=slotEls();
      if(slots[i]){slots[i].className='pb-slot st-running';slots[i].style.borderColor=PB_STAGES[id]?.col||'#fff';}
      pbLog('info',`\n$ [Stage ${i+1}/${pbLane.length}] ${PB_STAGES[id]?.label}`);
    },delays[i]);

    // Stream log lines
    logLines.forEach((line,li)=>{
      setTimeout(()=>{
        const cls=line.includes('✓')?'ok':line.includes('CRITICAL')||line.includes('Failed')?'err':line.startsWith('$')||line.startsWith('  $')?'info':'ok';
        pbLog(cls,line);
      },delays[i]+300+li*280);
    });

    // Mark done
    setTimeout(()=>{
      const slots=slotEls();
      if(slots[i]){slots[i].className='pb-slot st-done';slots[i].style.background='rgba(61,220,132,.12)';}
    },delays[i]+durationMs+logLines.length*280);
  });

  // Final scorecard
  const totalMs=delays[pbLane.length-1]+2800+pbLane.length*280;
  setTimeout(()=>{
    pbRunning=false;
    pbLog('info','$ ─────────────────────────────────────');
    pbLog('ok','✓ PIPELINE COMPLETE');
    pbShowScore(issues);
    // Nudge system health
    _sysH=Math.min(100,(_sysH||80)+6);
    tlog('devops.pipeline_builder_success  slo_impact=+6%');
  },totalMs);
}

// ── Scorecard ──
function pbShowScore(issues){
  const sc=document.getElementById('pb-score');
  const grid=document.getElementById('pb-score-grid');
  const badgeEl=document.getElementById('pb-score-badge');
  const debriefEl=document.getElementById('pb-debrief');
  if(!sc||!grid) return;

  const ids=pbLane;
  const warns=issues.filter(i=>i.sev==='warn').length;
  const hasBuild=ids.includes('build');
  const hasTests=ids.includes('unittest')||ids.includes('inttest');
  const hasSec=ids.includes('secscan');
  const hasApproval=ids.includes('approval');
  const hasDeploy=ids.includes('deploy');
  const hasArtifact=ids.includes('artifact');
  const hasLint=ids.includes('lint');
  const hasNotify=ids.includes('notify');

  // Efficiency score: start 100, deduct for missing best practices
  let eff=100;
  if(!hasTests)    eff-=18;
  if(!hasSec)      eff-=12;
  if(!hasApproval&&hasDeploy) eff-=10;
  if(!hasArtifact&&hasDeploy) eff-=8;
  if(!hasLint)     eff-=5;
  if(!hasNotify)   eff-=4;
  eff=Math.max(0,eff-warns*3);

  // Maturity badge
  const badge=eff>=90?{label:'AZURE PRO',col:'#3ddc84',shadow:'#0a3a1a'}
              :eff>=70?{label:'PRACTITIONER',col:'#f5c518',shadow:'#7a5c00'}
              :        {label:'ROOKIE',col:'#f44336',shadow:'#5a0000'};

  const checks=[
    ['Build stage',      hasBuild],
    ['Tests included',   hasTests],
    ['Security scan',    hasSec],
    ['Approval gate',    hasApproval||!hasDeploy],
    ['Artifact publish', hasArtifact||!hasDeploy],
    ['Lint / analysis',  hasLint],
    ['Notification',     hasNotify],
    ['Deploy present',   hasDeploy],
  ];

  grid.innerHTML=checks.map(([label,ok])=>`
<div class="pb-score-item">
  <span style="color:${ok?'#3ddc84':'#f44336'}">${ok?'✓':'✕'}</span>
  <span style="color:var(--dim);margin-left:5px;">${label}</span>
</div>`).join('');

  badgeEl.innerHTML=`
<div style="margin-top:6px;font-family:'VT323',monospace;font-size:18px;">
  Efficiency: <span style="color:${badge.col};font-size:22px;">${eff}%</span>
</div>
<div class="pb-badge" style="border-color:${badge.col};color:${badge.col};box-shadow:2px 2px 0 ${badge.shadow};">
  ★ ${badge.label}
</div>`;

  // Debrief: what each stage in this pipeline means
  debriefEl.innerHTML=ids.map(id=>{
    const s=PB_STAGES[id];
    return s?`<div style="margin-bottom:6px;border-left:2px solid ${s.col};padding-left:8px;"><span style="color:${s.col};font-family:'Press Start 2P',monospace;font-size:5px;">${s.label}</span><br>${s.tip}</div>`:'';
  }).join('');

  sc.classList.add('show');
}

function buildArch(){
  const cards=[
    {title:'MONOLITH',col:'#90caf9',sub:'Single deployable. Used in PrintIt101 backend.',
     pros:['Simple deployment & debugging','In-process calls (~0.1ms latency)','Easy local dev'],
     cons:['Hard to scale independently','Long build times at scale','High coupling risk'],
     used:'Used this in PrintIt101 — Java Spring Boot handles all API logic in one deployable. Right choice for a team project with limited deployment complexity. Monolith is correct until you have a scaling problem worth solving.'},
    {title:'MVC PATTERN',col:'#80cbc4',sub:'Model-View-Controller. Core pattern across all projects.',
     pros:['Separation of concerns','Testable layers','Universally understood'],
     cons:['Fat controller anti-pattern','Not ideal for real-time','View can be tightly coupled'],
     used:'Applied throughout: Spring Boot MVC on backend, React component hierarchy mirrors MVC on frontend. Every academic system followed MVC. The pattern works until controllers start handling business logic they should not.'},
    {title:'MICROSERVICES',col:'#a5d6a7',sub:'Independent services. Observed at COGENT with Azure DevOps.',
     pros:['Independent scaling','Fault isolation','Technology flexibility per service'],
     cons:['Network overhead (+2–8ms per hop)','Hard to debug across services','Operational complexity'],
     used:'Worked within this architecture at COGENT. Azure DevOps deployed each service independently. Blue Prism RPA bots are effectively automation microservices. The latency cost is real — every inter-service call adds serialisation + network round-trip.'},
    {title:'EVENT-DRIVEN',col:'#ffe082',sub:'Async via message queue. Decoupled producers and consumers.',
     pros:['Highly decoupled','Scalable async workloads','Reactive and real-time capable'],
     cons:['Queue latency (12–50ms)','Eventual consistency complexity','Ordering guarantees hard'],
     used:'Studied as a design pattern. Applies to the LoL patch viewer — polling vs event-push for champion updates is exactly this trade-off. Event-driven is powerful but adds consistency complexity that often surprises teams who underestimate it.'},
  ];

  return `<div>
<div class="arch-tabs">
  <button class="arch-tab on" id="arch-tab-patterns" onclick="archTab('patterns')">◫ PATTERNS</button>
  <button class="arch-tab" id="arch-tab-layers" onclick="archTab('layers')">⊞ LAYER FLOW</button>
  <button class="arch-tab" id="arch-tab-projects" onclick="archTab('projects')">◈ PROJECTS</button>
</div>

<div id="arch-patterns">
<p style="font-family:'VT323',monospace;font-size:15px;color:var(--dim);margin-bottom:10px;line-height:1.4;">Click any architecture for Zakhir's take — where he used it, what the real latency cost is, and when not to choose it.</p>
<div style="background:#030812;border:2px solid #1a1030;padding:10px;margin-bottom:10px;">
<div style="font-family:'Press Start 2P',monospace;font-size:7px;color:#90caf9;margin-bottom:8px;letter-spacing:1px;">▶ REQUEST LATENCY VISUALISER — click to animate</div>
<canvas id="arch-lat" width="680" height="80" style="display:block;width:100%;background:#020811;border:1px solid #1a1030;cursor:pointer;" onclick="cycleArchLatency()"></canvas>
<div id="arch-lat-info" style="font-family:'VT323',monospace;font-size:15px;color:#90caf9;margin-top:5px;text-align:center;">Click to see request flow comparison</div>
</div>
<div class="arch-grid">${cards.map((c,i)=>`
<div>
<div class="arch-card" style="border-color:${c.col};" onclick="toggleArch(${i})">
<div class="arch-card-title" style="color:${c.col}">${c.title}</div>
<div class="arch-card-sub">${c.sub}</div>
</div>
<div class="arch-detail" id="arch-${i}">
<div style="font-family:'Press Start 2P',monospace;font-size:7px;color:${c.col};margin-bottom:7px;">ZAKHIR'S TAKE</div>
<div style="font-family:'VT323',monospace;font-size:15px;color:var(--white);line-height:1.6;margin-bottom:7px;border-left:2px solid ${c.col};padding-left:7px;">${c.used}</div>
<div class="arch-pros-cons">
<div class="arch-col" style="border-left:2px solid #3ddc84;"><h4 style="color:#3ddc84">✓ STRENGTHS</h4>${c.pros.map(p=>`▸ ${p}<br>`).join('')}</div>
<div class="arch-col" style="border-left:2px solid #f44336;"><h4 style="color:#f44336">✕ COSTS</h4>${c.cons.map(p=>`▸ ${p}<br>`).join('')}</div>
</div>
</div>
</div>`).join('')}
</div>
</div>

<div id="arch-layers" style="display:none;">
<p style="font-family:'VT323',monospace;font-size:15px;color:var(--dim);margin-bottom:10px;line-height:1.5;">Watch a request travel through a layered Spring Boot backend — the same structure used in PrintIt101. Click to animate the flow.</p>
<div style="display:flex;gap:14px;align-items:flex-start;flex-wrap:wrap;">
<div style="flex:0 0 auto;min-width:240px;">
  <div class="la-layer"><div class="la-box" style="border-color:#4fc3f7;color:#4fc3f7;" id="la-box-0">CLIENT</div><div class="la-label">HTTP request from browser / mobile</div></div>
  <div class="la-arrow">↓</div>
  <div class="la-layer"><div class="la-box" style="border-color:#90caf9;color:#90caf9;" id="la-box-1">CONTROLLER</div><div class="la-label">Route + validate input · return DTO</div></div>
  <div class="la-arrow">↓</div>
  <div class="la-layer"><div class="la-box" style="border-color:#a5d6a7;color:#a5d6a7;" id="la-box-2">SERVICE</div><div class="la-label">Business logic · orchestration</div></div>
  <div class="la-arrow">↓</div>
  <div class="la-layer"><div class="la-box" style="border-color:#ffb74d;color:#ffb74d;" id="la-box-3">REPOSITORY</div><div class="la-label">Data access · query abstraction</div></div>
  <div class="la-arrow">↓</div>
  <div class="la-layer"><div class="la-box" style="border-color:#f44336;color:#f44336;" id="la-box-4">DATABASE</div><div class="la-label">Persistence · SQL · transactions</div></div>
</div>
<div style="flex:1;min-width:200px;">
  <div style="font-family:'Press Start 2P',monospace;font-size:7px;color:#90caf9;margin-bottom:8px;letter-spacing:1px;">REQUEST LOG</div>
  <div id="la-log">$ Awaiting request...
</div>
  <div style="display:flex;gap:7px;margin-top:8px;flex-wrap:wrap;">
    <button class="gb" style="border-color:#90caf9;color:#90caf9;" onclick="laRunRequest('get')">▶ GET /orders</button>
    <button class="gb" style="border-color:#90caf9;color:#90caf9;" onclick="laRunRequest('post')">▶ POST /orders</button>
    <button class="gb" style="border-color:#ffb74d;color:#ffb74d;" onclick="laRunRequest('err')">✕ INJECT ERROR</button>
    <button class="gb" style="border-color:var(--dim);color:var(--dim);" onclick="laReset()">↺ RESET</button>
  </div>
  <div style="font-family:'VT323',monospace;font-size:13px;color:var(--dim);margin-top:8px;line-height:1.6;border-left:2px solid #1a2a4a;padding-left:8px;">In PrintIt101, each layer is a separate package. Controllers never touch the DB directly. Service layer holds all business rules. Repository handles all SQL via Spring Data JPA.</div>
</div>
</div>
<div style="margin-top:12px;background:#030812;border:2px solid #1a2040;padding:10px;">
<div style="font-family:'Press Start 2P',monospace;font-size:7px;color:#90caf9;margin-bottom:8px;letter-spacing:1px;">▶ EXAMPLE API CONTRACT — POST /api/orders</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
<div><div style="font-family:'Press Start 2P',monospace;font-size:6px;color:#4fc3f7;margin-bottom:5px;">REQUEST BODY</div>
<pre style="font-family:'VT323',monospace;font-size:14px;color:#7dd3fc;line-height:1.6;white-space:pre-wrap;">{
  "customerId": 42,
  "designId": "shirt_v2",
  "logoPosition": { "x": 0.5, "y": 0.3 },
  "quantity": 3
}</pre></div>
<div><div style="font-family:'Press Start 2P',monospace;font-size:6px;color:#a5d6a7;margin-bottom:5px;">RESPONSE 201</div>
<pre style="font-family:'VT323',monospace;font-size:14px;color:#a5d6a7;line-height:1.6;white-space:pre-wrap;">{
  "orderId": 1024,
  "status": "PROCESSING",
  "estimatedDelivery": "2025-12-20",
  "total": 449.85
}</pre></div>
</div>
</div>
</div>

<div id="arch-projects" style="display:none;">
<p style="font-family:'VT323',monospace;font-size:15px;color:var(--dim);margin-bottom:10px;line-height:1.5;">Real projects with GitHub links. Each one demonstrates a different area of the stack.</p>

<div class="pv-card">
  <div class="pv-card-hdr">
    <div class="pv-card-name">🎮 GAME ENGINE + VAMPIRE SURVIVORS CLONE</div>
    <div class="pv-card-links">
      <a class="pv-link gh" href="https://github.com/flyinginsectsunpig/game_demo" target="_blank">⊞ GitHub</a>
      <a class="pv-link live" href="https://game-demo-gray.vercel.app" target="_blank">▶ LIVE</a>
    </div>
  </div>
  <div class="pv-card-tech">TypeScript · Canvas API · Express · PostgreSQL · Drizzle ORM · Vercel</div>
  <div class="pv-card-desc">Custom TypeScript game engine + a Vampire Survivors-style game. Full backend with session auth and leaderboards. Live and playable now.</div>
  <ul class="pv-bullets">
    <li>Custom GameEngine: RAF loop, delta-time physics, ECS, AABB collision, spatial grid — zero frameworks</li>
    <li>SylphBlooms weapon — flower turrets with bloom-stage damage scaling and homing projectiles</li>
    <li>WaveManager spawns increasingly difficult enemy types (Basic, Fast, Tank)</li>
    <li>Express + PostgreSQL backend with Drizzle ORM · shared type contracts between client and server</li>
  </ul>
</div>

<div class="pv-card">
  <div class="pv-card-hdr">
    <div class="pv-card-name">🖨 PRINTIT101 — 3D T-SHIRT PLATFORM</div>
    <div class="pv-card-links">
      <a class="pv-link gh" href="https://github.com/flyinginsectsunpig/PrintIt101" target="_blank">⊞ Backend</a>
      <a class="pv-link gh" href="https://github.com/flyinginsectsunpig/printit101client1" target="_blank">⊞ Frontend</a>
    </div>
  </div>
  <div class="pv-card-tech">Java · Spring Boot · React · Three.js · TypeScript · REST API</div>
  <div class="pv-card-desc">Full-stack team project. 3D shirt customisation with real-time logo placement. Layered Spring Boot backend with separated controller, service, and repository packages.</div>
  <ul class="pv-bullets">
    <li>REST endpoints for order management, design upload, validation, and status tracking</li>
    <li>React + Three.js client consumes backend APIs with error state handling</li>
    <li>176 commits backend · 89 commits frontend — active collaborative version control</li>
  </ul>
</div>

<div class="pv-card">
  <div class="pv-card-hdr">
    <div class="pv-card-name">⚔ LOL SKIN BUFF/NERF TRACKER</div>
    <div class="pv-card-links">
      <a class="pv-link gh" href="https://github.com/flyinginsectsunpig/LoL-Skin-Buff-Nerf" target="_blank">⊞ GitHub</a>
    </div>
  </div>
  <div class="pv-card-tech">Python · Streamlit · scikit-learn · BeautifulSoup · Pandas</div>
  <div class="pv-card-desc">Data scraping and analytics platform. Multi-stage pipeline scrapes patch data, ML classifier predicts buff/nerf/bugfix from patch note text.</div>
  <ul class="pv-bullets">
    <li>Patch chronology → champion history → pick rates → merged CSV pipeline</li>
    <li>AI Change Classifier — scikit-learn classification from raw patch note text</li>
    <li>Streamlit dashboard: Patch History, Skin History, Data Analytics pages</li>
  </ul>
</div>
</div>

</div>`;}

function archTab(which){
  ['patterns','layers','projects'].forEach(t=>{
    const el=document.getElementById('arch-'+t);
    if(el) el.style.display=t===which?'':'none';
    const tab=document.getElementById('arch-tab-'+t);
    if(tab) tab.classList.toggle('on',t===which);
  });
  if(which==='patterns') setTimeout(()=>startArchLatAnim(),200);
  if(which==='layers') laReset();
}
const _ARCH_FLOWS=[
  {name:'MONOLITH',col:'#90caf9',hops:[{label:'Client',ms:0},{label:'App (all-in-one)',ms:1.2},{label:'DB',ms:4.1}]},
  {name:'MVC',col:'#80cbc4',hops:[{label:'Client',ms:0},{label:'Controller',ms:0.3},{label:'Service',ms:0.8},{label:'Model',ms:0.4},{label:'DB',ms:4.1}]},
  {name:'MICROSERVICES',col:'#a5d6a7',hops:[{label:'Client',ms:0},{label:'Gateway',ms:2.1},{label:'Auth',ms:3.4},{label:'API Svc',ms:2.8},{label:'Data Svc',ms:3.1},{label:'DB',ms:4.1}]},
  {name:'EVENT-DRIVEN',col:'#ffe082',hops:[{label:'Client',ms:0},{label:'Producer',ms:1.1},{label:'Queue',ms:18.0},{label:'Consumer',ms:2.3},{label:'DB',ms:4.1}]},
];
let _archLatIdx=0,_archLatAnim=null,_archLatDot=0;

function cycleArchLatency(){
  _archLatIdx=(_archLatIdx+1)%_ARCH_FLOWS.length;
  startArchLatAnim();
}

function startArchLatAnim(){
  if(_archLatAnim) cancelAnimationFrame(_archLatAnim);
  const flow=_ARCH_FLOWS[_archLatIdx];
  const cv=document.getElementById('arch-lat');
  if(!cv)return;
  const ctx2=cv.getContext('2d');
  const w=cv.width,h=cv.height;
  const hops=flow.hops;
  const totalMs=hops.reduce((s,h)=>s+h.ms,0);
  const xs=hops.map((_,i)=>w*0.08+i*(w*0.84/(hops.length-1)));
  let dotX=xs[0],dotSegment=0,dotProgress=0;
  let startTs=null;
  const DURATION=2200;

  function draw(ts){
    if(!startTs)startTs=ts;
    const t=Math.min(1,(ts-startTs)/DURATION);
    // Which segment?
    const cumMs=[];let cum=0;
    hops.forEach((h,i)=>{if(i>0){cum+=h.ms;cumMs.push(cum);}});
    const tMs=t*totalMs;
    let seg=0;let segT=0;
    for(let i=0;i<cumMs.length;i++){if(tMs>=cumMs[i])seg=i+1;}
    if(seg<hops.length-1){
      const segStart=seg>0?cumMs[seg-1]:0;
      const segEnd=cumMs[seg]||totalMs;
      segT=(tMs-segStart)/(segEnd-segStart+.001);
    } else segT=1;
    const dotXPos=seg<xs.length-1?xs[seg]+segT*(xs[seg+1]-xs[seg]):xs[xs.length-1];

    ctx2.fillStyle='#020811';ctx2.fillRect(0,0,w,h);
    // Draw lines
    ctx2.strokeStyle='#1a2040';ctx2.lineWidth=2;
    ctx2.beginPath();ctx2.moveTo(xs[0],h/2);ctx2.lineTo(xs[xs.length-1],h/2);ctx2.stroke();
    // Completed segments glow
    const doneX=Math.min(dotXPos,xs[xs.length-1]);
    ctx2.strokeStyle=flow.col+'99';ctx2.lineWidth=2;
    ctx2.beginPath();ctx2.moveTo(xs[0],h/2);ctx2.lineTo(doneX,h/2);ctx2.stroke();
    // Nodes
    hops.forEach((hp,i)=>{
      const x=xs[i];
      const passed=dotXPos>=x;
      ctx2.fillStyle=passed?flow.col:'#2a2a3a';
      ctx2.strokeStyle=flow.col;ctx2.lineWidth=1;
      ctx2.beginPath();ctx2.arc(x,h/2,8,0,Math.PI*2);ctx2.fill();ctx2.stroke();
      ctx2.fillStyle=passed?'#050510':'var(--dim)';
      ctx2.font='7px VT323,monospace';ctx2.textAlign='center';
      ctx2.fillText(hp.label,x,h/2+22);
      if(i>0){
        ctx2.fillStyle='#ffb74d';ctx2.font='7px VT323,monospace';
        ctx2.fillText('+'+hp.ms.toFixed(1)+'ms',x,h/2-16);
      }
    });
    // Moving dot
    ctx2.shadowColor=flow.col;ctx2.shadowBlur=12;
    ctx2.fillStyle=flow.col;ctx2.beginPath();ctx2.arc(dotXPos,h/2,5,0,Math.PI*2);ctx2.fill();
    ctx2.shadowBlur=0;
    // Info
    const infoEl=document.getElementById('arch-lat-info');
    if(infoEl) infoEl.textContent=`${flow.name} · Total: ${totalMs.toFixed(1)}ms · ${hops.length-1} hop${hops.length>2?'s':''} · click for next`;

    if(t<1) _archLatAnim=requestAnimationFrame(draw);
    else _archLatAnim=null;
  }
  _archLatAnim=requestAnimationFrame(draw);
}

// Auto-start first latency flow after arch modal opens
function initArch(){setTimeout(()=>startArchLatAnim(),200);}

function toggleArch(i){const el=document.getElementById('arch-'+i);if(el)el.classList.toggle('show');}

// ── Layered Architecture Animator ──
const LA_LAYERS=[
  {id:0,col:'#4fc3f7',name:'CLIENT'},
  {id:1,col:'#90caf9',name:'CONTROLLER'},
  {id:2,col:'#a5d6a7',name:'SERVICE'},
  {id:3,col:'#ffb74d',name:'REPOSITORY'},
  {id:4,col:'#f44336',name:'DATABASE'},
];

const LA_REQUESTS={
  get:{
    label:'GET /api/orders/42',
    downLogs:[
      '→ [CONTROLLER] GET /api/orders/42  validate: orderId=42 ✓',
      '→ [SERVICE]    orderService.findById(42)  applying business rules',
      '→ [REPOSITORY] orderRepository.findById(42)  translating to SQL',
      '→ [DATABASE]   SELECT * FROM orders WHERE id=42  (idx scan 3.2ms)',
    ],
    upLogs:[
      '← [DATABASE]   1 row returned',
      '← [REPOSITORY] mapped to Order entity',
      '← [SERVICE]    enriched with delivery estimate',
      '← [CONTROLLER] serialised to OrderDTO  200 OK',
    ],
  },
  post:{
    label:'POST /api/orders',
    downLogs:[
      '→ [CONTROLLER] POST /api/orders  validate body: customerId, designId, qty ✓',
      '→ [SERVICE]    orderService.create()  check inventory, apply pricing rules',
      '→ [REPOSITORY] orderRepository.save(order)  begin transaction',
      '→ [DATABASE]   INSERT INTO orders ...  COMMIT (4.8ms)',
    ],
    upLogs:[
      '← [DATABASE]   orderId=1024 generated',
      '← [REPOSITORY] entity saved, transaction committed',
      '← [SERVICE]    order confirmed, email queued',
      '← [CONTROLLER] 201 CREATED  { orderId: 1024, status: "PROCESSING" }',
    ],
  },
  err:{
    label:'POST /api/orders (bad input)',
    downLogs:[
      '→ [CONTROLLER] POST /api/orders  validate body...',
      '✕ [CONTROLLER] Validation FAILED: customerId missing',
    ],
    upLogs:[
      '← [CONTROLLER] 400 BAD REQUEST  { error: "customerId is required" }',
      '  No downstream layers called — fail fast at boundary ✓',
    ],
    error:true,
    stopAt:1,
  },
};

let _laRunning=false;

function laLog(msg,col=''){
  const el=document.getElementById('la-log');
  if(!el)return;
  const span=col?`<span style="color:${col}">${msg}</span>`:`<span>${msg}</span>`;
  el.innerHTML+=span+'\n';
  el.scrollTop=el.scrollHeight;
}

function laHighlight(idx,on,col){
  const box=document.getElementById('la-box-'+idx);
  if(!box)return;
  if(on){
    box.style.background=col+'22';
    box.style.boxShadow=`0 0 14px ${col}`;
  } else {
    box.style.background='';
    box.style.boxShadow='';
  }
}

function laReset(){
  _laRunning=false;
  LA_LAYERS.forEach(l=>laHighlight(l.id,false,l.col));
  const el=document.getElementById('la-log');
  if(el) el.innerHTML='$ Awaiting request...\n';
}

function laRunRequest(type){
  if(_laRunning)return;
  const req=LA_REQUESTS[type];
  if(!req)return;
  _laRunning=true;
  laReset();
  _laRunning=true;
  const stopAt=req.stopAt??LA_LAYERS.length-1;
  laLog(`$ ${req.label}`,'#4fc3f7');

  // Animate down
  let delay=0;
  for(let i=0;i<=stopAt;i++){
    const ii=i;
    setTimeout(()=>{
      laHighlight(ii,true,LA_LAYERS[ii].col);
      if(req.downLogs[ii]) laLog(req.downLogs[ii], req.error&&ii===stopAt?'#f44336':'#3ddc84');
    },delay);
    delay+=500;
  }

  // Animate up (reversed) — skip if error stops early
  if(!req.error||stopAt===LA_LAYERS.length-1){
    req.upLogs.forEach((_,j)=>{
      const revI=stopAt-j;
      setTimeout(()=>{
        laHighlight(revI,false,LA_LAYERS[revI]?.col||'#fff');
        if(req.upLogs[j]) laLog(req.upLogs[j],'#90caf9');
        if(j===req.upLogs.length-1){
          laLog('$ ─── Request complete ───','#3ddc84');
          _laRunning=false;
        }
      },delay+j*500);
    });
  } else {
    setTimeout(()=>{
      req.upLogs.forEach(l=>laLog(l,'#f44336'));
      laLog('$ ─── Request rejected at boundary ───','#ffb74d');
      _laRunning=false;
    },delay);
  }
} // — Live SRE Incident Simulator
// ═══════════════════════════════════════════════════════════

// ── Incident definitions — each has a root cause, branching actions, and observability data ──
const INCIDENTS=[
  {
    id:'db_latency',
    title:'INCIDENT-001 · DB Latency Spike',
    severity:'HIGH',
    arch:'Microservices — API → Auth → Data Svc → DB',  // cross-links Arch Museum
    summary:'P90 latency jumped from 80ms to 410ms 7 minutes ago. Error rate climbing. SLO at risk.',
    rootCause:'db_query', // hidden from user initially
    baseMetrics:{cpu:32,mem:48,dbLatency:410,rps:180,errorRate:0.2,connPool:94,cacheHit:41},
    archNote:'In a microservices architecture, DB latency is amplified — each service hop adds overhead. See Architecture Museum for latency cost breakdown.',
    logs:[
      '[08:14:01] WARN  DataSvc: query timeout after 408ms  table=sessions',
      '[08:14:03] ERROR ApiGateway: upstream timeout  svc=data-svc  attempt=2/3',
      '[08:14:05] WARN  DataSvc: connection pool 94/100  nearing exhaustion',
      '[08:14:07] ERROR AuthSvc: DB read failed  latency=391ms',
      '[08:14:09] WARN  Metrics: SLO burn rate 3.4×  budget_remaining=61%',
    ],
    traces:[
      'TraceID: a4f2c8  total=412ms',
      '  → Gateway        2.1ms',
      '  → AuthSvc       18.4ms  (DB call: 15.1ms)',
      '  → DataSvc      388.3ms  ← SLOW  (DB call: 385.0ms)',
      '  → Response        3.2ms',
    ],
    queryPlan:[
      'EXPLAIN ANALYZE  SELECT * FROM sessions WHERE nanny_id=? AND status=?',
      '→ Seq Scan on sessions  (rows=48204)  cost=0.00..1840.20  ← FULL TABLE SCAN',
      '→ Filter: status=ACTIVE AND nanny_id=X',
      '→ Rows removed by filter: 47891',
      '→ Actual time: 382.4ms  Buffers: 18402 shared hit',
      '',
      '⚠ Missing index on (nanny_id, status)',
      '  Estimated fix: CREATE INDEX CONCURRENTLY — drops to ~2ms',
    ],
    recentDeploys:[
      '08:02 — data-svc v2.4.1 deployed  (connection pool config unchanged)',
      '07:48 — sessions table: added 2 new columns, no index migration',  // root cause
      '06:30 — auth-svc v1.9.0 deployed  (no DB changes)',
    ],
    actions:[
      {
        id:'check_db',label:'🔍 Inspect DB',icon:'🔍',
        desc:'Run EXPLAIN ANALYZE on the slow query path.',
        correct:true,
        effect:{dbLatency:-5,cpu:0,mem:0,errorRate:0,connPool:0,cost:0},
        reveal:'queryPlan',
        outcome:'✓ EXPLAIN confirms full table scan on sessions. Missing index on (nanny_id, status). Root cause identified.',
        next:'add_index',
      },
      {
        id:'scale_service',label:'⬆ Scale Data Svc',icon:'⬆',
        desc:'Add 2 more instances of DataSvc to handle load.',
        correct:false,
        effect:{dbLatency:+15,cpu:-18,mem:-10,errorRate:+0.1,connPool:+28,cost:+23},
        outcome:'✗ More instances = more connections to same slow DB. Connection pool jumps to 122/100, DB overloaded further. Issue unresolved, cost +$23/hr.',
        next:null,
      },
      {
        id:'rollback',label:'↩ Rollback Deploy',icon:'↩',
        desc:'Rollback data-svc to v2.4.0.',
        correct:false,
        effect:{dbLatency:-20,cpu:+5,mem:0,errorRate:-0.05,connPool:-5,cost:+8},
        outcome:'⚠ Partial improvement — rollback removed new columns but missing index predates deploy. Latency still 390ms. Not the root cause.',
        next:'check_db',
      },
      {
        id:'clear_cache',label:'🔄 Flush Cache',icon:'🔄',
        desc:'Flush the application cache layer.',
        correct:false,
        effect:{dbLatency:+40,cpu:+12,mem:-8,errorRate:+0.3,connPool:+18,cost:0},
        outcome:'✗ Cache flush forces every request to hit DB directly. Latency spikes to 450ms, error rate climbs to 0.5%. Wrong lever.',
        next:null,
      },
    ],
    fixAction:{
      id:'add_index',label:'⚡ Add Missing Index',icon:'⚡',
      desc:'CREATE INDEX CONCURRENTLY idx_sessions_nanny_status ON sessions(nanny_id, status)',
      effect:{dbLatency:-385,cpu:-8,mem:+3,errorRate:-0.18,connPool:-60,cost:0},
      outcome:'✓ RESOLVED. Index created concurrently — zero downtime. Query time: 382ms → 2ms. Connection pool: 94 → 34. Error rate nominal.',
    },
  },
  {
    id:'memory_leak',
    title:'INCIDENT-002 · Memory Leak — API Server',
    severity:'CRITICAL',
    arch:'Monolith — all services in one process',
    summary:'API Server memory climbing 12MB/minute. Pods OOMKilled twice in last hour. Node restarts causing 18s downtime windows.',
    rootCause:'unbounded_cache',
    baseMetrics:{cpu:71,mem:89,dbLatency:42,rps:240,errorRate:1.8,connPool:28,cacheHit:98},
    archNote:'In a monolith, a memory leak in one module affects the entire process. Monolith fragility vs microservice isolation — see Architecture Museum.',
    logs:[
      '[09:22:14] WARN  HeapMonitor: heap 89% — threshold 85%',
      '[09:22:31] WARN  HeapMonitor: heap 91% — GC pressure increasing',
      '[09:22:48] ERROR ApiServer: OutOfMemoryError  — pod restarting',
      '[09:23:06] INFO  ApiServer: pod restarted  downtime=18s',
      '[09:24:01] WARN  HeapMonitor: heap 71% — climbing again at 12MB/min',
    ],
    traces:[
      'TraceID: b8d1a3  total=44ms (normal)',
      '  → RequestHandler    2ms',
      '  → ResponseCache   38ms  ← heap allocation per request',
      '  → Serialise          4ms',
      '',
      'HEAP PROFILE (top allocations):',
      '  ResponseCache.store()   +1.2MB/req  ← unbounded Map',
      '  Session.tokenStore()    +0.1MB/req',
    ],
    queryPlan:[
      'HEAP SNAPSHOT diff (T+5min vs T+0):',
      '  Map<RequestId, Response>  +580MB  ← LEAK SOURCE',
      '  String (response bodies)  +210MB',
      '  Buffer (serialised)       +88MB',
      '',
      'ResponseCache has no eviction policy.',
      'Every unique URL is stored permanently.',
      'Fix: LRU cache with maxSize=500 + TTL=60s',
    ],
    recentDeploys:[
      '09:10 — api-server v3.1.2 deployed  (added response caching for perf)',  // root cause
      '08:45 — db-primary: read replica added',
      '07:30 — auth-svc v2.0.1 deployed',
    ],
    actions:[
      {
        id:'check_db',label:'📊 Heap Dump',icon:'📊',
        desc:'Capture and analyse a heap snapshot.',
        correct:true,
        reveal:'queryPlan',
        effect:{cpu:+5,mem:0,dbLatency:0,errorRate:0,connPool:0,cost:0},
        outcome:'✓ Heap snapshot shows ResponseCache.store() accumulating 1.2MB per unique request. Unbounded Map with no eviction. Root cause found.',
        next:'fix_cache',
      },
      {
        id:'scale_service',label:'⬆ Scale Horizontally',icon:'⬆',
        desc:'Spin up 3 more pod replicas.',
        correct:false,
        effect:{cpu:-20,mem:0,dbLatency:0,errorRate:-0.4,connPool:0,cost:+45},
        outcome:'⚠ Buys time — load spread reduces leak rate per pod. But each pod still leaks. All 4 pods will OOMKill within 20 minutes. Cost +$45/hr.',
        next:'check_db',
      },
      {
        id:'rollback',label:'↩ Rollback v3.1.2',icon:'↩',
        desc:'Rollback api-server to v3.1.0 (pre-cache change).',
        correct:true,
        reveal:null,
        effect:{cpu:-15,mem:-40,dbLatency:+8,errorRate:-1.4,connPool:0,cost:0},
        outcome:'✓ Correct immediate action. Heap growth stops. Memory slowly reclaimed by GC. Latency +8ms without cache — acceptable. Proper fix needed next.',
        next:'fix_cache',
      },
      {
        id:'clear_cache',label:'🔄 Restart Pod',icon:'🔄',
        desc:'Manually restart the leaking pod.',
        correct:false,
        effect:{cpu:-30,mem:-60,dbLatency:0,errorRate:+0.8,connPool:0,cost:0},
        outcome:'⚠ Restart clears memory — but leak resumes immediately. Error rate spikes during 18s restart window. Treating symptom, not cause.',
        next:'check_db',
      },
    ],
    fixAction:{
      id:'fix_cache',label:'⚡ Fix Cache Eviction',icon:'⚡',
      desc:'Replace unbounded Map with LRU cache: maxSize=500, TTL=60s. Deploy v3.1.3.',
      effect:{cpu:-28,mem:-55,dbLatency:+2,errorRate:-1.7,connPool:0,cost:0},
      outcome:'✓ RESOLVED. Heap stable at 34%. GC pressure nominal. Cache still provides 94% hit rate with eviction. Deploy 3 minutes after root cause identified.',
    },
  },
];

// ── Simulator state ──
let _inc=null,_metrics={},_startTime=0,_actions=[],_phase='pick',_advMode=false,_resolved=false;
let _incTimer=null;

function buildProb(){
  return `<div>
<div style="font-family:'Press Start 2P',monospace;font-size:8px;color:#ef9a9a;margin-bottom:10px;letter-spacing:1px;">⚔ SRE INCIDENT SIMULATOR — you are on-call</div>
<p style="font-family:'VT323',monospace;font-size:15px;color:var(--dim);margin-bottom:10px;line-height:1.5;">You are receiving a live incident. Interpret the metrics, use observability tools, make decisions — each choice has consequences. This is how Zakhir actually debugs.</p>
<div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap;">
<button class="prob-btn" onclick="startIncident(0)" style="flex:1;min-width:200px;">
  🗄 INCIDENT-001<br><span style="font-size:10px;opacity:.8;">DB Latency Spike · P90 410ms</span><br><span style="font-size:8px;color:#f44336;">SEVERITY: HIGH</span>
</button>
<button class="prob-btn" onclick="startIncident(1)" style="flex:1;min-width:200px;">
  💀 INCIDENT-002<br><span style="font-size:10px;opacity:.8;">Memory Leak · OOMKill</span><br><span style="font-size:8px;color:#f44336;">SEVERITY: CRITICAL</span>
</button>
</div>
<div id="prob-sim" style="display:none;"></div>
</div>`;}

function startIncident(idx){
  _inc=INCIDENTS[idx];
  _metrics=Object.assign({},_inc.baseMetrics);
  _startTime=Date.now();
  _actions=[];
  _phase='investigate';
  _resolved=false;
  _advMode=false;
  document.getElementById('prob-sim').style.display='block';
  renderSim();
  tlog(`prob.incident_start  id=${_inc.id}  severity=${_inc.severity}`);
  // Live metric drift — makes it feel real
  if(_incTimer) clearInterval(_incTimer);
  _incTimer=setInterval(()=>{
    if(_resolved||_phase==='resolved') return;
    // Slowly worsen over time if unresolved
    _metrics.dbLatency=Math.min(800,_metrics.dbLatency+(Math.random()*4-1));
    _metrics.errorRate=Math.min(5,_metrics.errorRate+(Math.random()*.02));
    _metrics.connPool=Math.min(100,_metrics.connPool+(Math.random()*2-0.5));
    renderMetrics();
  },2000);
}

function renderSim(){
  const el=document.getElementById('prob-sim');if(!el)return;
  const elapsed=Math.round((Date.now()-_startTime)/1000);
  const mins=Math.floor(elapsed/60),secs=elapsed%60;
  const timeStr=`${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;

  el.innerHTML=`
<!-- Header -->
<div style="background:#0d0005;border:2px solid #f44336;padding:10px;margin-bottom:8px;">
  <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:6px;">
    <div>
      <div style="font-family:'Press Start 2P',monospace;font-size:7px;color:#f44336;margin-bottom:4px;">${_inc.title}</div>
      <div style="font-family:'VT323',monospace;font-size:13px;color:var(--white);">${_inc.summary}</div>
    </div>
    <div style="text-align:right;">
      <div style="font-family:'Press Start 2P',monospace;font-size:7px;color:#ffb74d;" id="prob-timer">${timeStr}</div>
      <div style="font-family:'VT323',monospace;font-size:11px;color:var(--dim);margin-top:3px;">elapsed</div>
    </div>
  </div>
  <div style="font-family:'VT323',monospace;font-size:11px;color:#90caf9;margin-top:5px;border-left:2px solid #90caf9;padding-left:6px;">
    🏛 Arch context: ${_inc.archNote}
  </div>
</div>

<!-- Metrics panel -->
<div id="prob-metrics" style="background:#030812;border:2px solid #1a1030;padding:10px;margin-bottom:8px;">
  <div style="font-family:'Press Start 2P',monospace;font-size:6px;color:#ef9a9a;margin-bottom:8px;">▶ LIVE SYSTEM METRICS</div>
  ${renderMetricsHTML()}
</div>

<!-- Mode toggle + action log -->
<div style="display:flex;gap:8px;margin-bottom:8px;align-items:center;">
  <div style="font-family:'Press Start 2P',monospace;font-size:5px;color:var(--dim);">MODE:</div>
  <button onclick="toggleAdvMode()" style="font-family:'Press Start 2P',monospace;font-size:5px;background:${_advMode?'#ef9a9a':'transparent'};color:${_advMode?'#0a0005':'#ef9a9a'};border:1px solid #ef9a9a;padding:3px 7px;cursor:pointer;">
    ${_advMode?'ADVANCED ▼':'BEGINNER ▶'}
  </button>
  <div style="font-family:'VT323',monospace;font-size:11px;color:var(--dim);">${_advMode?'Thread pool · conn pool · cache hit rate visible':'Core metrics only'}</div>
</div>

<!-- Observability tools -->
<div style="background:#030812;border:2px solid #1a1030;padding:10px;margin-bottom:8px;">
  <div style="font-family:'Press Start 2P',monospace;font-size:6px;color:#4fc3f7;margin-bottom:7px;">🔭 OBSERVABILITY TOOLS</div>
  <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px;">
    <button class="gb" style="border-color:#4fc3f7;color:#4fc3f7;" onclick="showObs('logs')">📋 View Logs</button>
    <button class="gb" style="border-color:#ce93d8;color:#ce93d8;" onclick="showObs('traces')">🔗 Trace</button>
    <button class="gb" style="border-color:#ffb74d;color:#ffb74d;" onclick="showObs('queryPlan')">🗄 Query Plan</button>
    <button class="gb" style="border-color:#3ddc84;color:#3ddc84;" onclick="showObs('recentDeploys')">🚀 Deploys</button>
  </div>
  <div id="obs-out" style="font-family:'VT323',monospace;font-size:12px;color:#7dd3fc;background:#020810;border:1px solid #0d1a2e;padding:8px;display:none;line-height:1.7;white-space:pre;overflow-x:auto;max-height:140px;overflow-y:auto;"></div>
</div>

<!-- Action panel -->
<div style="background:#030812;border:2px solid #1a1030;padding:10px;margin-bottom:8px;">
  <div style="font-family:'Press Start 2P',monospace;font-size:6px;color:#ef9a9a;margin-bottom:7px;">⚡ ACTIONS — each has consequences</div>
  <div id="prob-actions" style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
    ${renderActionsHTML()}
  </div>
</div>

<!-- Action log / feedback -->
<div id="prob-log" style="font-family:'VT323',monospace;font-size:12px;color:var(--dim);border-left:2px solid #1a1030;padding:6px 10px;line-height:1.8;min-height:32px;">
Waiting for your first action...
</div>`;

  startTimerTick();
}

function renderMetricsHTML(){
  const m=_metrics;
  const latCol=m.dbLatency>300?'#f44336':m.dbLatency>100?'#ffb74d':'#3ddc84';
  const errCol=m.errorRate>1?'#f44336':m.errorRate>0.3?'#ffb74d':'#3ddc84';
  const memCol=m.mem>85?'#f44336':m.mem>70?'#ffb74d':'#3ddc84';
  const poolCol=(m.connPool||0)>80?'#f44336':(m.connPool||0)>60?'#ffb74d':'#3ddc84';
  const cacheCol=(m.cacheHit||0)<50?'#f44336':(m.cacheHit||0)<75?'#ffb74d':'#3ddc84';

  const basicMetrics=[
    {label:'CPU',val:m.cpu+'%',bar:m.cpu,col:m.cpu>80?'#f44336':m.cpu>60?'#ffb74d':'#3ddc84'},
    {label:'Memory',val:m.mem+'%',bar:m.mem,col:memCol},
    {label:'DB Latency',val:m.dbLatency.toFixed(0)+'ms ↑',bar:Math.min(100,m.dbLatency/8),col:latCol},
    {label:'Request Rate',val:m.rps+' rps',bar:Math.min(100,m.rps/4),col:'#4fc3f7'},
    {label:'Error Rate',val:m.errorRate.toFixed(2)+'%',bar:Math.min(100,m.errorRate*20),col:errCol},
  ];
  const advMetrics=[
    {label:'Conn Pool',val:(m.connPool||0)+'/100',bar:m.connPool||0,col:poolCol},
    {label:'Cache Hit',val:(m.cacheHit||0)+'%',bar:m.cacheHit||0,col:cacheCol},
  ];

  const allMetrics=_advMode?[...basicMetrics,...advMetrics]:basicMetrics;

  return allMetrics.map(m=>`
<div style="display:flex;align-items:center;gap:8px;margin-bottom:5px;">
  <div style="font-family:'Press Start 2P',monospace;font-size:5px;color:var(--dim);width:72px;flex-shrink:0;">${m.label}</div>
  <div style="flex:1;height:6px;background:#0a0a1a;position:relative;">
    <div style="height:100%;width:${Math.round(m.bar)}%;background:${m.col};transition:width .6s;"></div>
  </div>
  <div style="font-family:'VT323',monospace;font-size:14px;color:${m.col};width:68px;text-align:right;">${m.val}</div>
</div>`).join('');
}

function renderMetrics(){
  const el=document.getElementById('prob-metrics');if(!el)return;
  el.innerHTML=`<div style="font-family:'Press Start 2P',monospace;font-size:6px;color:#ef9a9a;margin-bottom:8px;">▶ LIVE SYSTEM METRICS</div>${renderMetricsHTML()}`;
}

function renderActionsHTML(){
  const available=_inc.actions;
  return available.map(a=>`
<button onclick="takeAction('${a.id}')" style="font-family:'VT323',monospace;font-size:13px;background:#04060f;border:1px solid #2a1a3a;color:var(--white);padding:8px 10px;cursor:pointer;text-align:left;line-height:1.4;transition:border-color .2s;" onmouseover="this.style.borderColor='#ef9a9a'" onmouseout="this.style.borderColor='#2a1a3a'">
  <span style="font-size:16px;">${a.icon}</span> <strong>${a.label}</strong><br>
  <span style="font-size:11px;color:var(--dim);">${a.desc}</span>
</button>`).join('');
}

function showObs(type){
  const el=document.getElementById('obs-out');if(!el)return;
  const data=_inc[type]||[];
  el.style.display='block';
  el.textContent=data.join('\n');
  tlog(`prob.obs_used  type=${type}  incident=${_inc.id}`);
  // If this is queryPlan, mark it as investigated
  if(type==='queryPlan'&&!_actions.includes('obs_queryPlan')){
    _actions.push('obs_queryPlan');
  }
}

function toggleAdvMode(){
  _advMode=!_advMode;
  renderSim();
}

function takeAction(actionId){
  const action=_inc.actions.find(a=>a.id===actionId);if(!action)return;

  // Apply metric effects
  Object.entries(action.effect).forEach(([k,v])=>{
    if(_metrics[k]!==undefined) _metrics[k]=Math.max(0,_metrics[k]+v);
  });
  _actions.push(actionId);

  // Reveal observability data if action unlocks it
  if(action.reveal){
    showObs(action.reveal);
  }

  // Log feedback
  const logEl=document.getElementById('prob-log');
  if(logEl){
    const elapsed=Math.round((Date.now()-_startTime)/1000);
    const col=action.correct?'#3ddc84':action.outcome.startsWith('✓')?'#3ddc84':'#f44336';
    logEl.innerHTML+=`<div style="color:${col};margin-top:3px;">[${elapsed}s] ${action.outcome}</div>`;
    logEl.scrollTop=logEl.scrollHeight;
  }

  tlog(`prob.action  id=${actionId}  correct=${action.correct}`,'warn');

  // Update metrics display
  renderMetrics();

  // If action leads to fix, replace actions with fix button
  if(action.next==='add_index'||action.next==='fix_cache'){
    showFixAction();
  }

  // Check if we need to add escalation scenario after wrong action
  if(!action.correct){
    escalateIncident(action);
  }
}

function showFixAction(){
  const fix=_inc.fixAction;
  const actEl=document.getElementById('prob-actions');if(!actEl)return;
  // Add fix button prominently
  const fixBtn=document.createElement('div');
  fixBtn.style.gridColumn='1/-1';
  fixBtn.innerHTML=`
<button onclick="applyFix()" style="font-family:'Press Start 2P',monospace;font-size:6px;background:#0a2a0a;border:2px solid #3ddc84;color:#3ddc84;padding:10px 14px;cursor:pointer;width:100%;margin-top:4px;letter-spacing:1px;">
  ${fix.icon} ${fix.label}<br>
  <span style="font-family:'VT323',monospace;font-size:11px;color:var(--dim);margin-top:3px;display:block;">${fix.desc}</span>
</button>`;
  actEl.appendChild(fixBtn);
}

function applyFix(){
  if(!_inc)return;
  const fix=_inc.fixAction;
  Object.entries(fix.effect).forEach(([k,v])=>{
    if(_metrics[k]!==undefined) _metrics[k]=Math.max(0,_metrics[k]+v);
  });
  _resolved=true;
  _phase='resolved';
  if(_incTimer){clearInterval(_incTimer);_incTimer=null;}

  const elapsed=Date.now()-_startTime;
  const mins=Math.floor(elapsed/60000);
  const secs=Math.floor((elapsed%60000)/1000);
  const wrongActions=_actions.filter(a=>_inc.actions.find(x=>x.id===a&&!x.correct)).length;
  const efficiency=Math.max(20,100-wrongActions*18-Math.floor(elapsed/30000)*5);
  const obsUsed=_actions.filter(a=>a.startsWith('obs_')).length;
  const downtimeEst=wrongActions*18+10;

  document.getElementById('prob-sim').innerHTML+=`
<div style="background:#061a06;border:2px solid #3ddc84;padding:14px;margin-top:8px;">
  <div style="font-family:'Press Start 2P',monospace;font-size:8px;color:#3ddc84;margin-bottom:12px;letter-spacing:2px;">✓ INCIDENT RESOLVED</div>
  <div style="font-family:'VT323',monospace;font-size:13px;color:var(--white);margin-bottom:4px;">${fix.outcome}</div>
  <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:8px;">
    ${[
      ['Incident Duration',`${mins}m ${secs}s`,'#ffb74d'],
      ['Wrong Actions',`${wrongActions}`,(wrongActions===0?'#3ddc84':wrongActions<3?'#ffb74d':'#f44336')],
      ['Observability Used',`${obsUsed} tool${obsUsed!==1?'s':''}`,obsUsed>=2?'#3ddc84':'#ffb74d'],
      ['Decision Efficiency',`${efficiency}%`,(efficiency>80?'#3ddc84':efficiency>50?'#ffb74d':'#f44336')],
      ['Est. Downtime Impact',`~${downtimeEst}s`,(downtimeEst<20?'#3ddc84':'#ffb74d')],
      ['Root Cause Method','Query analysis → Index fix','#3ddc84'],
    ].map(([l,v,c])=>`
    <div style="background:#030812;padding:8px;border:1px solid #1a3020;">
      <div style="font-family:'Press Start 2P',monospace;font-size:5px;color:var(--dim);margin-bottom:4px;">${l}</div>
      <div style="font-family:'VT323',monospace;font-size:16px;color:${c};">${v}</div>
    </div>`).join('')}
  </div>
  <div style="margin-top:10px;font-family:'VT323',monospace;font-size:12px;color:var(--dim);border-left:2px solid #3ddc84;padding-left:7px;line-height:1.7;">
    Pattern: diagnosis before action. Observability tools first, then targeted fix. This is how Zakhir approaches real production incidents.
  </div>
  <button onclick="startIncident(${INCIDENTS.indexOf(_inc)})" style="margin-top:10px;font-family:'Press Start 2P',monospace;font-size:5px;background:transparent;border:1px solid #ef9a9a;color:#ef9a9a;padding:5px 10px;cursor:pointer;">↩ REPLAY INCIDENT</button>
</div>`;

  renderMetrics();
  tlog(`prob.incident_resolved  duration=${mins}m${secs}s  efficiency=${efficiency}%  wrongs=${wrongActions}`);
}

function escalateIncident(action){
  // Wrong choices spawn a new consequence in the log
  setTimeout(()=>{
    const logEl=document.getElementById('prob-log');
    if(!logEl||_resolved) return;
    logEl.innerHTML+=`<div style="color:#ffb74d;margin-top:2px;">[${Math.round((Date.now()-_startTime)/1000)}s] ⚠ System state worsening — SLO burn accelerating. Re-evaluate.</div>`;
    logEl.scrollTop=logEl.scrollHeight;
    renderMetrics();
  },1500);
}

let _probTimerTick=null;
function startTimerTick(){
  if(_probTimerTick) clearInterval(_probTimerTick);
  _probTimerTick=setInterval(()=>{
    const el=document.getElementById('prob-timer');if(!el||_resolved){clearInterval(_probTimerTick);return;}
    const elapsed=Math.round((Date.now()-_startTime)/1000);
    const mins=Math.floor(elapsed/60),secs=elapsed%60;
    el.textContent=`${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
  },1000);
}

// ═══════════════════════════════════════════════════════════
// SECRET ROOM
// ═══════════════════════════════════════════════════════════
function buildSecret(){return `<div>
<div style="text-align:center;padding:16px 0;">
<div style="font-size:28px;margin-bottom:10px;animation:pulse .8s ease-in-out infinite;">★</div>
<div style="font-family:'Press Start 2P',monospace;font-size:10px;color:#9c27b0;text-shadow:0 0 20px #9c27b0;margin-bottom:12px;letter-spacing:3px;">ACHIEVEMENT UNLOCKED</div>
<div style="font-family:'VT323',monospace;font-size:16px;color:var(--white);margin-bottom:16px;">You explored the whole world.</div>
</div>
<div style="background:#0d0014;border:2px solid #9c27b0;padding:12px;margin-bottom:10px;">
<div style="font-family:'Press Start 2P',monospace;font-size:6px;color:#9c27b0;margin-bottom:9px;letter-spacing:1px;">// THINGS I TRIED AND WHAT I LEARNED</div>
${[
  {e:'🎮',t:'Built a game engine before knowing design patterns',l:'Rewrote it 3 times. First version had no separation between update and render. Lesson: think about architecture before writing the first loop.'},
  {e:'🤖',t:'Tried to use ML for everything in the LoL project',l:'Classification worked, but a simple heuristic would have been faster to build and just as accurate. ML is not always the right tool.'},
  {e:'🗄',t:'Over-normalised a database to 4NF for a simple app',l:'Query performance degraded badly. Over-engineering has a real cost. Fit the schema to the use case, not to a textbook.'},
  {e:'⚡',t:'Ignored async/await in an early TypeScript project',l:'Callback hell within 2 weeks. Proper async patterns are not optional when you have more than one async operation.'},
  {e:'📐',t:'Designed the full system architecture before writing any tests',l:'By the time tests surfaced issues, too much was coupled. Test-first thinking is faster long-term, even if it feels slower to start.'},
].map(e=>`<div style="display:flex;gap:9px;margin-bottom:9px;padding-bottom:9px;border-bottom:1px solid #1a0030;">
<div style="font-size:16px;flex-shrink:0;">${e.e}</div>
<div><div style="font-family:'VT323',monospace;font-size:14px;color:var(--white);margin-bottom:2px;">${e.t}</div>
<div style="font-family:'VT323',monospace;font-size:12px;color:var(--dim);border-left:2px solid #9c27b0;padding-left:5px;">${e.l}</div></div>
</div>`).join('')}
</div>
<div style="font-family:'VT323',monospace;font-size:13px;color:var(--dim);text-align:center;line-height:1.6;">
"The engineers I respect most aren't the ones who've never failed.<br>They're the ones who failed, understood why, and improved."
</div>
</div>`;}

// ═══════════════════════════════════════════════════════════
// TIMELINE
// ═══════════════════════════════════════════════════════════
function buildTimeline(){
  const entries=[
    {year:'2019',col:'#f5c518',dot:'★',title:'Started coding in high school',detail:'First exposure to programming. Logic clicked early. Realised systems thinking came more naturally than expected.',tags:['HIGH SCHOOL','BASICS','FIRST CODE']},
    {year:'2021',col:'#3ddc84',dot:'◈',title:'Enrolled at CPUT — ICT Applications Development',detail:'Committed to software as a career. Java fundamentals, data structures, relational DBs. First real project: clinic management system.',tags:['JAVA','SQL','CPUT','SYSTEMS']},
    {year:'2022',col:'#3ddc84',dot:'◈',title:'NannyAtYourService — complex SQL system',detail:'First serious DB project: stored procedures, sequences, triggers, cursors, views, complex joins. Learned the difference between writing SQL and designing a database.',tags:['SQL','PL/SQL','PROCEDURES','TRIGGERS']},
    {year:'2023',col:'#4fc3f7',dot:'◇',title:'Machine Learning A-Z course completed',detail:'Regression, classification, clustering, NLP, deep learning, XGBoost, dimensionality reduction. Python: scikit-learn, Keras, pandas. Shifted thinking from "code" to "systems that learn".',tags:['PYTHON','ML','SKLEARN','KERAS','DEEP LEARNING']},
    {year:'2024',col:'#ce93d8',dot:'◉',title:'Built custom 2D game engine in TypeScript',detail:'Raw Canvas API — no frameworks. GameEngine class, RAF loop, entity management, AABB collision, particle pool, delta-time physics. Proved architectural thinking, not just coding.',tags:['TYPESCRIPT','CANVAS','ARCHITECTURE','ENGINE']},
    {year:'2024',col:'#ce93d8',dot:'◉',title:'PrintIt101 — full-stack 3D t-shirt platform',detail:'Team project. React + Three.js frontend for real-time 3D rendering. Java Spring Boot backend. Builder + Factory patterns. First professional-grade full-stack system.',tags:['REACT','THREE.JS','SPRING BOOT','DESIGN PATTERNS']},
    {year:'2025',col:'#ffb74d',dot:'▣',title:'LoL Skin Buff/Nerf Viewer',detail:'Scraped and parsed Riot Games patch notes. ML classification to predict buff/nerf impact on win rates. Combined data engineering with ML in a real context.',tags:['PYTHON','SCRAPING','ML','DATA ENGINEERING']},
    {year:'2025',col:'#f44336',dot:'⬡',title:'COGENT — 5-month enterprise WIL',detail:'Four teams: Analyst, Automation, Azure DevOps, APA. C# with ABP Framework. Blue Prism RPA process design. Azure DevOps CI/CD pipelines. Copilot AI automation. First production enterprise environment.',tags:['C#','AZURE DEVOPS','BLUE PRISM','RPA','AI TOOLS']},
    {year:'2025',col:'#f5c518',dot:'★',title:'CPUT Diploma — graduated',detail:'Not just a diploma — a game engine, an ML lab, a 3D platform, five months of enterprise work, and a portfolio that runs in your browser.',tags:['GRADUATED','CPUT','READY']},
  ];
  return `<div>
<p style="font-family:'VT323',monospace;font-size:13px;color:var(--dim);margin-bottom:12px;line-height:1.4;">Click any milestone. This is not a CV — it is the story of how Zakhir became an engineer.</p>
<div class="tl-wrap">
<div class="tl-line"></div>
${entries.map((e,i)=>`
<div class="tl-entry" onclick="toggleTL(${i})">
<div class="tl-dot" style="border-color:${e.col};color:${e.col}">${e.dot}</div>
<div class="tl-year" style="color:${e.col}">${e.year}</div>
<div class="tl-title">${e.title}</div>
<div class="tl-detail" id="tl-${i}" style="border-color:${e.col};">${e.detail}
<div style="margin-top:6px;">${e.tags.map(t=>`<span class="tl-tag" style="border-color:${e.col};color:${e.col}">${t}</span>`).join('')}</div>
</div>
</div>`).join('')}
</div>
</div>`;}

function toggleTL(i){const el=document.getElementById('tl-'+i);if(el)el.classList.toggle('show');}

// ═══════════════════════════════════════════════════════════
// THEME ENGINE — 5 swappable visual styles
// ═══════════════════════════════════════════════════════════
const THEMES={

  classic:{
    name:'CLASSIC',
    label:'Classic\nDark RPG',
    // CSS vars
    bg:'#0d0d1a',yellow:'#f5c518',green:'#3ddc84',blue:'#4fc3f7',
    red:'#f44336',purple:'#ce93d8',orange:'#ffb74d',white:'#e8e0d5',dim:'#5a5068',
    // HUD
    hudBorder:'#f5c518',hudBg:'rgba(10,8,20,0.97)',
    // Scanline
    scanline:'rgba(0,0,0,0.06)',
    // Sky fill
    skyFill:'#0d0d1a',
    // Tile colours
    TC:{0:'#1a2e1a',1:'#162616',2:'#1a1428',3:'#1c1630',4:'#2d1b4e',5:'#3d2000',6:'#1a4a0a',7:'#2a2018'},
    TD:{0:'#1e3320',1:'#1a2a1a'},
    // Grass detail
    grassDot1:'#244020', treeTrunk:'#2a1400',
    treeFoliage:['#1a4a0a','#225a0a','#2a6a10'],
    pathStone:'#1e1810',
    wallHighlight:'rgba(255,255,255,.05)',
    floorDot:'rgba(255,255,255,.03)',
    // Room colours [hub,ml,ge,db,devops,arch,prob,secret]
    rooms:[
      {col:'#4fc3f7',shad:'#003a5a',fc:'#1a1428',fc2:'#1c1630',wc:'#2d1b4e'},
      {col:'#3ddc84',shad:'#0a3a1a',fc:'#0d1a0d',fc2:'#0f1f0f',wc:'#1a3d1a'},
      {col:'#ce93d8',shad:'#3d0a5a',fc:'#140d1a',fc2:'#18101e',wc:'#3d1a5a'},
      {col:'#ffb74d',shad:'#5a2a00',fc:'#1a0d04',fc2:'#1f1005',wc:'#5a2a00'},
      {col:'#f44336',shad:'#5a0000',fc:'#1a0505',fc2:'#1f0808',wc:'#4a1010'},
      {col:'#90caf9',shad:'#0a2a5a',fc:'#080d1a',fc2:'#0a1020',wc:'#1a2a4a'},
      {col:'#ef9a9a',shad:'#5a1a1a',fc:'#1a0808',fc2:'#1f0a0a',wc:'#4a1818'},
      {col:'#9c27b0',shad:'#3a005a',fc:'#0d0014',fc2:'#100018',wc:'#280040'},
    ],
    // Player outfit
    HAIR:'#4a2c0a',SKIN:'#f5cba7',SHIRT:'#1a5f99',PANTS:'#1a1a4a',BOOT:'#3d1f0a',CAPE:'#8b1a1a',
    // BG fx
    bgFx:null,
  },

  forest:{
    name:'FOREST',
    label:'Forest\nTerminal',
    bg:'#060d06',yellow:'#d4a017',green:'#39e75f',blue:'#7fffb0',
    red:'#e05c30',purple:'#a8e6cf',orange:'#d4a017',white:'#d8ebb5',dim:'#3d5c3a',
    hudBorder:'#d4a017',hudBg:'rgba(4,10,4,0.97)',
    scanline:'rgba(0,20,0,0.07)',
    skyFill:'#060d06',
    TC:{0:'#0a1a08',1:'#081406',2:'#0a180a',3:'#0c1a0c',4:'#1a3a14',5:'#2a1200',6:'#0a3008',7:'#1a1206'},
    TD:{0:'#0e2a0c',1:'#0a1e08'},
    grassDot1:'#1a4a10', treeTrunk:'#3d2200',
    treeFoliage:['#0a3a08','#0d4a0a','#39e75f22'],
    pathStone:'#1a1408',
    wallHighlight:'rgba(100,255,100,.04)',
    floorDot:'rgba(57,231,95,.04)',
    rooms:[
      {col:'#7fffb0',shad:'#004a20',fc:'#060f06',fc2:'#080f08',wc:'#0a2a10'},
      {col:'#39e75f',shad:'#003a10',fc:'#060f06',fc2:'#081208',wc:'#0a2010'},
      {col:'#a8e6cf',shad:'#1a3a28',fc:'#07100a',fc2:'#08120a',wc:'#142a18'},
      {col:'#d4a017',shad:'#3a2a00',fc:'#100c00',fc2:'#140e00',wc:'#2a1e00'},
      {col:'#e05c30',shad:'#3a1000',fc:'#100600',fc2:'#140800',wc:'#281400'},
      {col:'#b8f2a0',shad:'#1a3a10',fc:'#070f06',fc2:'#081206',wc:'#122010'},
      {col:'#ffe066',shad:'#3a3000',fc:'#100e00',fc2:'#141000',wc:'#2a2400'},
      {col:'#39e75f',shad:'#003820',fc:'#050d05',fc2:'#070f07',wc:'#0a2010'},
    ],
    HAIR:'#2a1800',SKIN:'#c8a878',SHIRT:'#1a4a18',PANTS:'#1a2a14',BOOT:'#2a1800',CAPE:'#3a5a20',
    bgFx:'forest',
  },

  synthwave:{
    name:'SYNTHWAVE',
    label:'Synthwave\nNeon Grid',
    bg:'#080010',yellow:'#ffe600',green:'#00ffe7',blue:'#ff2df7',
    red:'#ff2d55',purple:'#bf5fff',orange:'#ff9f0a',white:'#f0e6ff',dim:'#5a3a6a',
    hudBorder:'#ff2df7',hudBg:'rgba(8,0,16,0.97)',
    scanline:'rgba(255,0,255,0.04)',
    skyFill:'#080010',
    TC:{0:'#0a0014',1:'#08000f',2:'#0d0020',3:'#0f0025',4:'#2a0040',5:'#1a0030',6:'#0a0020',7:'#1a0030'},
    TD:{0:'#12002a',1:'#0e0020'},
    grassDot1:'#3a0060', treeTrunk:'#2a0050',
    treeFoliage:['#1a0040','#ff2df720','#bf5fff18'],
    pathStone:'#200040',
    wallHighlight:'rgba(255,45,247,.08)',
    floorDot:'rgba(0,255,231,.05)',
    rooms:[
      {col:'#ff2df7',shad:'#5a005a',fc:'#0d0020',fc2:'#100025',wc:'#2a0045'},
      {col:'#00ffe7',shad:'#005040',fc:'#001a18',fc2:'#001e1c',wc:'#003030'},
      {col:'#bf5fff',shad:'#3a0060',fc:'#100018',fc2:'#12001c',wc:'#200030'},
      {col:'#ffe600',shad:'#3a3000',fc:'#100e00',fc2:'#141000',wc:'#2a2400'},
      {col:'#ff2d55',shad:'#3a0010',fc:'#100008',fc2:'#14000a',wc:'#280014'},
      {col:'#7df9ff',shad:'#005060',fc:'#001618',fc2:'#001a1c',wc:'#002830'},
      {col:'#ff9f0a',shad:'#3a1e00',fc:'#100700',fc2:'#140800',wc:'#281400'},
      {col:'#bf5fff',shad:'#380060',fc:'#0a0018',fc2:'#0c001c',wc:'#180030'},
    ],
    HAIR:'#2a0050',SKIN:'#f0c8ff',SHIRT:'#ff2df7',PANTS:'#0a0030',BOOT:'#1a0040',CAPE:'#00ffe7',
    bgFx:'synthwave',
  },

  cyberpunk:{
    name:'CYBERPUNK',
    label:'Cyberpunk\nGold',
    bg:'#0a0a0a',yellow:'#ffd700',green:'#39ff14',blue:'#00bfff',
    red:'#ff4500',purple:'#da70d6',orange:'#ff8c00',white:'#e8e8e8',dim:'#555555',
    hudBorder:'#ffd700',hudBg:'rgba(8,8,8,0.97)',
    scanline:'rgba(255,215,0,0.03)',
    skyFill:'#0a0a0a',
    TC:{0:'#111111',1:'#0d0d0d',2:'#141414',3:'#161616',4:'#2a2a2a',5:'#1a1000',6:'#111111',7:'#1a1a00'},
    TD:{0:'#1a1a10',1:'#161608'},
    grassDot1:'#2a2a14', treeTrunk:'#1a1000',
    treeFoliage:['#1a1a08','#222210','#ffd70010'],
    pathStone:'#1a1a08',
    wallHighlight:'rgba(255,215,0,.07)',
    floorDot:'rgba(255,215,0,.04)',
    rooms:[
      {col:'#ffd700',shad:'#3a3000',fc:'#111100',fc2:'#131300',wc:'#2a2500'},
      {col:'#39ff14',shad:'#003a00',fc:'#001100',fc2:'#001300',wc:'#002000'},
      {col:'#da70d6',shad:'#3a003a',fc:'#110011',fc2:'#130013',wc:'#220022'},
      {col:'#ff8c00',shad:'#3a2000',fc:'#110800',fc2:'#130a00',wc:'#221400'},
      {col:'#ff4500',shad:'#3a1000',fc:'#110400',fc2:'#130500',wc:'#220c00'},
      {col:'#00bfff',shad:'#00283a',fc:'#000d11',fc2:'#000f13',wc:'#001a22'},
      {col:'#ffd700',shad:'#3a3000',fc:'#111100',fc2:'#131300',wc:'#252500'},
      {col:'#da70d6',shad:'#380038',fc:'#0f000f',fc2:'#110011',wc:'#1e001e'},
    ],
    HAIR:'#1a1a1a',SKIN:'#e0c090',SHIRT:'#ffd700',PANTS:'#1a1a1a',BOOT:'#2a2a2a',CAPE:'#ff4500',
    bgFx:'cyberpunk',
  },

  deepspace:{
    name:'DEEP SPACE',
    label:'Deep\nSpace',
    bg:'#00010d',yellow:'#c8b8ff',green:'#4fc3f7',blue:'#b388ff',
    red:'#f48fb1',purple:'#ea80fc',orange:'#80d8ff',white:'#e8eaf6',dim:'#3a3a5a',
    hudBorder:'#b388ff',hudBg:'rgba(0,1,13,0.97)',
    scanline:'rgba(100,80,255,0.04)',
    skyFill:'#00010d',
    TC:{0:'#02020f',1:'#01010c',2:'#04040f',3:'#05051a',4:'#10104a',5:'#02020f',6:'#04041a',7:'#060618'},
    TD:{0:'#08082a',1:'#05051e'},
    grassDot1:'#14144a', treeTrunk:'#08082a',
    treeFoliage:['#06061a','#b388ff15','#4fc3f712'],
    pathStone:'#0a0a30',
    wallHighlight:'rgba(180,136,255,.07)',
    floorDot:'rgba(79,195,247,.05)',
    rooms:[
      {col:'#4fc3f7',shad:'#001830',fc:'#030318',fc2:'#04041c',wc:'#0a0a40'},
      {col:'#80d8ff',shad:'#002040',fc:'#030320',fc2:'#040424',wc:'#0a0a4a'},
      {col:'#ea80fc',shad:'#2a0040',fc:'#0f0020',fc2:'#120025',wc:'#200040'},
      {col:'#c8b8ff',shad:'#1a1060',fc:'#080820',fc2:'#0a0a28',wc:'#141460'},
      {col:'#f48fb1',shad:'#300020',fc:'#100010',fc2:'#140014',wc:'#280028'},
      {col:'#b388ff',shad:'#180048',fc:'#060020',fc2:'#080024',wc:'#100040'},
      {col:'#80cbc4',shad:'#003038',fc:'#030c10',fc2:'#040e12',wc:'#081c22'},
      {col:'#ea80fc',shad:'#280040',fc:'#0a0020',fc2:'#0c0024',wc:'#180040'},
    ],
    HAIR:'#1a1a3a',SKIN:'#c8c0e8',SHIRT:'#b388ff',PANTS:'#0a0a30',BOOT:'#1a1a4a',CAPE:'#4fc3f7',
    bgFx:'deepspace',
  },
};

// ── Active theme state ──
let activeTheme='classic';

// ── Apply a theme to the live world ──
function applyTheme(id){
  const th=THEMES[id];
  if(!th) return;
  activeTheme=id;
  try{localStorage.setItem('zkm_theme',id);}catch(e){}

  // 1. CSS vars on :root
  const root=document.documentElement;
  root.style.setProperty('--bg',   th.bg);
  root.style.setProperty('--yellow',th.yellow);
  root.style.setProperty('--green', th.green);
  root.style.setProperty('--blue',  th.blue);
  root.style.setProperty('--red',   th.red);
  root.style.setProperty('--purple',th.purple);
  root.style.setProperty('--orange',th.orange);
  root.style.setProperty('--white', th.white);
  root.style.setProperty('--dim',   th.dim);
  document.body.style.background=th.bg;

  // 2. HUD border
  const hud=document.getElementById('hud');
  if(hud){hud.style.borderBottomColor=th.hudBorder;hud.style.background=th.hudBg;}

  // 3. Room colours — patch the rooms array in place
  th.rooms.forEach((rc,i)=>{
    if(rooms[i]){
      rooms[i].col=rc.col; rooms[i].shad=rc.shad;
      rooms[i].fc=rc.fc;   rooms[i].fc2=rc.fc2; rooms[i].wc=rc.wc;
    }
  });

  // 4. Tile colour tables — patch TC/TD in place
  Object.assign(TC, th.TC);
  Object.assign(TD, th.TD);

  // 5. Player colours stored on window for drawPlayer to read
  window._themePlayer={
    HAIR:th.HAIR,SKIN:th.SKIN,SHIRT:th.SHIRT,
    PANTS:th.PANTS,BOOT:th.BOOT,CAPE:th.CAPE
  };

  // 6. Store theme details for drawTile to read
  window._themeGfx={
    grassDot1:th.grassDot1,
    treeTrunk:th.treeTrunk,
    treeFoliage:th.treeFoliage,
    pathStone:th.pathStone,
    wallHighlight:th.wallHighlight,
    floorDot:th.floorDot,
    skyFill:th.skyFill,
    bgFx:th.bgFx,
  };

  // 7. Update swatch active state
  document.querySelectorAll('.th-swatch').forEach(el=>{
    el.classList.toggle('active', el.dataset.theme===id);
    el.style.borderColor = el.dataset.theme===id ? th.white : 'transparent';
  });

  minimapDirty=true;
}

// ── Background effects per theme ──
const _stars=Array.from({length:180},()=>({
  x:Math.random()*3840,y:Math.random()*2160,
  r:Math.random(),bright:Math.random(),speed:Math.random()*.3+.1
}));
let _gridOff=0;

function drawBgFx(fx){
  if(!fx) return;
  if(fx==='deepspace'){
    // Parallax star field
    ctx.save();
    _stars.forEach(s=>{
      const sx=(s.x-cam.x*s.speed)%W;
      const sy=(s.y-cam.y*s.speed)%H;
      const twinkle=.4+.6*Math.sin(tick*.03+s.bright*10);
      ctx.fillStyle=`rgba(200,180,255,${twinkle*s.r*0.9})`;
      ctx.fillRect((sx+W)%W,(sy+H)%H,s.r<.3?1:s.r<.7?2:1,s.r<.3?1:s.r<.7?2:1);
    });
    // Occasional nebula wisps (very subtle)
    ctx.globalAlpha=.03;
    const nx=(tick*0.2)%W,ny=(tick*0.1)%H;
    const nebGrad=ctx.createRadialGradient(nx,ny,0,nx,ny,200);
    nebGrad.addColorStop(0,'#b388ff');nebGrad.addColorStop(1,'transparent');
    ctx.fillStyle=nebGrad;ctx.fillRect(0,0,W,H);
    ctx.globalAlpha=1;
    ctx.restore();
  } else if(fx==='synthwave'){
    // Neon horizon grid (perspective)
    ctx.save();
    ctx.globalAlpha=.18;
    const horizon=H*0.52;
    const gridCol='#ff2df7';
    // Horizontal lines receding to horizon
    for(let i=0;i<12;i++){
      const t=i/11;
      const y=horizon+(H-horizon)*Math.pow(t,1.6);
      const alpha=.05+t*.4;
      ctx.strokeStyle=gridCol;ctx.globalAlpha=alpha*.3;
      ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();
    }
    // Vertical lines with scroll
    const vOff=(_gridOff+=.4);
    const vCount=24;
    for(let i=0;i<=vCount;i++){
      const t=i/vCount;
      const xTop=W/2+(t-.5)*W*.3;
      const xBot=W/2+(t-.5)*W*2.4;
      ctx.globalAlpha=.12;
      ctx.strokeStyle='#00ffe7';ctx.lineWidth=.8;
      ctx.beginPath();ctx.moveTo(xTop,horizon);ctx.lineTo(xBot,H+20);ctx.stroke();
    }
    ctx.globalAlpha=1;
    ctx.restore();
  } else if(fx==='forest'){
    // Subtle ambient bioluminescent particles (random positions, slow float up)
    ctx.save();
    const t2=tick*.015;
    for(let i=0;i<12;i++){
      const bx=((Math.sin(t2+i*2.3)*0.5+0.5)*W*1.2-cam.x*.02+i*180)%W;
      const by=((Math.cos(t2+i*1.7)*0.5+0.5)*H*1.2-cam.y*.02+i*120)%H;
      const alpha=.12+.1*Math.sin(tick*.04+i);
      ctx.globalAlpha=alpha;
      ctx.fillStyle=['#39e75f','#7fffb0','#d4a017'][i%3];
      ctx.beginPath();ctx.arc(bx,by,1.5,0,Math.PI*2);ctx.fill();
    }
    ctx.globalAlpha=1;
    ctx.restore();
  } else if(fx==='cyberpunk'){
    // Occasional scan-line flicker
    if(tick%240<3){
      ctx.save();ctx.globalAlpha=.06;
      ctx.fillStyle='#ffd700';
      ctx.fillRect(0,Math.random()*H,W,2);
      ctx.globalAlpha=1;ctx.restore();
    }
    // Gold circuit trace particles along paths
    // (subtle — just thin horizontal lines that slide)
    ctx.save();ctx.globalAlpha=.04;
    ctx.strokeStyle='#ffd700';ctx.lineWidth=1;
    const coff=(tick*0.8)%W;
    ctx.beginPath();ctx.moveTo(coff,H*.3);ctx.lineTo(coff+60,H*.3);ctx.stroke();
    ctx.beginPath();ctx.moveTo((coff+W*.4)%W,H*.7);ctx.lineTo(((coff+W*.4)%W)+40,H*.7);ctx.stroke();
    ctx.globalAlpha=1;ctx.restore();
  }
}

// ── Patch render() to inject bgFx and theme sky ──
const _renderOrig=render;
function render(){
  const sky=window._themeGfx?.skyFill||'#0d0d1a';
  ctx.fillStyle=sky;ctx.fillRect(0,0,W,H);
  if(window._themeGfx?.bgFx) drawBgFx(window._themeGfx.bgFx);
  const stx=Math.max(0,Math.floor(cam.x/TILE)),etx=Math.min(WTX,Math.ceil((cam.x+W)/TILE)+1);
  const sty=Math.max(0,Math.floor(cam.y/TILE)),ety=Math.min(WTY,Math.ceil((cam.y+H)/TILE)+1);
  for(let ty=sty;ty<ety;ty++) for(let tx=stx;tx<etx;tx++) drawTile(tx,ty);
  drawRoomLabels();drawStations();drawNPCs();drawPlayer();drawMinimap();
}

// ── Patch drawTile to use theme gfx ──
const _drawTileOrig=drawTile;
function drawTile(tx,ty){
  const t=tm[ty][tx];
  const sx=tx*TILE-cam.x,sy=ty*TILE-cam.y;
  if(sx<-TILE||sx>W+TILE||sy<-TILE||sy>H+TILE) return;
  let col=TC[t]||'#1a1a2e';
  if(t===T.FLOOR||t===T.FLOOR2||t===T.WALL){
    for(const r of rooms){
      if(tx>=r.tx&&tx<r.tx+r.tw&&ty>=r.ty&&ty<r.ty+r.th){
        col=t===T.WALL?r.wc:t===T.FLOOR?r.fc:r.fc2;break;
      }
    }
  }
  ctx.fillStyle=col;ctx.fillRect(sx,sy,TILE,TILE);
  const gfx=window._themeGfx||{};
  if(t===T.GRASS||t===T.GRASS2){
    ctx.fillStyle=TD[t]||'#1a2a1a';
    if((tx+ty)%3===0) ctx.fillRect(sx+4,sy+6,2,2);
    if((tx*2+ty)%5===0) ctx.fillRect(sx+20,sy+16,2,2);
    if((tx+ty*3)%7===0){ctx.fillStyle=gfx.grassDot1||'#244020';ctx.fillRect(sx+12,sy+10,1,4);}
  } else if(t===T.WALL){
    ctx.fillStyle='rgba(0,0,0,.28)';
    const brk=(ty%2===0)?0:TILE/2;
    for(let bx=-brk;bx<TILE;bx+=TILE/2) ctx.fillRect(sx+bx,sy,1,TILE);
    ctx.fillRect(sx,sy+TILE/2,TILE,1);
    ctx.fillStyle=gfx.wallHighlight||'rgba(255,255,255,.05)';ctx.fillRect(sx,sy,TILE,2);
  } else if(t===T.FLOOR||t===T.FLOOR2){
    ctx.fillStyle='rgba(0,0,0,.18)';
    ctx.fillRect(sx,sy,1,TILE);ctx.fillRect(sx,sy,TILE,1);
    if((tx+ty)%4===0){ctx.fillStyle=gfx.floorDot||'rgba(255,255,255,.03)';ctx.fillRect(sx+TILE/2-1,sy+TILE/2-1,2,2);}
  } else if(t===T.PATH){
    ctx.fillStyle=gfx.pathStone||'#1e1810';
    if((tx+ty)%2===0) ctx.fillRect(sx+6,sy+6,4,4);
    else ctx.fillRect(sx+22,sy+20,4,4);
  } else if(t===T.TREE){
    ctx.fillStyle=gfx.treeTrunk||'#2a1400';ctx.fillRect(sx+13,sy+10,6,22);
  } else if(t===T.TREE2){
    const tf=gfx.treeFoliage||['#1a4a0a','#225a0a','#2a6a10'];
    ctx.fillStyle=tf[0];ctx.fillRect(sx+5,sy+5,22,24);
    ctx.fillStyle=tf[1];ctx.fillRect(sx+9,sy+1,14,26);
    ctx.fillStyle=tf[2];ctx.fillRect(sx+11,sy+3,10,8);
  }
}

// ── Patch drawPlayer to use theme colours ──
const _drawPlayerOrig=drawPlayer;
function drawPlayer(){
  const sx=Math.round(PL.px-cam.x-16),sy=Math.round(PL.py-cam.y-16);
  const S=2;
  ctx.save();ctx.translate(sx,sy);
  ctx.fillStyle='rgba(0,0,0,.3)';
  ctx.beginPath();ctx.ellipse(16*S,15*S,6*S,2*S,0,0,Math.PI*2);ctx.fill();
  const bob=PL.moving?Math.sin(tick*.25)*S:0;
  const arm=PL.moving?Math.sin(tick*.25)*2*S:0;
  const p=window._themePlayer||{};
  const HAIR=p.HAIR||'#4a2c0a',SKIN=p.SKIN||'#f5cba7',SHIRT=p.SHIRT||'#1a5f99';
  const PANTS=p.PANTS||'#1a1a4a',BOOT=p.BOOT||'#3d1f0a',CAPE=p.CAPE||'#8b1a1a';
  if(PL.dir===0||PL.dir===1){
    ctx.fillStyle=BOOT;ctx.fillRect(5*S,(13+bob)*S,3*S,2*S);ctx.fillRect(8*S,(13-bob)*S,3*S,2*S);
    ctx.fillStyle=PANTS;ctx.fillRect(5*S,10*S,3*S,3*S);ctx.fillRect(8*S,10*S,3*S,3*S);ctx.fillRect(5*S,9*S,6*S,2*S);
    ctx.fillStyle=CAPE;ctx.fillRect(4*S,6*S,8*S,4*S);
    ctx.fillStyle=SHIRT;ctx.fillRect(2*S,(7+arm)*S,2*S,3*S);ctx.fillRect(12*S,(7-arm)*S,2*S,3*S);
    ctx.fillStyle=SKIN;ctx.fillRect(5*S,2*S,6*S,5*S);
    ctx.fillStyle=HAIR;ctx.fillRect(5*S,2*S,6*S,2*S);ctx.fillRect(4*S,3*S,2*S,4*S);ctx.fillRect(10*S,3*S,2*S,4*S);
    if(PL.dir===0){ctx.fillStyle='#1a0a06';ctx.fillRect(6*S,5*S,1*S,1*S);ctx.fillRect(9*S,5*S,1*S,1*S);}
    else{ctx.fillStyle=HAIR;ctx.fillRect(5*S,2*S,6*S,5*S);}
  } else {
    const flip=PL.dir===2;
    ctx.save();if(flip){ctx.scale(-1,1);ctx.translate(-16*S*2,0);}
    ctx.fillStyle=BOOT;ctx.fillRect(5*S,(13+bob)*S,3*S,2*S);ctx.fillRect(9*S,(13-bob)*S,3*S,2*S);
    ctx.fillStyle=PANTS;ctx.fillRect(5*S,10*S,3*S,3*S);ctx.fillRect(9*S,10*S,3*S,3*S);
    ctx.fillStyle=CAPE;ctx.fillRect(4*S,6*S,8*S,5*S);
    ctx.fillStyle=SHIRT;ctx.fillRect(3*S,(7+arm)*S,2*S,3*S);
    ctx.fillStyle=SKIN;ctx.fillRect(5*S,1*S,7*S,6*S);
    ctx.fillStyle=HAIR;ctx.fillRect(5*S,1*S,7*S,2*S);ctx.fillRect(5*S,1*S,2*S,5*S);
    ctx.fillStyle='#1a0a06';ctx.fillRect(11*S,4*S,1*S,1*S);
    ctx.restore();
  }
  ctx.restore();
}

// ── Build intro swatch previews ──
function buildThemeSwatches(){
  const wrap=document.getElementById('theme-swatches');
  if(!wrap) return;
  Object.entries(THEMES).forEach(([id,th])=>{
    const outer=document.createElement('div');
    outer.className='th-swatch'+(id===activeTheme?' active':'');
    outer.dataset.theme=id;
    outer.title=th.name;
    outer.style.borderColor=id===activeTheme?th.white:'transparent';
    outer.onclick=()=>applyTheme(id);
    // Mini canvas preview — 54×54, shows a tiny world slice
    const cv=document.createElement('canvas');
    cv.width=27;cv.height=27;
    const c=cv.getContext('2d');
    // Sky
    c.fillStyle=th.bg;c.fillRect(0,0,27,27);
    // Ground (lower half)
    c.fillStyle=th.TC[0]||'#1a2e1a';c.fillRect(0,14,27,13);
    // Path strip
    c.fillStyle=th.TC[7]||'#2a2018';c.fillRect(10,0,7,27);
    // Room block
    c.fillStyle=th.rooms[0]?.fc||'#1a1428';c.fillRect(2,2,10,10);
    c.strokeStyle=th.rooms[0]?.col||'#4fc3f7';c.lineWidth=1;c.strokeRect(2,2,10,10);
    // Accent dot (station glow)
    c.fillStyle=th.rooms[0]?.col||'#4fc3f7';c.fillRect(6,6,3,3);
    // Tiny tree
    c.fillStyle=th.treeFoliage?.[0]||'#1a4a0a';c.fillRect(19,3,6,8);
    c.fillStyle=th.treeTrunk||'#2a1400';c.fillRect(21,11,2,6);
    // Player dot
    c.fillStyle=th.SHIRT||'#1a5f99';c.fillRect(12,18,3,5);
    c.fillStyle=th.SKIN||'#f5cba7';c.fillRect(12,15,3,3);
    outer.appendChild(cv);
    const label=document.createElement('div');
    label.className='th-swatch-label';
    label.style.color=th.yellow;
    label.textContent=th.label;
    outer.appendChild(label);
    wrap.appendChild(outer);
  });
}

// ── Load saved theme ──
function loadSavedTheme(){
  let saved='classic';
  try{saved=localStorage.getItem('zkm_theme')||'classic';}catch(e){}
  if(THEMES[saved]) applyTheme(saved);
  else applyTheme('classic');
}

function drawIntroSprite(){
  const ic=document.getElementById('isp');if(!ic)return;
  const c=ic.getContext('2d');c.clearRect(0,0,64,64);
  const pal={0:'transparent',1:'#0a0206',2:'#f5cba7',3:'#4a2c0a',4:'#1a5f99',5:'#1a1a4a',6:'#8b1a1a',7:'#3d1f0a'};
  const g=[[0,0,0,1,1,1,1,1,1,1,0,0],[0,0,1,2,2,2,2,2,2,2,1,0],[0,1,2,3,2,2,2,2,3,2,2,1],[0,1,2,2,2,2,2,2,2,2,2,1],[0,1,2,2,1,2,2,1,2,2,2,1],[0,0,1,2,2,2,2,2,2,2,1,0],[0,1,6,6,6,6,6,6,6,6,6,1],[1,6,6,4,4,4,4,4,4,4,6,1],[1,6,4,4,4,4,4,4,4,4,4,1],[0,1,4,4,4,4,4,4,4,4,1,0],[0,1,5,5,1,5,5,1,5,5,1,0],[0,0,7,7,1,7,7,1,7,7,0,0]];
  const ps=4;
  g.forEach((row,y)=>row.forEach((v,x)=>{if(v>0){c.fillStyle=pal[v];c.fillRect(x*ps+8,y*ps+4,ps,ps);}}));
}

// ═══════════════════════════════════════════════════════════
// ENTRY
// ═══════════════════════════════════════════════════════════
function startWorld(){
  const intro=document.getElementById('intro');
  intro.classList.add('out');
  setTimeout(()=>{
    intro.style.display='none';
    running=true;
    tlog('world.started  version=3.0  zones=8');
    tlog('player.spawned  zone=TOWN_SQUARE');
    updateModeToggleLabel();
  },400);
}

// ═══════════════════════════════════════════════════════════
// HOW TO PLAY OVERLAY
// ═══════════════════════════════════════════════════════════
let htpDismissed=false;
function dismissHTP(){
  if(htpDismissed) return;
  htpDismissed=true;
  const el=document.getElementById('htp');
  if(el){el.classList.add('out');setTimeout(()=>el.style.display='none',700);}
  // Start the "START HERE" arrow after HTP fades
  setTimeout(showStartArrow,800);
}

// Dismiss on any keypress or mouse click on the overlay itself
document.getElementById('htp').addEventListener('click',dismissHTP);
window.addEventListener('keydown',e=>{
  if(!htpDismissed&&!['tab','shift','control','alt','meta'].includes(e.key.toLowerCase())){
    dismissHTP();
  }
},{once:false,capture:true});

// Also dismiss on first player movement (hook into update cycle via a flag)
const _origUpdate=window._origUpdate||null;
let _htpMoveDismiss=false;

// ═══════════════════════════════════════════════════════════
// START-HERE ARROW — points to Oracle pedestal
// ═══════════════════════════════════════════════════════════
let _arrowTimer=null;
function showStartArrow(){
  const el=document.getElementById('start-arrow');
  if(!el) return;
  el.classList.add('show');
  positionStartArrow();
  _arrowTimer=setInterval(positionStartArrow, 100);
  // Fade out after 5 seconds
  setTimeout(()=>{
    el.classList.add('fade');
    clearInterval(_arrowTimer);
    setTimeout(()=>el.classList.remove('show'),900);
  },5000);
}

function positionStartArrow(){
  const el=document.getElementById('start-arrow');
  if(!el||!el.classList.contains('show')) return;
  // Oracle pedestal is at tx:39,ty:27 in world space
  const pedestalWX=39*TILE+TILE/2;
  const pedestalWY=27*TILE;
  const sx=pedestalWX-cam.x;
  const sy=pedestalWY-cam.y;
  // Only show if pedestal is on screen
  if(sx<0||sx>W||sy<0||sy>H){el.style.display='none';return;}
  el.style.display='block';
  el.style.left=(sx-60)+'px';
  el.style.top=Math.max(50,sy-60)+'px';
}

// Dismiss arrow on first movement
function checkArrowDismiss(){
  if(PL.moving&&_arrowTimer){
    clearInterval(_arrowTimer);
    _arrowTimer=null;
    const el=document.getElementById('start-arrow');
    if(el){el.classList.add('fade');setTimeout(()=>el.classList.remove('show'),900);}
  }
}

// ═══════════════════════════════════════════════════════════
// ACHIEVEMENT SYSTEM
// ═══════════════════════════════════════════════════════════
const ACHIEVEMENTS={
  'ML LAB':        {id:'ml',      icon:'🤖', title:'ML CERTIFIED',      desc:'Entered the ML Laboratory'},
  'ENGINE ARENA':  {id:'ge',      icon:'🎮', title:'ENGINE ARCHITECT',  desc:'Entered the Engine Arena'},
  'DB VAULT':      {id:'db',      icon:'🗄', title:'QUERY MASTER',      desc:'Entered the DB Vault'},
  'DEVOPS CONTROL':{id:'devops',  icon:'🖥', title:'PIPELINE ENGINEER', desc:'Entered DevOps Control'},
  'ARCH MUSEUM':   {id:'arch',    icon:'🏛', title:'SYSTEMS THINKER',   desc:'Entered the Architecture Museum'},
  'PROBLEM ARENA': {id:'prob',    icon:'⚔', title:'INCIDENT RESPONDER',desc:'Entered the Problem Arena'},
  '???':           {id:'secret',  icon:'👁', title:'HIDDEN TERMINAL',   desc:'Found the Secret Room'},
};
const earnedAchievements=new Set();
const ALL_ZONES=['ML LAB','ENGINE ARENA','DB VAULT','DEVOPS CONTROL','ARCH MUSEUM','PROBLEM ARENA','???'];
let _fullExplorerUnlocked=false;

function checkAchievement(zoneName){
  if(!ACHIEVEMENTS[zoneName]) return;
  if(earnedAchievements.has(zoneName)) return;
  earnedAchievements.add(zoneName);
  showAchievement(ACHIEVEMENTS[zoneName]);
  // Check full explorer
  const allVisited=ALL_ZONES.every(z=>earnedAchievements.has(z));
  if(allVisited&&!_fullExplorerUnlocked){
    _fullExplorerUnlocked=true;
    setTimeout(()=>showAchievement({icon:'★',title:'WORLD EXPLORER',desc:'All 7 zones discovered! Check the Secret Room.'}),1800);
    // Upgrade secret room NPC dialogue
    const s=stations.find(s=>s.id==='secret');
    if(s) s.dlg='👁 HIDDEN TERMINAL\n"You found everything.\nThe code is: ZKM-2025-EXP\nShare it: I explored @ZakhirMcK\'s RPG portfolio"';
  }
}

function showAchievement(ach){
  const wrap=document.getElementById('ach-wrap');
  if(!wrap) return;
  const el=document.createElement('div');
  el.className='ach-toast';
  el.setAttribute('role','status');
  el.innerHTML=`<div class="ach-icon">${ach.icon}</div>
<div class="ach-text">
  <span class="ach-title">ACHIEVEMENT UNLOCKED</span>
  ${ach.title}<br><span style="color:var(--dim);font-size:5px;">${ach.desc}</span>
</div>`;
  wrap.appendChild(el);
  tlog(`achievement.unlocked  id=${ach.title.replace(/ /g,'_')}`,'warn');
  setTimeout(()=>{
    el.classList.add('out');
    setTimeout(()=>wrap.removeChild(el),500);
  },4000);
}

// Hook into zone change to fire achievements
const _origZoneCheck=()=>{};
// Patch: re-check in the update loop. We intercept lastZone changes.
let _prevZoneForAch='';
function checkZoneAchievement(){
  if(lastZone!==_prevZoneForAch){
    _prevZoneForAch=lastZone;
    checkAchievement(lastZone);
  }
}

// ═══════════════════════════════════════════════════════════
// MODAL ACCESSIBILITY — focus trap + close on outside click
// ═══════════════════════════════════════════════════════════
const modal=document.getElementById('modal');

// Close on outside click (clicking the dark backdrop)
modal.addEventListener('click',e=>{
  if(e.target===modal) closeModal();
});

// Focus trap inside modal
modal.addEventListener('keydown',e=>{
  if(e.key==='Tab'){
    const focusable=modal.querySelectorAll('button,input,textarea,[tabindex]:not([tabindex="-1"])');
    const first=focusable[0];
    const last=focusable[focusable.length-1];
    if(e.shiftKey){if(document.activeElement===first){e.preventDefault();last?.focus();}}
    else{if(document.activeElement===last){e.preventDefault();first?.focus();}}
  }
});

// Modal gets auto-focus on open — handled inside openModal() directly

// ═══════════════════════════════════════════════════════════
// MOBILE DEFAULT — show Normal Mode on small screens
// ═══════════════════════════════════════════════════════════
function checkMobileDefault(){
  if(window.innerWidth<900&&isGameMode){
    // Switch to normal mode without animation on mobile
    const nm=document.getElementById('normal-mode');
    const mm=document.getElementById('minimap-wrap');
    const tl=document.getElementById('telelog');
    const btn=document.getElementById('mode-toggle');
    nm.classList.add('active');
    if(mm) mm.style.display='none';
    if(tl) tl.style.display='none';
    running=false;
    isGameMode=false;
    if(btn) btn.textContent='⬡ RPG MODE';
    // Hide HTP overlay on mobile
    dismissHTP();
    // Hide intro if still showing
    const intro=document.getElementById('intro');
    if(intro) intro.style.display='none';
  }
}

// Update mode toggle label based on screen size
function updateModeToggleLabel(){
  const btn=document.getElementById('mode-toggle');
  if(!btn) return;
  if(window.innerWidth<900){
    btn.textContent=isGameMode?'⬡ MOBILE CV':'⬡ RPG MODE';
  } else {
    btn.textContent=isGameMode?'⬡ NORMAL MODE':'⬡ GAME MODE';
  }
}
window.addEventListener('resize',updateModeToggleLabel);
const _checkAchEvery=30;
let _achFrame=0;

// ═══════════════════════════════════════════════════════════
// UNIFIED MAIN LOOP + STARTUP
// ═══════════════════════════════════════════════════════════
function loop(){
  update();
  render();
  // Zone achievement check (throttled)
  _achFrame++;
  if(_achFrame>=_checkAchEvery){_achFrame=0;checkZoneAchievement();}
  // HTP dismiss on first movement
  if(!htpDismissed&&PL.moving) dismissHTP();
  // Start-here arrow dismiss on movement
  if(_arrowTimer) checkArrowDismiss();
  requestAnimationFrame(loop);
}

// ── Startup ──
drawIntroSprite();
buildThemeSwatches();
loadSavedTheme();
checkMobileDefault();
updateModeToggleLabel();
requestAnimationFrame(loop);
</script>
</body>
</html>